{% extends "base.html" %}
{% load static %}

{% block title %}Welcome{% endblock %}

{% block links %}
  <link rel="stylesheet" href="{% static 'css/mystyle.css' %}">
  <script>
    document.documentElement.classList.add("verify-page");
    // Hide mobile header immediately before page renders
    (function() {
      var style = document.createElement('style');
      style.textContent = '.mobile-header { display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; }';
      document.head.appendChild(style);
    })();
  </script>
  <style>
    /* Aggressive hiding of mobile header */
    .mobile-header,
    body .mobile-header,
    html .mobile-header,
    .main-content .mobile-header {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
      width: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    html.verify-page .mobile-header,
    html.verify-page body .mobile-header,
    html.verify-page .main-content .mobile-header {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
      width: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    html.verify-page .mobile-header-left,
    html.verify-page .mobile-header-right,
    html.verify-page .mobile-menu-toggle,
    html.verify-page .mobile-brand,
    html.verify-page .mobile-brand-text-container,
    html.verify-page .mobile-brand-text {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Adjust layout for verify page without sidebar */
    .main-content {
      margin-left: 0 !important;
      width: 100% !important;
      display: block;
    }
    #content {
      padding: 0 !important;
      width: 100%;
    }

    html.verify-page .mobile-header,
    html.verify-page #mobile-nav,
    html.verify-page #mobile-nav-overlay {
      display: none !important;
    }

    .resend-link {
      background: none;
      border: none;
      color: #0d6efd;
      text-decoration: underline;
      padding: 0;
      font-size: 0.95rem;
    }

    .resend-link:disabled {
      color: #6c757d;
      text-decoration: none;
      cursor: not-allowed;
    }

    .code-input {
      border: none;
      border-bottom: 2px solid #ff8c00;
      border-radius: 0;
      text-align: center;
      font-size: 1.5rem;
      letter-spacing: 0.4rem;
      padding: 0.5rem 0;
      max-width: 220px;
      margin: 0 auto;
      outline: none;
      box-shadow: none;
    }

    .code-input:focus {
      border-bottom-color: #e67700;
      box-shadow: none;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-5 rounded">
  <div class="card col-md-6 offset-md-3 border rounded shadow-lg mb-5 bg-body">
    <div class="text-center card-body bg-warning mb-3" style="background: #ff8c00 !important;">
      <h1>MISO</h1>
    </div>
    <div class="form-section p-4">
      <h2>Verify your account</h2>
      <form method="post">
        {% csrf_token %}
        <p>We have sent the verification code to {{ email }}</p>
        <div class="text-center">
          <input type="text" name="code" id="code" class="code-input" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="____">
        </div>
        <div class="d-flex align-items-center justify-content-between mt-3 gap-3">
          <button type="submit" class="resend-link" name="resend" value="1" id="resend-btn" disabled>Resend code (1m)</button>
          <button type="submit" class="btn btn-warning px-4 py-2" id="verify-btn">Verify</button>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
          var resendBtn = document.getElementById('resend-btn');
          if (!resendBtn) {
            return;
          }

          var cooldownSeconds = 60; // 1 minute
          var remaining = cooldownSeconds;
          resendBtn.disabled = true;

          function formatTime(seconds) {
            if (seconds >= 60) {
              var minutes = Math.floor(seconds / 60);
              var secs = seconds % 60;
              if (secs === 0) {
                return minutes + 'm';
              }
              return minutes + 'm ' + secs + 's';
            }
            return seconds + 's';
          }

          function updateResendLabel(seconds) {
            resendBtn.textContent = 'Resend code (' + formatTime(seconds) + ')';
          }

          updateResendLabel(remaining);

          var countdown = setInterval(function() {
            remaining -= 1;
            if (remaining > 0) {
              updateResendLabel(remaining);
            } else {
              clearInterval(countdown);
              resendBtn.disabled = false;
              resendBtn.textContent = 'Resend code';
              resendBtn.style.textDecoration = 'underline';
              resendBtn.style.color = '#0d6efd';
            }
          }, 1000);
        });
        </script>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/myscript.js' %}"></script>
<script>
  // Aggressively remove mobile header
  (function() {
    document.documentElement.classList.add("verify-page");
    
    function hideMobileHeader() {
      const mobileHeader = document.querySelector(".mobile-header");
      if (mobileHeader) {
        mobileHeader.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; height: 0 !important; overflow: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; margin: 0 !important; padding: 0 !important;';
        mobileHeader.remove();
      }

      // Also hide child elements
      const mobileHeaderLeft = document.querySelector(".mobile-header-left");
      const mobileHeaderRight = document.querySelector(".mobile-header-right");
      const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
      const mobileBrand = document.querySelector(".mobile-brand");
      
      [mobileHeaderLeft, mobileHeaderRight, mobileMenuToggle, mobileBrand].forEach(el => {
        if (el) {
          el.style.cssText = 'display: none !important; visibility: hidden !important;';
          el.remove();
        }
      });

      const mobileNav = document.getElementById("mobile-nav");
      if (mobileNav) {
        mobileNav.remove();
      }

      const mobileNavOverlay = document.getElementById("mobile-nav-overlay");
      if (mobileNavOverlay) {
        mobileNavOverlay.remove();
      }
    }
    
    // Try to remove immediately
    hideMobileHeader();
    
    // Remove on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', hideMobileHeader);
    } else {
      hideMobileHeader();
    }

    // Use MutationObserver to catch dynamically added elements
    const observer = new MutationObserver(function(mutations) {
      hideMobileHeader();
    });

    // Start observing
    if (document.body) {
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      });
    }

    // Also check periodically as a last resort (every 500ms for first 5 seconds)
    let checkCount = 0;
    const maxChecks = 10;
    const intervalId = setInterval(function() {
      hideMobileHeader();
      checkCount++;
      if (checkCount >= maxChecks) {
        clearInterval(intervalId);
      }
    }, 500);
  })();
</script>
{% endblock %}