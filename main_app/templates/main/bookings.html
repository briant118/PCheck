{% extends 'base.html' %}
{% load template_filters %}
{% load static %}

{% block title %}Bookings{% endblock %}

{% block content %}
<div class="container">

  <!-- ===== TOP-LEVEL TABS ===== -->
  <div class="nav nav-tabs tabs">
    <button id="tab-student-bookings" class="nav-link active tab">Student Bookings</button>
    <button id="tab-faculty-bookings" class="nav-link tab position-relative">
      {% if faculty_pending_count %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{faculty_pending_count}}
      </span>
      {% endif %}
      Faculty Bookings
    </button>
  </div>
  
  <!-- ===== STUDENT BOOKINGS CONTENT ===== -->
  <div id="student-bookings">
    <div class="nav nav-tabs subtabs">
      <button id="tab-student-all" class="nav-link active subtab">All</button>
      <button id="tab-student-pending" class="nav-link subtab position-relative">
        {% if student_pending_count %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{student_pending_count}}
        </span>
        {% endif %}
        Pending
      </button>
      <button id="tab-student-approved" class="nav-link subtab">Approved</button>
    </div>

    <div id="student-all" class="subcontent">
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Student Bookings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for booking in student_bookings %}
          <tr>
            <td>{{ booking.user.get_full_name }}</td>
            <td>{{ booking.user.profile.college.name }}</td>
            <td>{{ booking.created_at }}</td>
            <td></td>
            <td>{% if booking.status == None %}pending{% else %}{{ booking.status }}{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="student-pending" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for pending in student_pending_approvals %}
          <tr>
            <td>{{ pending.user.get_full_name }}</td>
            <td>{{ pending.user.profile.college.name }}</td>
            <td>{{ pending.created_at }}</td>
            <td></td>
            <td>{% if pending.status == None %}pending{% else %}{{ pending.status }}{% endif %}</td>
            <td>
              <button type="button"
                      class="btn btn-sm btn-outline-secondary review-booking"
                      data-name="{{ pending.user.get_full_name }}"
                      data-college="{{ pending.user.profile.college.name }}"
                      data-date="{{ pending.created_at }}"
                      data-pc="{{ pending.pc.name|default:'-' }}"
                      data-accept-url="{% url 'main_app:reservation-approved' pk=pending.pk %}"
                      data-decline-url="{% url 'main_app:reservation-declined' pk=pending.pk %}">
                review
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="student-approved" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for approved in student_approved_bookings %}
          <tr>
            <td>{{ approved.user.get_full_name }}</td>
            <td>{{ approved.user.profile.college.name }}</td>
            <td>{{ approved.created_at }}</td>
            <td></td>
            <td>{{ approved.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Booking Review Modal -->
  <div class="modal fade" id="bookingReviewModal" tabindex="-1" aria-labelledby="bookingReviewLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingReviewLabel">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div><strong>Name:</strong> <span id="bk_name"></span></div>
          <div><strong>College:</strong> <span id="bk_college"></span></div>
          <div><strong>Date:</strong> <span id="bk_date"></span></div>
          <div><strong>PC:</strong> <span id="bk_pc"></span></div>
        </div>
        <div class="modal-footer">
          <a id="bk_accept" class="btn btn-success" href="#">Accept</a>
          <a id="bk_decline" class="btn btn-danger" href="#">Decline</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Faculty Booking Cancel Confirmation Modal -->
  <div class="modal fade" id="facultyCancelConfirmModal" tabindex="-1" aria-labelledby="facultyCancelConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content faculty-cancel-modal">
        <div class="modal-body faculty-cancel-modal-body">
          <div class="faculty-cancel-icon">
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <h5 class="faculty-cancel-title">Cancel this faculty booking?</h5>
          <p class="faculty-cancel-message">This action cannot be undone.</p>
        </div>
        <div class="modal-footer faculty-cancel-modal-footer">
          <button type="button" class="btn faculty-cancel-btn-ok" id="facultyCancelConfirmBtn">OK</button>
          <button type="button" class="btn faculty-cancel-btn-cancel" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== FACULTY BOOKINGS CONTENT ===== -->
  <div id="faculty-bookings" hidden>
    <div class="nav nav-tabs subtabs">
      <button id="tab-faculty-all" class="nav-link active subtab">All</button>
      <button id="tab-faculty-pending" class="nav-link subtab position-relative">
        {% if faculty_pending_count %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{faculty_pending_count}}
        </span>
        {% endif %}
        Pending
      </button>
      <button id="tab-faculty-approved" class="nav-link subtab">Approved</button>
    </div>

    <div id="faculty-all" class="subcontent">
      <table class="table">
        <head>
          <tr>
            <th colspan="6">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_bookings %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
            <td>
              <a href="{% url 'main_app:block-reservation-approval' pk=booking.pk %}" class="btn btn-sm btn-outline-secondary">view</a>
              {% if booking.status == 'confirmed' %}
              <a href="{% url 'main_app:block-reservation-declined' pk=booking.pk %}" class="btn btn-sm btn-outline-danger ms-1 faculty-cancel-link" data-booking-id="{{ booking.pk }}">cancel</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="faculty-pending" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_pending_approvals %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
            <td>
              <a href="{% url 'main_app:block-reservation-approval' pk=booking.pk %}" class="btn btn-sm btn-outline-secondary">
                review
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="faculty-approved" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th colspan="6">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_approved_bookings %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
            <td>
              <a href="{% url 'main_app:block-reservation-approval' pk=booking.pk %}" class="btn btn-sm btn-outline-secondary">view</a>
              <a href="{% url 'main_app:block-reservation-declined' pk=booking.pk %}" class="btn btn-sm btn-outline-danger ms-1 faculty-cancel-link" data-booking-id="{{ booking.pk }}">cancel</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Bookings page loaded');
  
  // === Generic Tab Switcher (Vanilla JS) ===
  function initTabGroup(tabSelectors, contentSelectors) {
    const tabs = document.querySelectorAll(tabSelectors);
    const contents = document.querySelectorAll(contentSelectors);
    
    tabs.forEach(function(tab, index) {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Tab clicked:', tab.id, 'index:', index);
        
        // Switch active tab
        tabs.forEach(function(t) {
          t.classList.remove('active');
        });
        tab.classList.add('active');
        
        // Switch content
        contents.forEach(function(c) {
          c.hidden = true;
        });
        if (contents[index]) {
          contents[index].hidden = false;
          console.log('Showing content:', contents[index].id);
        }
      });
    });
  }

  // === Main Tabs ===
  initTabGroup("#tab-student-bookings, #tab-faculty-bookings", "#student-bookings, #faculty-bookings");

  // === Subtabs: Student Bookings ===
  initTabGroup("#tab-student-all, #tab-student-pending, #tab-student-approved", "#student-all, #student-pending, #student-approved");

  // === Subtabs: Faculty Bookings ===
  initTabGroup("#tab-faculty-all, #tab-faculty-pending, #tab-faculty-approved", "#faculty-all, #faculty-pending, #faculty-approved");

  // Review button -> show modal with details; do NOT auto-accept
  document.addEventListener('click', function(e){
    var target = e.target;
    if (target && target.classList.contains('review-booking')) {
      e.preventDefault();
      e.stopPropagation();
      var name = target.getAttribute('data-name') || '';
      var college = target.getAttribute('data-college') || '';
      var date = target.getAttribute('data-date') || '';
      var pc = target.getAttribute('data-pc') || '-';
      var acceptUrl = target.getAttribute('data-accept-url') || '#';
      var declineUrl = target.getAttribute('data-decline-url') || '#';
      document.getElementById('bk_name').textContent = name;
      document.getElementById('bk_college').textContent = college;
      document.getElementById('bk_date').textContent = date;
      document.getElementById('bk_pc').textContent = pc;
      document.getElementById('bk_accept').setAttribute('href', acceptUrl);
      document.getElementById('bk_decline').setAttribute('href', declineUrl);
      var modalEl = document.getElementById('bookingReviewModal');
      if (modalEl) {
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    }
  });

  // Faculty booking cancel confirmation
  var cancelUrl = null;
  document.addEventListener('click', function(e){
    var target = e.target.closest('.faculty-cancel-link');
    if (target) {
      e.preventDefault();
      e.stopPropagation();
      cancelUrl = target.getAttribute('href');
      var modalEl = document.getElementById('facultyCancelConfirmModal');
      if (modalEl) {
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      }
    }
  });

  // Handle OK button click
  var confirmBtn = document.getElementById('facultyCancelConfirmBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function(){
      if (cancelUrl) {
        window.location.href = cancelUrl;
      }
    });
  }
  
  // WebSocket connection for booking status updates (auto-refresh when QR is scanned)
  (function initBookingStatusWS() {
    var bookingWS = null;
    var reconnectAttempts = 0;
    var maxReconnectAttempts = 5;
    var reconnectDelay = 3000;
    var shouldReconnect = true;
    
    function connect() {
      try {
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsPath = `${wsProtocol}//${window.location.host}/ws/booking-status/`;
        bookingWS = new WebSocket(wsPath);
        
        bookingWS.onopen = function() {
          console.log('‚úÖ Booking status WebSocket connected');
          reconnectAttempts = 0;
          // Send heartbeat periodically
          setInterval(function() {
            if (bookingWS && bookingWS.readyState === WebSocket.OPEN) {
              bookingWS.send(JSON.stringify({type: 'heartbeat'}));
            }
          }, 30000); // Every 30 seconds
        };
        
        bookingWS.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            console.log('üì® Booking status update received:', data);
            
            if (data.type === 'booking_status_update') {
              if (data.status === 'confirmed') {
                console.log('‚úÖ Booking confirmed via QR scan! Refreshing page...');
                
                // Show notification if possible
                if ('Notification' in window && Notification.permission === 'granted') {
                  new Notification('Booking Approved!', {
                    body: data.message || 'Your reservation has been approved!',
                    icon: '/static/favicon.svg'
                  });
                }
                
                // Hard refresh - redirect to home page with cache-busting parameter
                // Use a small delay to ensure the backend has processed the update
                setTimeout(function() {
                  // Add timestamp to force hard refresh (bypass cache)
                  const timestamp = new Date().getTime();
                  window.location.replace('/?_refresh=' + timestamp);
                }, 500);
              }
            } else if (data.type === 'violation_notification') {
              console.log('‚ö†Ô∏è Violation notification received:', data);
              
              // For minor violations, check if already shown
              if (data.level === 'minor') {
                var seenKey = 'violation_seen_' + data.violation_id;
                var alreadySeen = localStorage.getItem(seenKey);
                if (alreadySeen) {
                  console.log('Minor violation already shown, skipping');
                  return; // Don't show again
                }
                
                // Mark as seen immediately (will be shown once)
                localStorage.setItem(seenKey, 'true');
              }
              
              // Show browser notification
              if ('Notification' in window && Notification.permission === 'granted') {
                const title = data.level === 'minor' ? '‚ö†Ô∏è Warning' : 'üö´ Account Suspended';
                new Notification(title, {
                  body: data.message || 'You have received a violation',
                  icon: '/static/favicon.svg',
                  tag: 'violation_' + data.violation_id,
                  requireInteraction: data.level !== 'minor'
                });
              }
              
              // Show alert/notification on page
              const notificationDiv = document.createElement('div');
              notificationDiv.className = 'alert alert-' + (data.level === 'minor' ? 'warning' : 'danger');
              notificationDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;';
              notificationDiv.innerHTML = '<strong>' + (data.level === 'minor' ? '‚ö†Ô∏è Warning' : 'üö´ Violation') + '</strong><br>' + 
                                          (data.message || 'You have received a violation') +
                                          '<button type="button" class="btn-close" onclick="this.parentElement.remove()" style="float: right;"></button>';
              document.body.appendChild(notificationDiv);
              
              // Auto-remove after 10 seconds for minor, 30 seconds for others
              setTimeout(function() {
                if (notificationDiv.parentElement) {
                  notificationDiv.remove();
                }
              }, data.level === 'minor' ? 10000 : 30000);
              
              // If suspended, redirect to appropriate page or show message
              if (data.status === 'suspended') {
                console.log('Account suspended. User should be redirected or shown suspension message.');
                // You can add redirect logic here if needed
              }
            } else if (data.type === 'heartbeat_ack') {
              // Heartbeat acknowledged, connection is alive
              console.debug('üíì Booking status WebSocket heartbeat acknowledged');
            }
          } catch (error) {
            console.error('‚ùå Error parsing booking status message:', error);
          }
        };
        
        bookingWS.onerror = function(error) {
          console.error('‚ùå Booking status WebSocket error:', error);
          if (reconnectAttempts >= maxReconnectAttempts) {
            shouldReconnect = false;
          }
        };
        
        bookingWS.onclose = function() {
          console.log('‚ùå Booking status WebSocket closed');
          if (shouldReconnect && reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            setTimeout(function() {
              if (shouldReconnect) {
                console.log(`üîÑ Reconnecting booking status WebSocket (attempt ${reconnectAttempts})...`);
                connect();
              }
            }, reconnectDelay);
          }
        };
      } catch (error) {
        console.error('‚ùå Error creating booking status WebSocket:', error);
        // Silently fail - polling will still work
      }
    }
    
    // Connect when page loads
    connect();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      shouldReconnect = false;
      if (bookingWS) {
        bookingWS.close();
      }
    });
  })();
});
</script>
{% endblock %}
