{% extends 'base.html' %}
{% load template_filters %}
{% load static %}

{% block title %}Bookings{% endblock %}

{% block content %}
<div class="container mt-5 pt-5">

  <!-- ===== TOP-LEVEL TABS ===== -->
  <div class="nav nav-tabs tabs">
    <button id="tab-student-bookings" class="nav-link active tab">Student Bookings</button>
    <button id="tab-faculty-bookings" class="nav-link tab position-relative">
      {% if faculty_pending_count %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{faculty_pending_count}}
      </span>
      {% endif %}
      Faculty Bookings
    </button>
  </div>
  
  <!-- ===== STUDENT BOOKINGS CONTENT ===== -->
  <div id="student-bookings">
    <div class="nav nav-tabs subtabs">
      <button id="tab-student-all" class="nav-link active subtab">All</button>
      <button id="tab-student-pending" class="nav-link subtab position-relative">
        Pending
      </button>
      <button id="tab-student-approved" class="nav-link subtab">Approved</button>
    </div>

    <div id="student-all" class="subcontent">
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Student Bookings</th>
          </tr>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for booking in student_bookings %}
          <tr>
            <td>{{ booking.user.get_full_name }}</td>
            <td>{{ booking.user.profile.college.name }}</td>
            <td>{{ booking.created_at }}</td>
            <td></td>
            <td>{% if booking.status == None %}pending{% else %}{{ booking.status }}{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="student-pending" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for pending in student_pending_approvals %}
          <tr>
            <td>{{ pending.user.get_full_name }}</td>
            <td>{{ pending.user.profile.college.name }}</td>
            <td>{{ pending.created_at }}</td>
            <td></td>
            <td>{% if pending.status == None %}pending{% else %}{{ pending.status }}{% endif %}</td>
            <td>
              <a href="{% url 'main_app:reservation-approval' pk=pending.pk %}" class="btn btn-sm btn-outline-secondary">
                review
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="student-approved" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th>Name</th>
            <th>College</th>
            <th>Date</th>
            <th>Inbox</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for approved in student_approved_bookings %}
          <tr>
            <td>{{ approved.user.get_full_name }}</td>
            <td>{{ approved.user.profile.college.name }}</td>
            <td>{{ approved.created_at }}</td>
            <td></td>
            <td>{{ approved.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== FACULTY BOOKINGS CONTENT ===== -->
  <div id="faculty-bookings" hidden>
    <div class="nav nav-tabs subtabs">
      <button id="tab-faculty-all" class="nav-link active subtab">All</button>
      <button id="tab-faculty-pending" class="nav-link subtab position-relative">
        {% if faculty_pending_count %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
          {{faculty_pending_count}}
        </span>
        {% endif %}
        Pending
      </button>
      <button id="tab-faculty-approved" class="nav-link subtab">Approved</button>
    </div>

    <div id="faculty-all" class="subcontent">
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_bookings %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="faculty-pending" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_pending_approvals %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
            <td>
              <a href="{% url 'main_app:block-reservation-approval' pk=booking.pk %}" class="btn btn-sm btn-outline-secondary">
                review
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="faculty-approved" class="subcontent" hidden>
      <table class="table">
        <head>
          <tr>
            <th colspan="5">Faculty Bookings</th>
          </tr>
          <tr>
            <th>Requester</th>
            <th>Start</th>
            <th>End</th>
            <th># of PC</th>
            <th>Status</th>
          </tr>
        </head>
        <tbody>
          {% for booking in faculty_approved_bookings %}
          <tr>
            <td>{{ booking.faculty.get_full_name }}</td>
            <td>{{ booking.start_datetime }}</td>
            <td>{{ booking.end_datetime }}</td>
            <td>{{ booking.num_of_devices }}</td>
            <td>{{ booking.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script>
  $(document).ready(function () {
    // === Generic Tab Switcher ===
    function initTabGroup($tabs, $contents) {
      $tabs.on("click", function (e) {
        e.preventDefault();
        const index = $tabs.index(this);

        // Switch active tab
        $tabs.removeClass("active");
        $(this).addClass("active");

        // Switch content
        $contents.prop("hidden", true);
        $contents.eq(index).prop("hidden", false);
      });

      // Set initial visible tab
      $tabs.first().addClass("active");
      $contents.prop("hidden", true).first().prop("hidden", false);
    }

    // === Main Tabs ===
    const $mainTabs = $("#tab-student-bookings, #tab-faculty-bookings");
    const $mainContents = $("#student-bookings, #faculty-bookings");
    initTabGroup($mainTabs, $mainContents);

    // === Subtabs: Student Bookings ===
    const $studentSubTabs = $("#tab-student-all, #tab-student-pending, #tab-student-approved");
    const $studentSubContents = $("#student-all, #student-pending, #student-approved");
    initTabGroup($studentSubTabs, $studentSubContents);

    // === Subtabs: Faculty Bookings ===
    const $facultySubTabs = $("#tab-faculty-all, #tab-faculty-pending, #tab-faculty-approved");
    const $facultySubContents = $("#faculty-all, #faculty-pending, #faculty-approved");
    initTabGroup($facultySubTabs, $facultySubContents);
  });
</script>
{% endblock %}
