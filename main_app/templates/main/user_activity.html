{% extends "base.html" %}
{% load static %}

{% block title %}Users{% endblock %}

{% block links %}
<style>
.level {
  /* Remove black background for colored dots */
  background-color: transparent;
  border-radius: 50%;
}

.level.level-minor,
.level-minor {
  color: #ffc107 !important; /* yellow - vibrant */
}

.level.level-moderate,
.level-moderate {
  color: #fd7e14 !important; /* orange - vibrant */
}

.level.level-major,
.level-major {
  color: #dc3545 !important; /* red - vibrant */
}
#chatContainer {
Â  height: 400px; Â  Â  Â  Â  Â /* fixed height */
Â  overflow-y: auto; Â  Â  Â  /* makes it scrollable */
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 10px;
  background: #f9f9f9;
  margin-bottom: 3px;
}

.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 70%;
}

/* Messenger layout */
.messenger {
  border: 1px solid #ddd;
  border-radius: 6px;
  overflow: hidden;
}
.messenger .convos {
  border-right: 1px solid #eee;
  max-height: 480px;
  overflow-y: auto;
}
.messenger .chat-pane {
  max-height: 480px;
  display: flex;
  flex-direction: column;
}
.messenger .chat-header { padding: .5rem .75rem; border-bottom: 1px solid #eee; background:#fafafa; }
.messenger .chat-body { padding: .5rem; flex: 1; overflow-y: auto; background:#f9f9f9; }
.messenger .chat-input { padding: .5rem; border-top: 1px solid #eee; background:#fff; }

/* Sender: left side */
.sender {
  background: #DCF8C6;
  align-self: flex-start;
}

/* Receiver: right side */
.receiver {
  background: #E5E5EA;
  align-self: flex-end;
}
.actions-cell { 
  white-space: nowrap; 
  width: 100px; 
  vertical-align: middle !important;
  text-align: center !important;
  position: relative;
}

/* Fix table cell vertical alignment */
.table tbody td {
  vertical-align: middle !important;
}

.table thead th {
  vertical-align: middle !important;
  text-align: left !important;
}

/* Left align Name, Date/Time columns - header */
.table thead th:nth-child(1),
.table thead th:nth-child(4) {
  text-align: left !important;
}

/* Left align Name, Date/Time columns - body */
.table tbody td:nth-child(1),
.table tbody td:nth-child(4) {
  text-align: left !important;
  vertical-align: middle !important;
}

/* Center align Level, Description, Status and Actions columns - header */
.table thead th:nth-child(2),
.table thead th:nth-child(3),
.table thead th:nth-child(5),
.table thead th:nth-child(6) {
  text-align: center !important;
}

/* Center align Level, Description, Status and Actions columns - body */
.table tbody td:nth-child(2),
.table tbody td:nth-child(3),
.table tbody td:nth-child(5),
.table tbody td:nth-child(6) {
  text-align: center !important;
  vertical-align: middle !important;
}

/* Center the action button group */
.table tbody td:nth-child(6) {
  text-align: center !important;
}

.table .actions-cell .btn-group {
  display: inline-flex !important;
  justify-content: center !important;
  align-items: center !important;
  margin: 0 auto !important;
  width: auto !important;
  gap: 0;
}

.table .actions-cell .btn-group .btn {
  margin: 0;
  padding: 0.5rem 0.75rem;
  min-width: auto;
  flex: 0 0 auto;
  font-size: 1rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.table .actions-cell .btn-group .btn::after {
  font-size: 1.1rem;
  margin-left: 0.5rem;
}

/* Center the status badge */
.table tbody td:nth-child(5) {
  text-align: center !important;
}

.table tbody td:nth-child(5) .badge {
  display: inline-block !important;
  margin: 0 auto !important;
}

/* Remove top padding from content-wrapper for this page */
#content.content-wrapper {
  padding-top: 0 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container" id="user-activities-container" data-user-role="{{ request.user.profile.role }}" style="padding-top: 0; margin-top: 0;">
  {% if request.user.profile.role == 'staff' %}
  <div class="row mb-3">
    <div class="col-md-6"></div>
    <div class="col-md-6 d-flex justify-content-end" id="violation-level-legend">
      <div class="bg-light p-3 rounded shadow text-center" style="min-width: 280px;">
        <h6 class="mb-3">Violation Level</h6>
        <div class="d-flex justify-content-around align-items-center">
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">minor</span>
            <i class="fa-solid fa-circle shadow level level-minor" style="font-size: 1.2em;"></i>
          </div>
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">moderate</span>
            <i class="fa-solid fa-circle shadow level level-moderate" style="font-size: 1.2em;"></i>
          </div>
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">major</span>
            <i class="fa-solid fa-circle shadow level level-major" style="font-size: 1.2em;"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <div class="nav nav-tabs tabs" id="myTab">
    {% if request.user.profile.role == 'staff' %}
    <button id="tabHistory" class="nav-link active tab">History</button>
    <button id="tabChats" class="nav-link tab">Chats</button>
    <button id="tabViolation" class="nav-link tab">Violation</button>
    {% endif %}
    <div class="ms-auto d-flex align-items-center gap-3">
      <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-circle level level-minor" style="font-size: 0.875rem;"></i>
        <span style="font-size: 0.875rem;">Minor</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-circle level level-moderate" style="font-size: 0.875rem;"></i>
        <span style="font-size: 0.875rem;">Moderate</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-circle level level-major" style="font-size: 0.875rem;"></i>
        <span style="font-size: 0.875rem;">Major</span>
      </div>
    </div>
  </div>

Â  Â  <div id="tab-history" class="subcontent">
Â  Â  <h5 class="mt-3">Booking History</h5>
    <table class="table">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr><th>Name</th><th>ID</th><th>College</th><th>Date</th><th>PC</th><th>Action</th></tr>
Â  Â  Â  Â  </thead>
      <tbody>
        {% for activity in user_activities %}
        <tr>
          <td>{{ activity.user.get_full_name }}</td>
          <td>{{ activity.user.profile.school_id }}</td>
          <td>{{ activity.user.profile.college.name }}</td>
          <td>{{ activity.created_at }}</td>
          <td>{{ activity.pc.name }}</td>
          <td class="actions-cell">
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-secondary view-activity"
                            data-user-name="{{ activity.user.get_full_name }}"
                            data-user-id="{{ activity.user.profile.school_id }}"
                            data-college="{{ activity.user.profile.college.name }}"
                            data-date="{{ activity.created_at }}"
                            data-pc="{{ activity.pc.name }}"
                            data-pk="{{ activity.pk }}">
                         View
                        </button>
                      <button type="button" class="btn btn-outline-danger suspend-button" data-pk="{{ activity.pk }}">Suspend</button>
                    </div>
                </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </tbody>
Â  Â  </table>
Â  </div>

Â  Â  <div id="tab-chats" class="subcontent" hidden>
Â  Â  <h5 class="mt-3">All Users & Chats</h5>
    <div class="mb-3">
      <input type="text" id="user-chat-search" class="form-control" placeholder="Search user...">
    </div>
    {% if request.user.profile.role != 'staff' %}
    <div class="mb-3">
      <button type="button" class="btn btn-primary start-chat-btn" data-recipient-email="PCheck" data-recipient-name="PCheck">
        Message PCheck
      </button>
    </div>
    {% endif %}
Â  Â  <div class="table-responsive">
Â  Â  Â  <table class="table table-striped table-hover"> 
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr><th>Name</th><th>Email</th><th>College</th><th>Actions</th></tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  {% for user in users %}
Â  Â  Â  Â  Â  <tr class="chat-user-row">
Â  Â  Â  Â  Â  Â  <td class="chat-user-name">{{ user.get_full_name|default:user.username }}</td>
Â  Â  Â  Â  Â  Â  <td class="chat-user-email">{{ user.email }}</td>
Â  Â  Â  Â  Â  Â  <td>{{ user.profile.college.name|default:'-' }}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-sm btn-outline-primary start-chat-btn" data-recipient-email="{{ user.email }}" data-recipient-name="{{ user.first_name }} {{ user.last_name }}">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-comments"></i> Chat
Â  Â  Â  Â  Â  Â  Â  </button>
          </td>
        </tr>
Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  </tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  Â  <div class="table-responsive mt-4">
      <h6>Your Conversations</h6>
      <div class="messenger row g-0 mt-2">
        <div class="col-12 col-md-4 convos">
          <ul id="convoList" class="list-group list-group-flush">
            <!-- Populated by JS -->
          </ul>
        </div>
        <div class="col-12 col-md-8 chat-pane">
          <div class="chat-header">
            <strong id="convoWithInline">Select a conversation</strong>
          </div>
          <div class="chat-body" id="chatContainerInline"></div>
          <div class="chat-input d-flex">
            <input type="text" class="form-control me-2" id="new_message_inline" placeholder="Type a message...">
            <button type="button" class="btn btn-primary" id="send_new_message_btn_inline">Send</button>
          </div>
        </div>
      </div>
Â  Â  </div>
Â  </div>

    <div id="tab-violation" class="subcontent" hidden>
    <form class="row g-2 align-items-end mb-3" method="get">
      <input type="hidden" name="tab" value="violation">
      <div class="col-md-3">
        <label class="form-label">Search</label>
        <input type="text" name="search-user" value="{{ search_user }}" class="form-control" placeholder="Name or email">
      </div>
      <div class="col-md-3">
        <label class="form-label">College</label>
        <select name="college" class="form-select">
          <option value="">All colleges</option>
          {% for college in colleges %}
            <option value="{{ college.id }}" {% if selected_college|default:'' == college.id|stringformat:'s' %}selected{% endif %}>{{ college.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">Apply</button>
        <div class="btn-group" role="group">
          <a class="btn btn-outline-warning" href="{% url 'main_app:users' %}{% if selected_college %}?college={{ selected_college }}{% endif %}" style="border-color: #ff9800; color: #ff9800;">Users</a>
          <a class="btn btn-outline-warning active" aria-disabled="true" style="border-color: #ff9800; color: #ff9800; background-color: #fff3cd;">Violations</a>
        </div>
      </div>
    </form>
    <table class="table">
      <thead>
        <tr><th>Name</th><th class="text-center">Level</th><th class="text-center">Description</th><th>Date/Time</th><th class="text-center">Status</th><th class="text-center">Action</th></tr>
      </thead>
      <tbody>
        {% for violation in violations %}
        <tr data-violation-id="{{ violation.id }}" data-user-name="{{ violation.user.get_full_name }}" data-level="{{ violation.level }}" data-reason="{{ violation.reason }}" data-time="{{ violation.timestamp }}">
          <td>{{ violation.user.get_full_name }}</td>
          <td class="text-center">
            <i class="fa-solid fa-circle shadow
            {% if violation.level == 'minor' %}level level-minor{% elif violation.level == 'moderate' %}level level-moderate{% elif violation.level == 'major' %}level level-major{% endif %}"></i>
          </td>
          <td class="vio-reason text-center">{{ violation.reason }}</td>
          <td class="vio-time">{{ violation.timestamp }}</td>
          <td class="vio-status text-center"><span class="badge {% if violation.status == 'suspended' %}text-bg-danger{% else %}text-bg-secondary{% endif %} shadow">{% if violation.status == 'suspended' %}Suspended{% else %}Active{% endif %}</span></td>
          <td class="actions-cell text-center">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              </button>
              <ul class="dropdown-menu">
                <li>
                  <button type="button" class="dropdown-item view-violation" data-violation-id="{{ violation.id }}" data-user-name="{{ violation.user.get_full_name }}" data-level="{{ violation.level }}" data-reason="{{ violation.reason }}" data-time="{{ violation.timestamp }}">
                    <i class="fa-solid fa-eye me-2"></i>View
                  </button>
                </li>
                {% if violation.status == 'suspended' %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <button type="button" class="dropdown-item text-success unsuspend-btn" data-vpk="{{ violation.id }}">
                    <i class="fa-solid fa-check-circle me-2"></i>Unsuspend
                  </button>
                </li>
                {% endif %}
              </ul>
            </div>
          </td>
Â  Â  Â  Â  </tr>
Â  Â  Â  Â  {% endfor %}
Â  Â  Â  </tbody>
Â  Â  </table>
Â  </div>

      <div class="modal fade" id="activityViewModal" tabindex="-1" aria-labelledby="activityViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 shadow">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title" id="activityViewModalLabel">Booking Details</h5>
Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  <div><strong>Name:</strong> <span id="view_name"></span></div>
Â  Â  Â  Â  Â  <div><strong>ID:</strong> <span id="view_id"></span></div>
Â  Â  Â  Â  Â  <div><strong>College:</strong> <span id="view_college"></span></div>
Â  Â  Â  Â  Â  <div><strong>Date:</strong> <span id="view_date"></span></div>
Â  Â  Â  Â  Â  <div><strong>PC:</strong> <span id="view_pc"></span></div>
Â  Â  Â  Â  </div>
        <div class="modal-footer">
          <button type="button" id="suspend_from_view_btn" class="btn btn-danger" data-suspend-pk="">Suspend</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

  <div class="modal fade" id="violationViewModal" tabindex="-1" aria-labelledby="violationViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="violationViewModalLabel">Violation Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div><strong>Name:</strong> <span id="v_user"></span></div>
          <div><strong>Level:</strong> <span id="v_level"></span></div>
          <div><strong>Description:</strong> <span id="v_reason"></span></div>
          <div><strong>Date/Time:</strong> <span id="v_time"></span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

        <!-- Unsuspend Confirmation Modal -->
        <div class="modal fade" id="unsuspendConfirmModal" tabindex="-1" aria-labelledby="unsuspendConfirmModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 shadow">
              <div class="modal-header">
                <h5 class="modal-title" id="unsuspendConfirmModalLabel">Confirm Unsuspend</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <div class="mb-3">
                  <i class="fa-solid fa-question-circle" style="font-size: 3rem; color: #ff9800;"></i>
                </div>
                <p class="mb-0">Are you sure you want to unsuspend this violation?</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-unsuspend-btn" data-vpk="">Confirm</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="violationModal" tabindex="-1" aria-labelledby="violationModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-3 shadow">
              <div class="modal-header">
          <h5 class="modal-title" id="violationModalLabel">Add more info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="justify-content-center" style="max-width:200px; margin:auto;">
                  <div class="form-group mt-3">
                    <label for="violation-level" class="form-label">Level:</label>
                    <select id="violation-level" name="violation-level" class="form-control">
                      <option value="minor">Minor</option>
                      <option value="moderate">Moderate</option>
                      <option value="major">Major</option>
                    </select>
                  </div>
                  <div class="form-group mt-3">
                    <label for="reason-input" class="form-label">Description:</label>
                    <input type="text" id="reason-input" class="form-control">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
Â  Â  Â  Â  Â  <button type="button" id="suspend-button-submit" class="btn btn-danger" data-suspend-pk="">
                  Suspend
                </button>
              </div>
            </div>
          </div>
        </div>

    <div class="modal fade" id="initMessageModal" tabindex="-1" aria-labelledby="initMessageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
Â  Â  Â  <div class="modal-content">
          <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title" id="initMessageModalLabel">Start New Conversation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
Â  Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label for="recipient" class="form-label">Recipient Email:</label>
Â  Â  Â  Â  Â  Â  <input type="email" id="recipient" class="form-control" disabled>
              </div>
Â  Â  Â  Â  Â  <div class="mb-3">
                <label for="initMessage" class="form-label">Message:</label>
Â  Â  Â  Â  Â  Â  <textarea id="initMessage" class="form-control"></textarea>
            </div>
          </div>
          <div class="modal-footer">
Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
Â  Â  Â  Â  Â  <button type="button" id="send_init_message" class="btn btn-primary" data-send-init-message-url="{% url 'main_app:send-init-message' %}">Send</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
    	<div class="modal-dialog modal-lg modal-dialog-centered">
Â  Â  Â  <div class="modal-content">
          <div class="modal-header">
Â  Â  Â  Â  Â  <h5 class="modal-title" id="conversationModalLabel">Conversation with: <span id="convoWith"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
Â  Â  Â  Â  Â  <div id="chatContainer">
              </div>
Â  Â  Â  Â  Â  <div class="mt-3 d-flex">
Â  Â  Â  Â  Â  Â  <input type="text" class="form-control me-2" id="new_message" placeholder="Type your message...">
Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-primary" id="send_new_message_btn">Send</button>
            </div>
          </div>
Â  Â  Â  Â  <input type="hidden" id="roomId" value="">
Â  Â  Â  Â  <input type="hidden" id="receiverId" value="">
          </div>
        </div>
      </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <script>
// NOTE: I've only included the necessary functions and logic for the tabs here. 
// Your original chat, AJAX, and other functions are assumed to be in the same script block.

  $(document).ready(function () {
    // --- START of Generic Functions (Kept from your original script) ---
    const senderId = "{{ request.user.id }}"; 
    const currentUserId = "{{ request.user.id }}";
    const currentUserRole = $("#user-activities-container").data("user-role");
    let chatSocket = null;
    let currentRoomId = null;
    
    // Initialize page
    console.log("Page initialized. User ID:", currentUserId);

  // CSRF helper uses cookie set by Django
Â  function getCookie(name) {
Â  Â  let cookieValue = null;
Â  Â  if (document.cookie && document.cookie !== '') {
Â  Â  Â  const cookies = document.cookie.split(';');
Â  Â  Â  for (let i = 0; i < cookies.length; i++) {
Â  Â  Â  Â  const cookie = cookies[i].trim();
Â  Â  Â  Â  if (cookie.substring(0, name.length + 1) === (name + '=')) {
Â  Â  Â  Â  Â  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  return cookieValue;
Â  }
Â  const csrftoken = getCookie('csrftoken');

Â  // Bootstrap 5 modal helpers
Â  function showBsModal(modalId) {
Â  Â  var el = document.getElementById(modalId);
Â  Â  if (!el) return;
Â  Â  var modal = bootstrap.Modal.getOrCreateInstance(el);
Â  Â  modal.show();
Â  }
Â  function hideBsModal(modalId) {
Â  Â  var el = document.getElementById(modalId);
Â  Â  if (!el) return;
Â  Â  var modal = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el);
Â  Â  modal.hide();
Â  }

  // Lightweight toast helper for new message alerts
  function showToastMessage(titleText, bodyText) {
    try {
      var container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.position = 'fixed';
        container.style.top = '1rem';
        container.style.right = '1rem';
        container.style.zIndex = '1080';
        document.body.appendChild(container);
      }
      var toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center text-bg-danger border-0';
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      toastEl.style.minWidth = '260px';
      toastEl.innerHTML = '<div class="d-flex"><div class="toast-body"><strong>' + (titleText||'New message') +
        '</strong><br>' + (bodyText||'You have an unread message') +
        '</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>';
      container.appendChild(toastEl);
      var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
      toast.show();
    } catch(e) { console.warn('Toast error', e); }
  }

Â  // Placeholder for email variable used in global scope
  let email = null;

  // Chat functions implementation
  function resetInitMessageForm() {
    $("#recipient").val("");
    $("#initMessage").val("");
  }

  // Safe loadMessages function - only runs when Chats tab is active
  function loadMessages() {
    try {
      // Early return if Chats tab is not active
      const chatsTab = document.getElementById('tab-chats');
      if (!chatsTab || chatsTab.hidden) {
        console.log("Chats tab is not active, skipping loadMessages");
        return;
      }
      
      // Check if jQuery is available
      if (typeof $ === 'undefined' || !$.ajax) {
        console.error("jQuery is not available, cannot load messages");
        return;
      }
      
      // Check if messages table exists
      const messagesBody = $("#messagesTable tbody");
      if (!messagesBody || !messagesBody.length) {
        console.warn("Messages table not found, skipping loadMessages");
        return;
      }
      
      // All checks passed, safe to proceed
      
      $.ajax({
        url: "/ajax/load-messages",
        method: "GET",
        success: function (data) {
          try {
            if (!data || !data.result) {
              console.warn("Invalid data received from load-messages");
              return;
            }
            
            // Double-check that table still exists (tab might have been switched)
            if (!messagesBody.length) {
              console.log("Messages table no longer exists, aborting");
              return;
            }
            
            messagesBody.empty();
            const convoList = document.getElementById('convoList');
            if (convoList) { convoList.innerHTML = ''; }
            let seen = new Set();
            $.each(data.result, function (index, room) {
              const other = (currentUserId == room.receiver.id) ? room.initiator : room.receiver;
              const otherKey = `${other.id}-${room.id}`;
              if (seen.has(otherKey)) return;
              seen.add(otherKey);
              let row = `<tr class="messagesItem"
                            data-room-id="${room.id}"
                            data-receiver-email="${other.email}"
                            data-receiver-fname="${other.first_name}"
                            data-receiver-lname="${other.last_name}"
                            data-initiator-fname="${room.initiator.first_name}"
                            data-initiator-lname="${room.initiator.last_name}"
                            style="cursor: pointer;">
                            <td>${other.first_name} ${other.last_name}</td>
                        </tr>`;
              if (room.chats && room.chats.some(chat => chat.status === "sent" && chat.sender != currentUserId && chat.recipient == currentUserId)) {
                row = $(row).addClass("text-primary");
              }
              messagesBody.append(row);

              // Mirror into left convo list (messenger layout)
              if (convoList) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center convoItem';
                li.setAttribute('data-room-id', room.id);
                li.setAttribute('data-receiver-email', other.email);
                li.setAttribute('data-receiver-fname', other.first_name);
                li.setAttribute('data-receiver-lname', other.last_name);
                li.setAttribute('data-initiator-fname', room.initiator.first_name);
                li.setAttribute('data-initiator-lname', room.initiator.last_name);
                li.style.cursor = 'pointer';
                li.textContent = `${other.first_name} ${other.last_name}`;
                if (room.chats && room.chats.some(chat => chat.status === "sent" && chat.sender != currentUserId && chat.recipient == currentUserId)) {
                  li.classList.add('text-primary');
                }
                convoList.appendChild(li);
              }
            });
          } catch (error) {
            console.error("Error processing messages data:", error);
          }
        },
        error: function(xhr) {
          console.error("Error loading messages:", xhr);
          if (xhr.responseJSON && xhr.responseJSON.error) {
            console.error("Error details:", xhr.responseJSON.error);
          }
        }
      });
    } catch (error) {
      console.error("Error in loadMessages function:", error);
    }
  }

  function connectChatSocket(roomId) {
    // Close existing connection if any
    if (chatSocket && chatSocket.readyState !== WebSocket.CLOSED) {
      chatSocket.close();
    }
    
    currentRoomId = roomId;
    
    // Determine WebSocket protocol (ws:// or wss://)
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsPath = `${wsProtocol}//${window.location.host}/ws/chat/${roomId}/`;
    
    console.log("Connecting to WebSocket:", wsPath, "for room:", roomId);
    
    try {
      chatSocket = new WebSocket(wsPath);
      
      chatSocket.onopen = function(e) {
        console.log("âœ… WebSocket connection established for room:", roomId);
      };
      
      chatSocket.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          console.log("ğŸ“¨ WebSocket message received for room:", roomId);
          console.log("Message data:", data);
          
          // Verify message is for the current room
          if (data.room_id && String(data.room_id) !== String(roomId)) {
            console.warn(`âš ï¸ Message room_id (${data.room_id}) doesn't match WebSocket room (${roomId}), ignoring`);
            return;
          }
          
          if (data.type === "new_message") {
            console.log("âœ… Processing new_message type - calling handleNewMessage");
            handleNewMessage(data);
          } else if (data.type === "message_read") {
            console.log("Message read notification:", data);
          } else {
            console.log("Unknown message type:", data.type, data);
          }
        } catch (error) {
          console.error("âŒ Error parsing WebSocket message:", error, "Raw data:", e.data);
        }
      };
      
      chatSocket.onerror = function(e) {
        console.error("âŒ WebSocket error:", e);
        console.error("WebSocket readyState:", chatSocket.readyState);
      };
      
      chatSocket.onclose = function(e) {
        console.log("ğŸ”Œ WebSocket connection closed for room:", roomId, "Code:", e.code, "Reason:", e.reason);
        // Attempt to reconnect after 3 seconds if it wasn't a manual close
        if (currentRoomId === roomId && e.code !== 1000) {
          setTimeout(function() {
            if (currentRoomId === roomId && (chatSocket === null || chatSocket.readyState === WebSocket.CLOSED)) {
              console.log("ğŸ”„ Attempting to reconnect WebSocket...");
              connectChatSocket(roomId);
            }
          }, 3000);
        }
      };
    } catch (error) {
      console.error("âŒ Error creating WebSocket:", error);
    }
  }

  function disconnectChatSocket() {
    console.log("Disconnecting WebSocket");
    if (chatSocket) {
      chatSocket.close();
      chatSocket = null;
      currentRoomId = null;
    }
    window.currentOpenRoomId = null;
  }

  function handleNewMessage(data) {
    console.log("=== handleNewMessage START ===");
    console.log("Message data:", data);
    console.log("Current user ID:", currentUserId);
    console.log("Current open room ID:", window.currentOpenRoomId);
    
    const chatContainer = $("#chatContainerInline").length ? $("#chatContainerInline") : $("#chatContainer");
    const modal = $("#conversationModal");
    console.log("chatContainer found:", chatContainer.length > 0);
    console.log("Modal element found:", modal.length > 0);
    console.log("Modal has 'show' class:", modal.hasClass('show'));
    console.log("Modal visible:", modal.is(':visible'));
    
    // Verify room ID matches
    if (data.room_id && window.currentOpenRoomId && String(data.room_id) !== String(window.currentOpenRoomId)) {
      console.warn(`âš ï¸ Message room_id (${data.room_id}) doesn't match current open room (${window.currentOpenRoomId}), ignoring`);
      return;
    }
    
    const isSender = String(currentUserId) == String(data.sender_id);
    const isRecipient = String(currentUserId) == String(data.recipient_id);
    
    console.log(`Sender ID: ${data.sender_id}, Recipient ID: ${data.recipient_id}`);
    console.log(`isSender: ${isSender}, isRecipient: ${isRecipient}`);
    
    // Only add message if it belongs to the current user
    if (!isSender && !isRecipient) {
      console.log("âš ï¸ Message doesn't belong to current user, ignoring");
      return;
    }
    
    // Only add to chat container if modal is open
    if (chatContainer.length === 0) {
      console.warn("âš ï¸ chatContainer not found - modal might be closed");
      // Still update the conversation list
      loadMessages();
      return;
    }
    
    // Verify the room ID matches what we expect
    const currentRoomIdFromInput = $("#roomId").val();
    if (currentRoomIdFromInput && String(currentRoomIdFromInput) !== String(window.currentOpenRoomId)) {
      console.warn(`âš ï¸ Room ID mismatch - input (${currentRoomIdFromInput}) vs open room (${window.currentOpenRoomId})`);
      // Still update the conversation list
      loadMessages();
      return;
    }
    
    // Check if modal is open (use Bootstrap's modal instance check)
    const isModalVisible = modal.length > 0 && (modal.hasClass('show') || modal.is(':visible'));
    if (!isModalVisible) {
      console.warn("âš ï¸ Modal not visible - will not display message");
      console.log("Modal element:", modal.length > 0 ? "found" : "not found");
      console.log("Modal has 'show' class:", modal.hasClass('show'));
      console.log("Modal is visible:", modal.is(':visible'));
      // Still update the conversation list
      loadMessages();
      // If current user is recipient, show a toast notification for unread
      if (isRecipient) {
        var senderName = data.sender_first_name || data.sender_last_name || 'New message';
        showToastMessage('New message from ' + senderName, data.message);
      }
      return;
    }
    
    // Check if message already exists (avoid duplicates)
    if (data.chat_id) {
      const existingMessages = chatContainer.find(`[data-chat-id="${data.chat_id}"]`);
      if (existingMessages.length > 0) {
        console.log("âš ï¸ Message already displayed, skipping duplicate");
        loadMessages();
        return;
      }
    }
    
    // Remove any temp message with same content
    chatContainer.find(`[data-temp-message]`).remove();
    
    // Remove "No messages" placeholder if it exists
    chatContainer.find('.text-muted').remove();
    
    // Add the message
    if (isSender) {
      const messageHtml = `<div class="message sender" data-chat-id="${data.chat_id || 'temp_' + Date.now()}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${data.message}</div>`;
      chatContainer.append(messageHtml);
      console.log("âœ… Added sender message to chat");
    } else {
      const senderName = data.sender_first_name || data.sender_last_name || 'Staff';
      const messageHtml = `<div class="message receiver" data-chat-id="${data.chat_id || 'temp_' + Date.now()}" style="background:#E5E5EA; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-end;"><span style="font-size: small;">${senderName}</span><br>${data.message}</div>`;
      chatContainer.append(messageHtml);
      console.log("âœ… Added receiver message to chat");
    }
    
    chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
    console.log("=== handleNewMessage END ===");
    
    // Update unread indicators if needed
    loadMessages();
  }

  function loadConversation(roomId) {
    const chatContainer = $("#chatContainerInline").length ? $("#chatContainerInline") : $("#chatContainer");
    console.log("Loading conversation for room:", roomId);
    console.log("chatContainer found:", chatContainer.length > 0);
    console.log("Current user ID:", currentUserId);
    
    // Store the room ID globally so handleNewMessage can verify
    window.currentOpenRoomId = roomId;
    
    // Connect to WebSocket for real-time updates FIRST
    // This ensures we receive messages even during AJAX loading
    connectChatSocket(roomId);
    
    $.ajax({ 
      url: `/ajax/load-conversation/${roomId}/`, 
      method: "GET", 
      success: function(data) {
        console.log("loadConversation response:", data);
        
        // Check if container still exists (modal might have been closed)
        if (chatContainer.length === 0) {
          console.warn("chatContainer no longer exists, aborting");
          return;
        }
        
        chatContainer.empty();
        if (data.result && data.result.length > 0) {
          $.each(data.result, function(index, msg) {
            // Ensure the message belongs to the current user (as sender or recipient)
            if (String(currentUserId) == String(msg.sender__id) || String(currentUserId) == String(msg.recipient__id)) {
              // Use chat ID if available, otherwise use index
              const chatId = msg.id || `msg_${index}`;
              if (String(currentUserId) == String(msg.sender__id)) {
                chatContainer.append(`<div class="message sender" data-chat-id="${chatId}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${msg.message}</div>`);
              } else {
                chatContainer.append(`<div class="message receiver" data-chat-id="${chatId}" style="background:#E5E5EA; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-end;"><span style="font-size: small;">${msg.sender__first_name || 'Staff'}</span><br>${msg.message}</div>`);
              }
            }
          });
          chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        } else {
          chatContainer.append('<div class="text-muted">No messages in this conversation yet.</div>');
        }
      },
      error: function(xhr) {
        console.error("Error loading conversation:", xhr);
        if (chatContainer.length > 0) {
          chatContainer.append('<div class="text-danger">Error loading conversation. Please refresh the page.</div>');
        }
        if (xhr.responseJSON && xhr.responseJSON.error) {
          alert("Error: " + xhr.responseJSON.error);
        }
      }
    });
  }

Â  // Function to set up the chat modal for a new message
Â  $(document).on('click', '.start-chat-btn', function(){
Â  Â  const recipientEmail = $(this).data('recipient-email');
Â  Â  const recipientName = $(this).data('recipient-name');
Â  Â  $('#recipient').val(recipientEmail).prop('disabled', true);
Â  Â  $('#initMessageModalLabel').text(`Start New Conversation with ${recipientName}`);
Â  Â  showBsModal('initMessageModal');
Â  });

  // Also open init message modal when tapping the student's name (staff)
  $(document).on('click', '.chat-user-name', function(){
    var row = $(this).closest('tr');
    var recipientEmail = row.find('.chat-user-email').text().trim();
    var recipientName = $(this).text().trim();
    if (!recipientEmail) { return; }
    $('#recipient').val(recipientEmail).prop('disabled', true);
    $('#initMessageModalLabel').text(`Start New Conversation with ${recipientName}`);
    showBsModal('initMessageModal');
  });

  // --- END of Generic Functions ---

  // === Generic Tab Switcher (Vanilla JS) ===
  // This is the logic copied from your sample, simplified for clarity
  function initTabGroup(tabSelectors, contentSelectors, onSwitch) {
    const tabs = document.querySelectorAll(tabSelectors);
    const contents = document.querySelectorAll(contentSelectors);
    tabs.forEach(function(tab, index) {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        // Switch active tab
        tabs.forEach(function(t){ t.classList.remove('active'); });
        tab.classList.add('active');
        // Switch content
        contents.forEach(function(c){ c.hidden = true; });
        if (contents[index]) { contents[index].hidden = false; }
        if (typeof onSwitch === 'function') { onSwitch(tab.id); }
      });
    });
    // On load: ensure the first content is visible and the first tab is active
    contents.forEach(function(c,i){ c.hidden = i !== 0; });
    tabs.forEach(function(t,i){ i===0?t.classList.add('active'):t.classList.remove('active'); });
  }
  
  // Allow selecting active tab via ?tab=history|chats|violation
  var urlParams = new URLSearchParams(window.location.search);
  var requestedTab = (urlParams.get('tab') || '').toLowerCase();
  var tabOrder = ['history','chats','violation'];
  var initialIndex = Math.max(0, tabOrder.indexOf(requestedTab));

  const tabs = document.querySelectorAll('#tabHistory, #tabChats, #tabViolation');
  const contents = document.querySelectorAll('#tab-history, #tab-chats, #tab-violation');
  
  function switchTo(index){
    try {
      // Remove active class from all tabs
      tabs.forEach(function(t){ t.classList.remove('active'); });
      
      // Hide all content
      contents.forEach(function(c){ c.hidden = true; });
      
      // Activate selected tab
      if (tabs[index]) {
        tabs[index].classList.add('active');
      }
      
      // Show selected content
      if (contents[index]) {
        contents[index].hidden = false;
      }
      
      // Load messages only when Chats tab (index 1) is activated
      if (index === 1) {
        // Use setTimeout to ensure DOM is ready before loading messages
        setTimeout(function() {
          if (typeof loadMessages === 'function') {
            loadMessages();
          } else {
            console.warn("loadMessages function not available");
          }
        }, 100);
      }
    } catch (error) {
      console.error("Error switching tabs:", error);
    }
  }
  
  // Bind click handlers to tabs
  tabs.forEach(function(tab, idx){
    tab.addEventListener('click', function(e){ 
      e.preventDefault(); 
      e.stopPropagation();
      switchTo(idx); 
    });
  });
  
  // Set initial tab after DOM is ready
  setTimeout(function() {
    switchTo(initialIndex);
  }, 50);

  // Populate Violation View modal on show
  var vioModalEl = document.getElementById('violationViewModal');
  if (vioModalEl) {
    // Also support manual population via click handler
    // No-op here; we populate on click below then call showBsModal
  }
 
  // ===== EVENT HANDLERS - All handlers must be inside $(document).ready() =====
  
  // Initialize event handlers after DOM is ready
  console.log("Initializing event handlers...");
  
  // View button handler - use event delegation for dynamically added buttons
  $(document).off('click', '.view-activity').on('click', '.view-activity', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    try {
      var btn = $(this);
      console.log('View activity button clicked', btn.data());
      
      // Get data attributes with multiple fallbacks
      var userName = btn.data('user-name') || btn.attr('data-user-name') || this.getAttribute('data-user-name') || '-';
      var userId = btn.data('user-id') || btn.attr('data-user-id') || this.getAttribute('data-user-id') || '-';
      var college = btn.data('college') || btn.attr('data-college') || this.getAttribute('data-college') || '-';
      var date = btn.data('date') || btn.attr('data-date') || this.getAttribute('data-date') || '-';
      var pc = btn.data('pc') || btn.attr('data-pc') || this.getAttribute('data-pc') || '-';
      var pk = btn.data('pk') || btn.attr('data-pk') || this.getAttribute('data-pk');
      
      console.log('View data:', {userName, userId, college, date, pc, pk});
      
      // Populate modal fields
      var viewNameEl = document.getElementById('view_name');
      var viewIdEl = document.getElementById('view_id');
      var viewCollegeEl = document.getElementById('view_college');
      var viewDateEl = document.getElementById('view_date');
      var viewPcEl = document.getElementById('view_pc');
      
      if (viewNameEl) viewNameEl.textContent = userName;
      if (viewIdEl) viewIdEl.textContent = userId;
      if (viewCollegeEl) viewCollegeEl.textContent = college;
      if (viewDateEl) viewDateEl.textContent = date;
      if (viewPcEl) viewPcEl.textContent = pc;
      
      // Set suspend button data
      if (pk) {
        var suspendBtn = document.getElementById('suspend_from_view_btn');
        if (suspendBtn) {
          suspendBtn.setAttribute('data-suspend-pk', pk);
        }
      }
      
      // Show modal
      var modalEl = document.getElementById('activityViewModal');
      if (modalEl) {
        try {
          if (window.bootstrap && bootstrap.Modal) {
            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
            console.log('Activity modal shown');
          } else if (window.jQuery && $.fn.modal) {
            $(modalEl).modal('show');
            console.log('Activity modal shown via jQuery');
          } else {
            modalEl.style.display = 'block';
            modalEl.classList.add('show');
            document.body.classList.add('modal-open');
            console.log('Activity modal shown via fallback');
          }
        } catch (err) {
          console.error('Error showing activity modal:', err);
        }
      } else {
        console.error('activityViewModal element not found');
      }
    } catch (error) {
      console.error('Error in view activity handler:', error);
    }
    
    return false;
  });
  // Violation view click -> populate and show modal explicitly
  console.log("Setting up violation view handler...");
  $(document).off('click', '.view-violation').on('click', '.view-violation', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    var btn = $(this);
    var btnEl = this;
    console.log('View violation button clicked', btn.data());
    
    // Get data from button attributes (preferred) or fallback to row
    var userName = btn.attr('data-user-name') || btnEl.getAttribute('data-user-name') || '';
    var level = btn.attr('data-level') || btnEl.getAttribute('data-level') || '';
    var reason = btn.attr('data-reason') || btnEl.getAttribute('data-reason') || '';
    var time = btn.attr('data-time') || btnEl.getAttribute('data-time') || '';
    
    // Fallback to row data if button doesn't have attributes
    if (!userName || !level || !reason || !time) {
      var row = btn.closest('tr');
      userName = userName || row.attr('data-user-name') || '';
      level = level || row.attr('data-level') || '';
      reason = reason || row.attr('data-reason') || '';
      time = time || row.attr('data-time') || '';
    }
    
    console.log('Violation data:', {userName, level, reason, time});
    
    var vUserEl = document.getElementById('v_user');
    var vLevelEl = document.getElementById('v_level');
    var vReasonEl = document.getElementById('v_reason');
    var vTimeEl = document.getElementById('v_time');
    
    if (vUserEl) vUserEl.textContent = userName;
    if (vLevelEl) vLevelEl.textContent = level;
    if (vReasonEl) vReasonEl.textContent = reason;
    if (vTimeEl) vTimeEl.textContent = time;
    
    // Close dropdown first
    var dropdownToggle = btn.closest('.dropdown-menu').prev('.dropdown-toggle');
    if (dropdownToggle.length) {
      try {
        if (window.bootstrap && bootstrap.Dropdown) {
          var bsDropdown = bootstrap.Dropdown.getInstance(dropdownToggle[0]);
          if (bsDropdown) {
            bsDropdown.hide();
          }
        }
      } catch (err) {
        console.log('Could not close dropdown:', err);
      }
    }
    
    // Show modal
    var modalEl = document.getElementById('violationViewModal');
    if (modalEl) {
      try {
        if (window.bootstrap && bootstrap.Modal) {
          var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
          console.log('Violation modal shown');
        } else if (window.jQuery) {
          $(modalEl).modal('show');
          console.log('Violation modal shown via jQuery');
        }
      } catch (err) {
        console.error('Error showing violation modal:', err);
      }
    } else {
      console.error('violationViewModal not found');
    }
    
    return false;
  });
  // Unsuspend handler
  $(document).on('click', '.unsuspend-btn', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    var btn = $(this);
    var vpk = btn.data('vpk') || btn.attr('data-vpk');
    
    if (!vpk) {
      alert('Error: Violation ID not found');
      return false;
    }
    
    // Close dropdown first
    var dropdownToggle = btn.closest('.dropdown-menu').prev('.dropdown-toggle');
    if (dropdownToggle.length) {
      try {
        var bsDropdown = bootstrap.Dropdown.getInstance(dropdownToggle[0]);
        if (bsDropdown) {
          bsDropdown.hide();
        }
      } catch (err) {
        console.log('Could not close dropdown:', err);
      }
    }
    
    // Store the button reference and violation ID for the confirmation
    window.pendingUnsuspend = {
      vpk: vpk,
      btn: btn
    };
    
    // Set the violation ID in the confirm button
    $('#confirm-unsuspend-btn').attr('data-vpk', vpk);
    
    // Show confirmation modal
    var modalEl = document.getElementById('unsuspendConfirmModal');
    if (modalEl) {
      var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }
    
    return false;
  });
  
  // Confirm unsuspend handler
  $(document).on('click', '#confirm-unsuspend-btn', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    var vpk = $(this).attr('data-vpk');
    var pending = window.pendingUnsuspend;
    
    if (!vpk && pending) {
      vpk = pending.vpk;
    }
    
    if (!vpk) {
      alert('Error: Violation ID not found');
      return false;
    }
    
    var btn = pending ? pending.btn : null;
    
    // Close modal
    var modalEl = document.getElementById('unsuspendConfirmModal');
    if (modalEl) {
      var modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) {
        modal.hide();
      }
    }
    
    // Perform unsuspend
    $.ajax({
      url: "{% url 'main_app:violation-unsuspend' pk=0 %}".replace('/0/', '/' + vpk + '/'),
      type: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      success: function(){
        // Remove row (list shows only suspended)
        if (btn && btn.length) {
          var row = btn.closest('tr');
          row.fadeOut(200, function(){ $(this).remove(); });
        } else {
          // Fallback: reload page or remove by violation ID
          location.reload();
        }
      },
      error: function(xhr){
        alert('Error unsuspending: ' + (xhr.responseText || 'Unknown error'));
      }
    });
    
    // Clear pending
    window.pendingUnsuspend = null;
    
    return false;
  });

  // SUSPEND BUTTON handler - use event delegation for dynamically added buttons
  console.log("Setting up suspend button handler...");
  $(document).off('click', '.suspend-button').on('click', '.suspend-button', function(e){
    e.preventDefault();
    e.stopPropagation();
    
    try {
      var btn = $(this);
      var btnEl = this;
      
      // Get pk with multiple fallbacks
      var pk = btn.data('pk') || btn.attr('data-pk') || btnEl.getAttribute('data-pk');
      
      console.log('Suspend button clicked', {pk: pk, btn: btn, btnEl: btnEl});
      
      if (!pk) {
        console.error('Activity ID not found');
        alert('Error: Activity ID not found');
        return false;
      }
      
      // Set suspend button data
      var suspendSubmitBtn = document.getElementById('suspend-button-submit');
      if (suspendSubmitBtn) {
        suspendSubmitBtn.setAttribute('data-suspend-pk', pk);
        console.log('Set suspend button pk:', pk);
      } else {
        console.error('suspend-button-submit element not found');
      }
      
      // Show violation modal
      var modalEl = document.getElementById('violationModal');
      if (modalEl) {
        try {
          if (window.bootstrap && bootstrap.Modal) {
            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
            console.log('Violation modal shown');
          } else if (window.jQuery && $.fn.modal) {
            $(modalEl).modal('show');
            console.log('Violation modal shown via jQuery');
          } else {
            modalEl.style.display = 'block';
            modalEl.classList.add('show');
            document.body.classList.add('modal-open');
            console.log('Violation modal shown via fallback');
          }
        } catch (err) {
          console.error('Error showing violation modal:', err);
        }
      } else {
        console.error('violationModal element not found');
      }
    } catch (error) {
      console.error('Error in suspend button handler:', error);
    }
    
    return false;
  });
  // Suspend from view modal button
  $(document).off('click', '#suspend_from_view_btn').on('click', '#suspend_from_view_btn', function(){
    var pk = $(this).attr('data-suspend-pk');
    if (pk) {
      $('#suspend-button-submit').attr('data-suspend-pk', pk);
      hideBsModal('activityViewModal');
      showBsModal('violationModal');
    }
  });
  // Build URL via Django reverse pattern
  const suspendUrlTemplate = "{% url 'main_app:violation-suspend' pk=0 %}";
  function buildSuspendUrl(pk){
    // handle both trailing and no-trailing slash environments
    if (suspendUrlTemplate.endsWith('/0/')) { return suspendUrlTemplate.replace('/0/', '/' + pk + '/'); }
    return suspendUrlTemplate.replace('0', String(pk));
  }
  // Ensure single binding
  $(document).off('click', '#suspend-button-submit').on('click', '#suspend-button-submit', function(){
    var pk = $(this).attr('data-suspend-pk');
    let level = $('#violation-level').val();
    let reason = $('#reason-input').val();
    if (!reason) { alert('Please enter the reason.'); return; }
        $.ajax({
      url: buildSuspendUrl(pk),
      type: 'POST',
      data: { level: level, reason: reason },
      headers: { 'X-CSRFToken': csrftoken },
      success: function(){ hideBsModal('violationModal'); },
      error: function(xhr){
        console.error('Suspend error', xhr.status, xhr.responseText);
        alert('Error: ' + (xhr.responseText || 'Unable to suspend'));
            }
        });
    });

Â  // ... Your other existing jQuery/JS code that handles modal actions, 
Â  // WebSocket, and AJAX calls (e.g., suspend form submission, message sending) ...

  // Universal chat search for user list
  var chatSearch = document.getElementById('user-chat-search');
  if (chatSearch) {
    chatSearch.addEventListener('input', function() {
      var val = chatSearch.value.toLowerCase();
      document.querySelectorAll('.chat-user-row').forEach(function(row) {
        var email = row.querySelector('.chat-user-email').textContent.toLowerCase();
        var name = row.querySelector('.chat-user-name').textContent.toLowerCase();
        if (name.includes(val) || email.includes(val)) {
          row.style.display = '';
      } else {
          row.style.display = 'none';
        }
      });
    });
  }

  // Send initial message handler
  $(document).off('click', '#send_init_message').on('click', '#send_init_message', function() {
    let recipient = $("#recipient").val();
    let initMessage = $("#initMessage").val();
    if (!initMessage) { 
      alert("Message cannot be empty."); 
      return; 
    }
    $.ajax({
      url: $(this).data("send-init-message-url"),
      type: "POST",
      data: { recipient: recipient, message: initMessage },
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      },
      success: function () {
        hideBsModal('initMessageModal');
        resetInitMessageForm();
        loadMessages();
      },
      error: function (xhr) {
        let errorMsg = "Failed to send message.";
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg = xhr.responseJSON.error;
        } else if (xhr.responseText) {
          try {
            const errorData = JSON.parse(xhr.responseText);
            errorMsg = errorData.error || errorMsg;
          } catch(e) {
            errorMsg = xhr.responseText.substring(0, 100);
          }
        }
        alert("Error: " + errorMsg);
      }
    });
  });

  // Open conversation modal from messages list
  $(document).off('click', '.messagesItem').on('click', '.messagesItem', function() {
    var roomId = $(this).data('room-id');
    var receiverEmail = $(this).data('receiver-email');
    var receiverFirstname = $(this).data("receiver-fname");
    var receiverLastname = $(this).data("receiver-lname");
    var initiatorFirstname = $(this).data("initiator-fname");
    var initiatorLastname = $(this).data("initiator-lname");
    $("#receiverEmail").val(receiverEmail);
    $("#roomId").val(roomId);
    
    // Determine who we're chatting with
    if ("{{ request.user.email }}" === receiverEmail) {
      $("#convoWith").text(initiatorFirstname + ' ' + initiatorLastname);
    } else {
      $("#convoWith").text(receiverFirstname + ' ' + receiverLastname);
    }
    
    // Show modal first, then load conversation after modal is shown
    var modalEl = document.getElementById('conversationModal');
    if (modalEl) {
      var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
      
      // Wait for modal to be fully shown before loading conversation and connecting WebSocket
      modalEl.addEventListener('shown.bs.modal', function onShown() {
        console.log("Modal shown, loading conversation for room:", roomId);
        loadConversation(roomId);
        // Remove listener after first use
        modalEl.removeEventListener('shown.bs.modal', onShown);
      }, { once: true });
    } else {
      // Fallback
      showBsModal('conversationModal');
      setTimeout(function() {
        loadConversation(roomId);
      }, 300);
    }
  });
  
  // Open conversation in messenger layout (left list)
  $(document).off('click', '.convoItem').on('click', '.convoItem', function() {
    var roomId = $(this).data('room-id');
    var receiverFirstname = $(this).data("receiver-fname");
    var receiverLastname = $(this).data("receiver-lname");
    var initiatorFirstname = $(this).data("initiator-fname");
    var initiatorLastname = $(this).data("initiator-lname");
    $("#roomId").val(roomId);
    if ("{{ request.user.first_name }}" === receiverFirstname && "{{ request.user.last_name }}" === receiverLastname) {
      $("#convoWithInline").text(initiatorFirstname + ' ' + initiatorLastname);
    } else {
      $("#convoWithInline").text(receiverFirstname + ' ' + receiverLastname);
    }
    loadConversation(roomId);
  });
  
  // Close WebSocket when modal is closed
  $(document).on('hidden.bs.modal', '#conversationModal', function () {
    disconnectChatSocket();
  });

  // Send new message handler
  $(document).off('click', '#send_new_message_btn').on('click', '#send_new_message_btn', function() {
    let newMessage = $("#new_message").val();
    let roomId = $("#roomId").val();
    if (!newMessage) return;
    let completeUrl = `/ajax/send-new-message/${roomId}/`;
    $.ajax({ 
      url: completeUrl, 
      type: "POST", 
      data: { message: newMessage },
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      },
      success: function (response) {
        // Message will be added via WebSocket, but we add it optimistically
        // The WebSocket handler will prevent duplicates
        const chatContainer = $("#chatContainer");
        if (!chatContainer.find(`[data-temp-message="${newMessage}"]`).length) {
          chatContainer.append(`<div class="message sender" data-temp-message="${newMessage}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${newMessage}</div>`);
          chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        }
        $("#new_message").val("");
        loadMessages(); // Refresh conversation list for unread indicators
      },
      error: function (xhr) {
        let errorMsg = "Failed to send message.";
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg = xhr.responseJSON.error;
        } else if (xhr.responseText) {
          try {
            const errorData = JSON.parse(xhr.responseText);
            errorMsg = errorData.error || errorMsg;
          } catch(e) {
            errorMsg = xhr.responseText.substring(0, 100);
          }
        }
        alert("Error: " + errorMsg);
      }
    });
  });

  // Send new message handler (inline messenger)
  $(document).off('click', '#send_new_message_btn_inline').on('click', '#send_new_message_btn_inline', function() {
    let newMessage = $("#new_message_inline").val();
    let roomId = $("#roomId").val();
    if (!newMessage || !roomId) return;
    let completeUrl = `/ajax/send-new-message/${roomId}/`;
    $.ajax({
      url: completeUrl,
      type: "POST",
      data: { message: newMessage },
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      },
      success: function () {
        const chatContainer = $("#chatContainerInline");
        if (chatContainer.length && !chatContainer.find(`[data-temp-message="${newMessage}"]`).length) {
          chatContainer.append(`<div class="message sender" data-temp-message="${newMessage}" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;"><span style="font-size: small;">You</span><br>${newMessage}</div>`);
          chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        }
        $("#new_message_inline").val("");
        loadMessages();
      },
      error: function (xhr) {
        let errorMsg = "Failed to send message.";
        if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
        alert("Error: " + errorMsg);
      }
    });
  });

  // Confirm all handlers are initialized
  console.log("All event handlers initialized successfully");
  console.log("Page ready - handlers should be working now");

  }); // End of $(document).ready()
</script>
{% endblock %}