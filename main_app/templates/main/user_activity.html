{% extends "base.html" %}
{% load static %}

{% block title %}Users{% endblock %}

{% block links %}
<style>
.level {
  /* Remove black background for colored dots */
  background-color: transparent;
  border-radius: 50%;
}

.level.level-minor,
.level-minor {
  color: #ffc107 !important; /* yellow - vibrant */
}

.level.level-moderate,
.level-moderate {
  color: #fd7e14 !important; /* orange - vibrant */
}

.level.level-major,
.level-major {
  color: #dc3545 !important; /* red - vibrant */
}
#chatContainer {
  height: 400px;          /* fixed height */
  overflow-y: auto;       /* makes it scrollable */
  border: 1px solid #ccc;
  border-radius: 5px;
  padding: 10px;
  background: #f9f9f9;
  margin-bottom: 3px;
}

.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 70%;
}

/* Sender: left side */
.sender {
  background: #DCF8C6;
  align-self: flex-start;
}

/* Receiver: right side */
.receiver {
  background: #E5E5EA;
  align-self: flex-end;
}
.actions-cell { white-space: nowrap; width: 1%; }
</style>
{% endblock %}

{% block content %}
<div class="container pt-5 mt-2" id="user-activities-container" data-user-role="{{ request.user.profile.role }}">
  {% if request.user.profile.role == 'staff' %}
  <div class="row mb-3">
    <div class="col-md-6"></div>
    <div class="col-md-6 d-flex justify-content-end" id="violation-level-legend">
      <div class="bg-light p-3 rounded shadow text-center" style="min-width: 280px;">
        <h6 class="mb-3">Violation Level</h6>
        <div class="d-flex justify-content-around align-items-center">
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">minor</span>
            <i class="fa-solid fa-circle shadow level level-minor" style="font-size: 1.2em;"></i>
          </div>
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">moderate</span>
            <i class="fa-solid fa-circle shadow level level-moderate" style="font-size: 1.2em;"></i>
          </div>
          <div class="d-flex flex-column align-items-center">
            <span class="mb-1">major</span>
            <i class="fa-solid fa-circle shadow level level-major" style="font-size: 1.2em;"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

    <div class="nav nav-tabs tabs" id="myTab">
    {% if request.user.profile.role == 'staff' %}
    <button id="tabHistory" class="nav-link active tab">History</button>
    <button id="tabChats" class="nav-link tab">Chats</button>
    <button id="tabViolation" class="nav-link tab">Violation</button>
    {% endif %}
  </div>

    <div id="tab-history" class="subcontent">
    <h5 class="mt-3">Booking History</h5>
    <table class="table">
        <thead>
            <tr><th>Name</th><th>ID</th><th>College</th><th>Date</th><th>PC</th><th>Action</th></tr>
        </thead>
      <tbody>
        {% for activity in user_activities %}
        <tr>
          <td>{{ activity.user.get_full_name }}</td>
          <td>{{ activity.user.profile.school_id }}</td>
          <td>{{ activity.user.profile.college.name }}</td>
          <td>{{ activity.created_at }}</td>
          <td>{{ activity.pc.name }}</td>
                <td class="actions-cell">
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-success view-activity"
                            data-user-name="{{ activity.user.get_full_name }}"
                            data-user-id="{{ activity.user.profile.school_id }}"
                            data-college="{{ activity.user.profile.college.name }}"
                            data-date="{{ activity.created_at }}"
                            data-pc="{{ activity.pc.name }}">
                          View
                        </button>
                      <button type="button" class="btn btn-danger suspend-button" data-pk="{{ activity.pk }}">
                          Suspend
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>

    <div id="tab-chats" class="subcontent" hidden>
    <h5 class="mt-3">All Users & Chats</h5>
    <div class="mb-3">
      <input type="text" id="user-chat-search" class="form-control" placeholder="Search user...">
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover"> 
        <thead>
          <tr><th>Name</th><th>Email</th><th>College</th><th>Actions</th></tr>
        </thead>
        <tbody>
        {% for user in users %}
          <tr class="chat-user-row">
            <td class="chat-user-name">{{ user.get_full_name|default:user.username }}</td>
            <td class="chat-user-email">{{ user.email }}</td>
            <td>{{ user.profile.college.name|default:'-' }}</td>
            <td>
              <button type="button" class="btn btn-sm btn-outline-primary start-chat-btn" data-recipient-email="{{ user.email }}" data-recipient-name="{{ user.first_name }} {{ user.last_name }}">
                <i class="fa-solid fa-comments"></i> Chat
              </button>
          </td>
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-responsive mt-4">
      <h6>Your Conversations</h6>
      <table class="table table-striped table-sm" id="messagesTable">
        <thead><tr><th>With</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

    <div id="tab-violation" class="subcontent" hidden>
    <h5 class="mt-3">Violations</h5>
    <table class="table">
      <thead>
        <tr><th>Name</th><th>Level</th><th>Description</th><th>Date/Time</th><th>Status</th><th>Action</th></tr>
      </thead>
      <tbody>
        {% for violation in violations %}
        <tr data-violation-id="{{ violation.id }}" data-user-name="{{ violation.user.get_full_name }}" data-level="{{ violation.level }}" data-reason="{{ violation.reason }}" data-time="{{ violation.timestamp }}">
          <td>{{ violation.user.get_full_name }}</td>
          <td>
            <i class="fa-solid fa-circle shadow
            {% if violation.level == 'minor' %}level level-minor{% elif violation.level == 'moderate' %}level level-moderate{% elif violation.level == 'major' %}level level-major{% endif %}"></i>
          </td>
          <td class="vio-reason">{{ violation.reason }}</td>
          <td class="vio-time">{{ violation.timestamp }}</td>
          <td class="vio-status"><span class="badge {% if violation.status == 'suspended' %}text-bg-danger{% else %}text-bg-secondary{% endif %} shadow">{{ violation.status }}</span></td>
          <td class="actions-cell">
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-secondary view-violation">View</button>
              {% if violation.status == 'suspended' %}
              <button type="button" class="btn btn-outline-success unsuspend-btn" data-vpk="{{ violation.id }}">Unsuspend</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

      <div class="modal fade" id="activityViewModal" tabindex="-1" aria-labelledby="activityViewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="activityViewModalLabel">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div><strong>Name:</strong> <span id="view_name"></span></div>
          <div><strong>ID:</strong> <span id="view_id"></span></div>
          <div><strong>College:</strong> <span id="view_college"></span></div>
          <div><strong>Date:</strong> <span id="view_date"></span></div>
          <div><strong>PC:</strong> <span id="view_pc"></span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

        <div class="modal fade" id="violationModal" tabindex="-1" aria-labelledby="violationModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content rounded-3 shadow">
              <div class="modal-header">
          <h5 class="modal-title" id="violationModalLabel">Add more info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="justify-content-center" style="max-width:200px; margin:auto;">
                  <div class="form-group mt-3">
                    <label for="violation-level" class="form-label">Level:</label>
                    <select id="violation-level" name="violation-level" class="form-control">
                      <option value="minor">Minor</option>
                      <option value="moderate">Moderate</option>
                      <option value="major">Major</option>
                    </select>
                  </div>
                  <div class="form-group mt-3">
                    <label for="reason-input" class="form-label">Description:</label>
                    <input type="text" id="reason-input" class="form-control">
                  </div>
                </div>
              </div>
              <div class="modal-footer">
          <button type="button" id="suspend-button-submit" class="btn btn-danger" data-suspend-pk="">
                  Suspend
                </button>
              </div>
            </div>
          </div>
        </div>

    <div class="modal fade" id="initMessageModal" tabindex="-1" aria-labelledby="initMessageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
          <h5 class="modal-title" id="initMessageModalLabel">Start New Conversation</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
          <div class="mb-3">
            <label for="recipient" class="form-label">Recipient Email:</label>
            <input type="email" id="recipient" class="form-control" disabled>
              </div>
          <div class="mb-3">
                <label for="initMessage" class="form-label">Message:</label>
            <textarea id="initMessage" class="form-control"></textarea>
            </div>
          </div>
          <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="send_init_message" class="btn btn-primary" data-send-init-message-url="{% url 'main_app:send-init-message' %}">Send</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
          <h5 class="modal-title" id="conversationModalLabel">Conversation with: <span id="convoWith"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
          <div id="chatContainer">
              </div>
          <div class="mt-3 d-flex">
            <input type="text" class="form-control me-2" id="new_message" placeholder="Type your message...">
            <button type="button" class="btn btn-primary" id="send_new_message_btn">Send</button>
            </div>
          </div>
        <input type="hidden" id="roomId" value="">
        <input type="hidden" id="receiverId" value="">
          </div>
        </div>
      </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <script>
// NOTE: I've only included the necessary functions and logic for the tabs here. 
// Your original chat, AJAX, and other functions are assumed to be in the same script block.

  // --- START of Generic Functions (Kept from your original script) ---
  const senderId = "{{ request.user.id }}"; 
  const currentUserId = "{{ request.user.id }}";
  const currentUserRole = $("#user-activities-container").data("user-role");
  let chatSocket = null; // defer websocket until a room is opened

  // CSRF helper uses cookie set by Django
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Bootstrap 5 modal helpers
  function showBsModal(modalId) {
    var el = document.getElementById(modalId);
    if (!el) return;
    var modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }
  function hideBsModal(modalId) {
    var el = document.getElementById(modalId);
    if (!el) return;
    var modal = bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el);
    modal.hide();
  }

  // Placeholder for email variable used in global scope
  let email = null;

  // All your other AJAX, loadMessages, loadConversation, etc. functions go here...
  // I'm skipping them for brevity since you only asked for the tab structure fix.
  // Ensure functions like `loadMessages()` are defined for the `tabChats` logic.

  function loadMessages() { /* ... Your implementation for loading messages table ... */ }
  // ... other functions ...

  // Function to set up the chat modal for a new message
  $(document).on('click', '.start-chat-btn', function(){
    const recipientEmail = $(this).data('recipient-email');
    const recipientName = $(this).data('recipient-name');
    $('#recipient').val(recipientEmail).prop('disabled', true);
    $('#initMessageModalLabel').text(`Start New Conversation with ${recipientName}`);
    showBsModal('initMessageModal');
  });

  // --- END of Generic Functions ---


document.addEventListener('DOMContentLoaded', function() {
  // === Generic Tab Switcher (Vanilla JS) ===
  // This is the logic copied from your sample, simplified for clarity
  function initTabGroup(tabSelectors, contentSelectors, onSwitch) {
    const tabs = document.querySelectorAll(tabSelectors);
    const contents = document.querySelectorAll(contentSelectors);
    tabs.forEach(function(tab, index) {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        // Switch active tab
        tabs.forEach(function(t){ t.classList.remove('active'); });
        tab.classList.add('active');
        // Switch content
        contents.forEach(function(c){ c.hidden = true; });
        if (contents[index]) { contents[index].hidden = false; }
        if (typeof onSwitch === 'function') { onSwitch(tab.id); }
      });
    });
    // On load: ensure the first content is visible and the first tab is active
    contents.forEach(function(c,i){ c.hidden = i !== 0; });
    tabs.forEach(function(t,i){ i===0?t.classList.add('active'):t.classList.remove('active'); });
  }
  
  // === Main Tabs Activation ===
  initTabGroup(
    '#tabHistory, #tabChats, #tabViolation', 
    '#tab-history, #tab-chats, #tab-violation', 
    function(activeId) {
      if (activeId === 'tabChats') { 
        // Load conversation list when the Chats tab is opened
        loadMessages(); 
      }
    }
  );

  // Populate Violation View modal on show
  var vioModalEl = document.getElementById('violationViewModal');
  if (vioModalEl) {
    // Also support manual population via click handler
    // No-op here; we populate on click below then call showBsModal
  }
 
  // View button handler
  $(document).on('click', '.view-activity', function(){
    $('#view_name').text($(this).data('user-name'));
    $('#view_id').text($(this).data('user-id'));
    $('#view_college').text($(this).data('college'));
    $('#view_date').text($(this).data('date'));
    $('#view_pc').text($(this).data('pc'));
    showBsModal('activityViewModal');
  });
  // Violation view click -> populate and show modal explicitly
  $(document).on('click', '.view-violation', function(){
    var row = $(this).closest('tr');
    document.getElementById('v_user').textContent = row.attr('data-user-name') || '';
    document.getElementById('v_level').textContent = row.attr('data-level') || '';
    document.getElementById('v_reason').textContent = row.attr('data-reason') || '';
    document.getElementById('v_time').textContent = row.attr('data-time') || '';
    showBsModal('violationViewModal');
  });
  // Unsuspend handler
  $(document).on('click', '.unsuspend-btn', function(){
    var vpk = $(this).data('vpk');
    var btn = $(this);
    $.ajax({
      url: "{% url 'main_app:violation-unsuspend' pk=0 %}".replace('/0/', '/' + vpk + '/'),
      type: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      success: function(){
        // Remove row (list shows only suspended)
        var row = btn.closest('tr');
        row.fadeOut(200, function(){ $(this).remove(); });
      },
      error: function(xhr){
        alert('Error unsuspending: ' + (xhr.responseText || 'Unknown error'));
      }
    });
  });

  // SUSPEND BUTTON handler
  $(document).on('click', '.suspend-button', function(){
    var pk = $(this).data('pk');
    $('#suspend-button-submit').attr('data-suspend-pk', pk);
    showBsModal('violationModal');
  });
  // Build URL via Django reverse pattern
  const suspendUrlTemplate = "{% url 'main_app:violation-suspend' pk=0 %}";
  function buildSuspendUrl(pk){
    // handle both trailing and no-trailing slash environments
    if (suspendUrlTemplate.endsWith('/0/')) { return suspendUrlTemplate.replace('/0/', '/' + pk + '/'); }
    return suspendUrlTemplate.replace('0', String(pk));
  }
  // Ensure single binding
  $(document).off('click', '#suspend-button-submit').on('click', '#suspend-button-submit', function(){
    var pk = $(this).attr('data-suspend-pk');
    let level = $('#violation-level').val();
    let reason = $('#reason-input').val();
    if (!reason) { alert('Please enter the reason.'); return; }
        $.ajax({
      url: buildSuspendUrl(pk),
      type: 'POST',
      data: { level: level, reason: reason },
      headers: { 'X-CSRFToken': csrftoken },
      success: function(){ hideBsModal('violationModal'); },
      error: function(xhr){
        console.error('Suspend error', xhr.status, xhr.responseText);
        alert('Error: ' + (xhr.responseText || 'Unable to suspend'));
            }
        });
    });

  // ... Your other existing jQuery/JS code that handles modal actions, 
  // WebSocket, and AJAX calls (e.g., suspend form submission, message sending) ...

  // Universal chat search for user list
  var chatSearch = document.getElementById('user-chat-search');
  if (chatSearch) {
    chatSearch.addEventListener('input', function() {
      var val = chatSearch.value.toLowerCase();
      document.querySelectorAll('.chat-user-row').forEach(function(row) {
        var email = row.querySelector('.chat-user-email').textContent.toLowerCase();
        var name = row.querySelector('.chat-user-name').textContent.toLowerCase();
        if (name.includes(val) || email.includes(val)) {
          row.style.display = '';
      } else {
          row.style.display = 'none';
        }
      });
    });
  }

  });
</script>
{% endblock %}