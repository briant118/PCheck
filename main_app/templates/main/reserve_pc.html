{% extends 'base.html' %}
{% load template_filters %}
{% load math_filters %}
{% load static %}

{% block title %}PC List{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/booking.css' %}?v=10">
<style>
  /* PC View Background - No Image */
  body:not(:has(.sidebar)) .main-content {
    background: #F5F5DC;
    min-height: 100vh;
    position: relative;
    width: 100% !important;
    overflow-x: hidden;
    margin-left: 0 !important;
  }


  /* Ensure content is above background */
  body:not(:has(.sidebar)) .main-content > * {
    position: relative;
    z-index: 1;
  }

  /* Fix login button positioning in sidebar */
  .sidebar-bottom {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
  }

  @media (max-width: 991.98px) {
    body:not(:has(.sidebar)) .main-content {
      background: #F5F5DC;
      width: 100% !important;
      margin-left: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
  }
</style>
{% endblock %}

{% block extra_head %}
<script>
// Define showPCStatus immediately so it's available for inline onclick handlers
// This must be defined before the HTML that uses it
window.showPCStatus = function(pcId, button) {
  console.log('Checking PC status:', pcId);
  
  // Get PC status from button data attributes
  const pcStatus = button.getAttribute('data-pc-status');
  const pcCondition = button.getAttribute('data-pc-condition');
  const pcBookingStatus = button.getAttribute('data-booking-status');
  const pcName = button.getAttribute('data-pc-name');
  
  // Get modal elements
  const modal = document.getElementById('pcStatusModal');
  const modalLabel = document.getElementById('pcStatusModalLabel');
  const modalHeader = document.getElementById('pcStatusModalHeader');
  const modalBody = document.getElementById('pcStatusContent');
  const endSessionBtn = document.getElementById('pc-status-end-session-btn');
  
  // Check if modal elements exist
  if (!modal || !modalLabel || !modalHeader || !modalBody) {
    console.error('PC Status modal elements not found');
    alert('Error: PC Status modal not found. Please refresh the page.');
    return false;
  }
  
  // Hide end session button by default
  if (endSessionBtn) {
    endSessionBtn.style.display = 'none';
    endSessionBtn.setAttribute('data-booking-id', '');
  }
  
  // Check if PC is in repair
  if (pcCondition === 'repair') {
    modalLabel.innerHTML = '<i class="fa-solid fa-tools"></i> PC In Repair';
    modalHeader.className = 'modal-header bg-danger text-white';
    modalBody.innerHTML = `
      <div class="mb-3">
        <i class="fa-solid fa-tools" style="font-size: 3rem; color: #dc3545;"></i>
      </div>
      <h4>PC ${pcName}</h4>
      <p class="text-muted">This PC is currently in repair and not available for reservation until maintenance is complete.</p>
    `;
    if (modal && typeof bootstrap !== 'undefined') {
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    }
    return false;
  }
  
  // Check if PC is offline/disconnected
  if (pcStatus === 'disconnected') {
    modalLabel.innerHTML = '<i class="fa-solid fa-plug"></i> PC Offline';
    modalHeader.className = 'modal-header bg-secondary text-white';
    modalBody.innerHTML = `
      <div class="mb-3">
        <i class="fa-solid fa-plug" style="font-size: 3rem; color: #6c757d;"></i>
      </div>
      <h4>PC ${pcName}</h4>
      <p class="text-muted">This PC is currently offline and not available for reservation until it is connected.</p>
    `;
    if (modal && typeof bootstrap !== 'undefined') {
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    }
    return false;
  }
  
  // Fetch booking information for this PC
  fetch(`/ajax/get-pc-booking/${pcId}/`)
    .then(response => response.json())
    .then(data => {
      console.log('PC booking data:', data);
      
      // Update button's data-booking-status if it's different
      if (data.booking_status && data.booking_status !== pcBookingStatus) {
        button.setAttribute('data-booking-status', data.booking_status);
        // Update button class if needed
        button.classList.remove('pc-used', 'pc-queue', 'pc-available');
        if (data.booking_status === 'in_use') {
          button.classList.add('pc-used');
        } else if (data.booking_status === 'in_queue') {
          button.classList.add('pc-queue');
        } else {
          button.classList.add('pc-available');
        }
      }
      
      // Populate modal based on status
      if (data.booking_status === 'in_queue') {
        const isCurrentUser = data.is_current_user || false;
        modalLabel.innerHTML = '<i class="fa-solid fa-hourglass-half"></i> PC In Queue';
        modalHeader.className = 'modal-header bg-warning text-dark';
        modalBody.innerHTML = `
          <div class="mb-3">
            <i class="fa-solid fa-hourglass-half" style="font-size: 3rem; color: #ffc107;"></i>
          </div>
          <h4>PC ${data.pc_name}</h4>
          <p class="text-muted">This PC is waiting for staff approval.</p>
          <p><strong>Request made at:</strong><br>${data.created_time || 'Unknown'}</p>
        `;
        // Show "End Session" button if current user has this PC in queue
        if (endSessionBtn && isCurrentUser && data.booking_id) {
          endSessionBtn.setAttribute('data-booking-id', data.booking_id);
          window.currentBookingId = data.booking_id;
          endSessionBtn.style.display = 'block';
          // Set onclick handler
          endSessionBtn.onclick = function(e) {
            if (e) {
              e.preventDefault();
              e.stopPropagation();
            }
            return window.handleEndSession(e);
          };
          console.log('End Session button shown for current user (in queue), booking_id:', data.booking_id);
        } else if (endSessionBtn) {
          endSessionBtn.style.display = 'none';
        }
      } else if (data.booking_status === 'in_use') {
        const timeLeft = data.time_remaining || 'Unknown';
        const userName = data.user || 'Another student';
        const isCurrentUser = data.is_current_user || false;
        modalLabel.innerHTML = '<i class="fa-solid fa-user-clock"></i> PC In Use';
        modalHeader.className = 'modal-header bg-info text-white';
        modalBody.innerHTML = `
          <div class="mb-3">
            <i class="fa-solid fa-user-clock" style="font-size: 3rem; color: #0dcaf0;"></i>
          </div>
          <h4>PC ${data.pc_name}</h4>
          <p class="text-muted">This PC is currently in use by <strong>${userName}</strong>.</p>
          <div class="mt-3">
            <p><strong>Estimated time remaining:</strong></p>
            <h3 class="text-primary">${timeLeft}</h3>
          </div>
        `;
        
        // Show "End Session" button if current user is the one using this PC
        if (endSessionBtn && isCurrentUser && data.booking_id) {
          endSessionBtn.setAttribute('data-booking-id', data.booking_id);
          window.currentBookingId = data.booking_id;
          endSessionBtn.style.display = 'block';
          // Set onclick handler
          endSessionBtn.onclick = function(e) {
            if (e) {
              e.preventDefault();
              e.stopPropagation();
            }
            return window.handleEndSession(e);
          };
          console.log('End Session button shown for current user, booking_id:', data.booking_id);
        } else if (endSessionBtn) {
          endSessionBtn.style.display = 'none';
        }
      } else {
        modalLabel.innerHTML = '<i class="fa-solid fa-check-circle"></i> PC Available';
        modalHeader.className = 'modal-header bg-success text-white';
        modalBody.innerHTML = `
          <div class="mb-3">
            <i class="fa-solid fa-check-circle" style="font-size: 3rem; color: #198754;"></i>
          </div>
          <h4>PC ${data.pc_name}</h4>
          <p class="text-muted">This PC is available for reservation.</p>
        `;
        // Hide end session button for available PCs
        if (endSessionBtn) {
          endSessionBtn.style.display = 'none';
        }
      }
      
      // Show modal
      if (modal && typeof bootstrap !== 'undefined') {
        try {
          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          console.log('PC Status modal shown');
        } catch (error) {
          console.error('Error showing PC Status modal:', error);
          alert('Error showing PC status. Please refresh the page.');
        }
      } else {
        console.error('Bootstrap not available or modal not found');
        alert('Error: Unable to show PC status. Please refresh the page.');
      }
    })
    .catch(error => {
      console.error('Error fetching PC status:', error);
      modalLabel.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Error';
      modalHeader.className = 'modal-header bg-danger text-white';
      modalBody.innerHTML = `
        <div class="mb-3">
          <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
        </div>
        <p class="text-danger">Unable to fetch PC status information.</p>
      `;
      if (modal && typeof bootstrap !== 'undefined') {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
      }
    });
  
  return false;
};

// Shared helper to show/hide selected PC indicator
window.updateSelectedPcIndicator = function(pcName) {
  var indicator = document.getElementById('selected-pc-indicator');
  var nameEl = document.getElementById('selected-pc-name');
  if (!indicator || !nameEl) {
    return;
  }

  if (pcName) {
    indicator.removeAttribute('hidden');
    indicator.style.display = 'flex';
    indicator.style.visibility = 'visible';
    nameEl.textContent = pcName;
  } else {
    indicator.setAttribute('hidden', 'true');
    indicator.style.display = 'none';
    indicator.style.visibility = 'hidden';
    nameEl.textContent = '';
  }
};

// Define handleEndSession immediately so it's available for showPCStatus
// This must be defined before the HTML that uses it
window.handleEndSession = function(e) {
  if (e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  // Try multiple sources for booking_id
  // First try to get from the button that was clicked
  var btn = e ? e.target : null;
  if (!btn || !btn.getAttribute('data-booking-id')) {
    // Try the pc-status-end-session-btn
    btn = document.getElementById('pc-status-end-session-btn');
  }
  if (!btn || !btn.getAttribute('data-booking-id')) {
    // Try the end-session-btn
    btn = document.getElementById('end-session-btn');
  }
  
  var bookingId = window.currentBookingId || 
                  (btn ? btn.getAttribute('data-booking-id') : null) ||
                  (btn ? btn.dataset.bookingId : null);
  
  console.log('End session clicked');
  console.log('Current booking ID from window.currentBookingId:', window.currentBookingId);
  console.log('Current booking ID from button data attribute:', btn ? btn.getAttribute('data-booking-id') : 'button not found');
  console.log('Final booking ID to use:', bookingId);
  
  if (!bookingId || bookingId === '' || bookingId === 'null' || bookingId === 'undefined') {
    console.error('Booking ID not found. All sources checked.');
    alert('Error: Booking ID not found. Please check your session and try again.');
    return false;
  }
  
  // Ensure bookingId is a string/number, not null/undefined
  bookingId = String(bookingId).trim();
  
  // Validate bookingId is a valid number
  if (!bookingId || isNaN(parseInt(bookingId))) {
    console.error('Invalid booking ID format:', bookingId);
    alert('Error: Invalid booking ID format. Please refresh the page and try again.');
    return false;
  }
  
  if (confirm('Are you sure you want to end your session early?')) {
    var url = '/ajax/end-session/' + bookingId + '/';
    console.log('Calling end session URL:', url);
    
    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '',
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      console.log('Response status:', response.status);
      if (!response.ok) {
        return response.text().then(text => {
          console.error('Error response:', text);
          throw new Error('HTTP error! status: ' + response.status + ' - ' + text);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log('End session response:', data);
      if (data.success) {
        alert(data.message || 'Session ended successfully');
        // Close the modal if it's open
        var modal = bootstrap.Modal.getInstance(document.getElementById('mySessionModal'));
        if (modal) {
          modal.hide();
        }
        var pcStatusModal = bootstrap.Modal.getInstance(document.getElementById('pcStatusModal'));
        if (pcStatusModal) {
          pcStatusModal.hide();
        }
        location.reload();
      } else {
        alert('Error: ' + (data.error || data.message || 'Failed to end session'));
      }
    })
    .catch(error => {
      console.error('Error ending session:', error);
      alert('Error: Failed to end session. ' + error.message + '\nPlease check console for details.');
    });
  }
  return false;
};

// Define selectPCForReservation immediately so it's available for inline onclick handlers
// This must be defined before the HTML that uses it
window.selectPCForReservation = function(pcId, button) {
  console.log('PC clicked:', pcId);
  
  // Check if button is disabled - if so, prevent selection
  if (button.disabled || button.hasAttribute('disabled')) {
    console.warn('Button is disabled, ignoring click');
    return;
  }
  
  // Get PC status from button data attributes
  const pcStatus = button.getAttribute('data-pc-status');
  const pcCondition = button.getAttribute('data-pc-condition');
  const pcBookingStatus = button.getAttribute('data-booking-status');
  const pcName = button.getAttribute('data-pc-name');
  
  // Double-check if PC is in repair (safety check)
  if (pcCondition === 'repair') {
    alert(`PC ${pcName} is currently in repair.\n\nThis PC is not available for reservation until maintenance is complete.`);
    if (typeof window.updateSelectedPcIndicator === 'function') {
      window.updateSelectedPcIndicator(null);
    }
    button.disabled = true;
    button.style.pointerEvents = 'none';
    button.style.opacity = '0.6';
    return;
  }
  
  // Double-check if PC is offline/disconnected (safety check)
  if (pcStatus === 'disconnected') {
    alert(`PC ${pcName} is currently offline.\n\nThis PC is not available for reservation until it is connected.`);
    if (typeof window.updateSelectedPcIndicator === 'function') {
      window.updateSelectedPcIndicator(null);
    }
    button.disabled = true;
    button.style.pointerEvents = 'none';
    button.style.opacity = '0.6';
    return;
  }
  
  // Check if PC is already booked
  if (pcBookingStatus === 'in_use' || pcBookingStatus === 'in_queue') {
    alert(`PC ${pcName} is currently ${pcBookingStatus.replace('_', ' ')}.\n\nThis PC is not available for reservation.`);
    button.disabled = true;
    return;
  }
  
  // Toggle the selected class - handle both old and new button styles
  var isSelected;
  if (button.classList.contains('pc-button-modern')) {
    button.classList.toggle('selected');
    button.classList.toggle('pc-selected');
    isSelected = button.classList.contains('selected');
  } else {
    button.classList.toggle('text-success');
    isSelected = button.classList.contains('text-success');
  }
  
  // Set the hidden PC ID field
  var pcIdInput = document.getElementById('pc_id');
  if (pcIdInput) {
    pcIdInput.value = pcId;
  }
  
  // Toggle selected class and disable other PC buttons
  var allButtons = document.querySelectorAll('.pc-button-modern, .pc-button');
  allButtons.forEach(function(btn) {
    if (btn !== button) {
      btn.classList.remove('selected', 'pc-selected');
      if (isSelected) {
        btn.disabled = true;
      } else {
        btn.disabled = false;
      }
    } else {
      if (isSelected) {
        button.classList.add('selected', 'pc-selected');
      } else {
        button.classList.remove('selected', 'pc-selected');
      }
    }
  });
  
  // Show/hide pagination
  var pageNav = document.getElementById('page-nav');
  var paginationModern = document.querySelector('.pagination-modern');
  if (pageNav) {
    pageNav.hidden = isSelected;
  }
  if (paginationModern) {
    paginationModern.style.display = isSelected ? 'none' : 'flex';
  }
  
  // Show/hide Next button - only if PC is truly available
  var nextButton = document.querySelector('.reserve-next-button');
  if (nextButton) {
    // Keep button always visible; enable only if valid selection
    var isAvailable = pcBookingStatus !== 'in_use' &&
                      pcBookingStatus !== 'in_queue' &&
                      pcCondition !== 'repair' &&
                      pcStatus !== 'disconnected';
    var canProceed = isSelected && isAvailable;
    nextButton.disabled = !canProceed;
    if (canProceed) {
      nextButton.removeAttribute('aria-disabled');
    } else {
      nextButton.setAttribute('aria-disabled', 'true');
    }
    console.log('Next button state', { canProceed, isSelected, pcBookingStatus, pcCondition, pcStatus });
  } else {
    console.warn('Next button not found!');
  }
  
  // Show/hide Block button
  var blockButton = document.getElementById('block-button');
  if (blockButton) {
    blockButton.hidden = isSelected;
  }
  
  if (typeof window.updateSelectedPcIndicator === 'function') {
    window.updateSelectedPcIndicator(isSelected ? (pcName || `PC ${pcId}`) : null);
  }

  console.log('PC selection complete. Selected:', isSelected);
};
</script>
{% endblock %}

{% block content %}
<div class="mobile-reservation-container">
  <!-- Available PC's Card Section - At the Top -->
  <div class="available-pcs-card">
    <div class="available-pcs-header">
      <h2 class="available-pcs-title">Available PC's</h2>
      <div class="available-count-badge">
        <span class="available-count-number" id="available-count">{{ available_count|default:"0" }}</span>
        <span class="available-count-label">Available</span>
      </div>
    </div>
    <div class="reservation-datetime" id="current-datetime">
      <i class="fa-solid fa-clock"></i>
      <script>
        (function() {
          var now = new Date();
          var months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
          var month = months[now.getMonth()];
          var day = now.getDate();
          var year = now.getFullYear();
          var hours = now.getHours();
          var minutes = now.getMinutes();
          var ampm = hours >= 12 ? 'PM' : 'AM';
          hours = hours % 12;
          hours = hours ? hours : 12;
          minutes = minutes < 10 ? '0' + minutes : minutes;
          var dateTime = month + ' ' + day + ', ' + year + ' | ' + hours + ':' + minutes + ' ' + ampm;
          document.getElementById('current-datetime').innerHTML = '<i class="fa-solid fa-clock"></i> ' + dateTime;
        })();
      </script>
    </div>
    
    <!-- Status Legend Section -->
    <div class="status-legend-inline">
      <div class="legend-item available">
        <div class="legend-icon">
          <i class="fa-solid fa-desktop"></i>
        </div>
        <span class="legend-text">Available</span>
      </div>
      <div class="legend-item selected">
        <div class="legend-icon">
          <i class="fa-solid fa-desktop"></i>
        </div>
        <span class="legend-text">Selected</span>
      </div>
      <div class="legend-item queue">
        <div class="legend-icon">
          <i class="fa-solid fa-desktop"></i>
        </div>
        <span class="legend-text">In Queue</span>
      </div>
      <div class="legend-item used">
        <div class="legend-icon">
          <i class="fa-solid fa-desktop"></i>
        </div>
        <span class="legend-text">Used</span>
      </div>
      <div class="legend-item repair">
        <div class="legend-icon">
          <i class="fa-solid fa-desktop"></i>
        </div>
        <span class="legend-text">Repair</span>
      </div>
    </div>
  </div>
  
  <div class="reservation-card">
    <div class="reservation-body">
      <input type="hidden" id="pc_id" name="pc_id">

      <div id="students-booking"> <!-- students-booking -->
        {% if not available_pcs %}
        <div class="alert alert-warning text-center">
          <p>No PCs found. Please add some PCs first in the PC List page.</p>
          <a href="{% url 'main_app:pc-list' %}" class="btn btn-primary">Go to PC List</a>
        </div>
        {% else %}
        <div class="pc-grid">
          {% for pc in available_pcs %}
            <div class="pc-item">
              <button class="pc-button-modern 
                {% if pc.system_condition == 'repair' %}pc-repair
                {% elif pc.status == 'disconnected' %}pc-offline
                {% elif pc.booking_status == 'in_use' %}pc-used
                {% elif pc.booking_status == 'in_queue' %}pc-queue
                {% else %}pc-available{% endif %}" 
                data-pc-id="{{ pc.id }}" 
                data-pc-name="{{ pc.name }}"
                data-pc-status="{{ pc.status }}"
                data-pc-condition="{{ pc.system_condition }}"
                data-booking-status="{{ pc.booking_status }}"
                {% if pc.system_condition == 'repair' or pc.status == 'disconnected' %}
                  onclick="event.preventDefault(); event.stopPropagation(); showPCStatus({{ pc.id }}, this);"
                  disabled
                  style="cursor: not-allowed !important; opacity: 0.6 !important; pointer-events: none;"
                  title="{% if pc.system_condition == 'repair' %}PC is in repair and not available{% elif pc.status == 'disconnected' %}PC is offline and not available{% endif %}"
                  tabindex="-1"
                {% elif pc.booking_status == 'in_use' or pc.booking_status == 'in_queue' %}
                  onclick="showPCStatus({{ pc.id }}, this); return false;"
                  style="cursor: pointer;"
                {% else %}
                  onclick="selectPCForReservation({{ pc.id }}, this);"
                {% endif %}>
                <i class="fa-solid fa-desktop pc-icon-modern"></i>
                <span class="pc-number">{{ pc.name|get_int }}</span>
              </button>
            </div>
          {% endfor %}
        </div>
  
        {% if is_paginated %}
        <div class="pagination-modern">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="pagination-arrow" id="pageNavPrev">
              <i class="fa-solid fa-arrow-left"></i>
            </a>
          {% else %}
            <span class="pagination-arrow disabled">
              <i class="fa-solid fa-arrow-left"></i>
            </span>
          {% endif %}
          
          <span class="pagination-info">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span>
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="pagination-arrow" id="pageNavNext">
              <i class="fa-solid fa-arrow-right"></i>
            </a>
          {% else %}
            <span class="pagination-arrow disabled">
              <i class="fa-solid fa-arrow-right"></i>
            </span>
          {% endif %}
        </div>
        {% endif %}
        {% endif %}
        
        <!-- Next Button -->
        <button type="button" class="next-button-modern reserve-next-button" disabled aria-disabled="true">
          Next <i class="fa-solid fa-chevron-right"></i>
        </button>
        
        <!-- View QR Code Button (shown when QR code is available) -->
        <div id="viewQRCodeButtonNext" style="display: none; text-align: center; margin-top: 15px; position: relative; z-index: 1000;">
          <button type="button" class="btn btn-primary btn-lg" id="viewQRCodeBtnNext" style="position: relative; z-index: 1000; width: 100%; max-width: 300px;">
            <i class="fa-solid fa-qrcode"></i> View QR Code
          </button>
        </div>

        <div id="selected-pc-indicator" class="selected-pc-indicator" hidden>
          <i class="fa-solid fa-circle-check"></i>
          <span>Selected PC:</span>
          <strong id="selected-pc-name"></strong>
        </div>
      </div> <!-- end of students-booking -->

      <!-- My Session Button (shown when user has active booking) -->
      <div id="viewQRButtonContainer" style="display: none; visibility: hidden; text-align: center; margin: 20px 0;">
        <button type="button" class="btn btn-info btn-lg" id="showMySessionBtnMain" style="display: block;">
          <i class="fa-solid fa-clock"></i> My Session
        </button>
        <button type="button" class="btn btn-primary btn-lg mt-2" id="viewQRCodeBtn" style="display: block;">
          <i class="fa-solid fa-qrcode"></i> View QR Code
        </button>
      </div>

      {% if request.user.is_authenticated and request.user.profile.role|default:'' == 'faculty' %}
      <div class="text-center my-3">
        <button type="button" class="btn btn-success" id="block-button" onclick="showBlockBooking()">
          Bulk booking for class
        </button>
      </div>
      {% endif %}

      <div id="faculty-booking-pc-group" hidden> <!-- faculty-booking-pc-group -->
        <div class="text-center h6">Select Number of PCs</div>
        <div class="row justify-content-center text-center">
          <div class="mb-2 pc-container text-black">
          {% for i in total_pc|divide:5|integer|to_range %}
            {% if i|multiply:5 != total_pc %}
            <button class="pc-group-number" id="pcs-{{ i|multiply:5 }}" data-qty="{{ i|multiply:5 }}" onclick="handlePcGroupClick(this)">
              <span>{{ i|multiply:5 }}</span>
            </button>
            {% endif %}
          {% endfor %}
            <button class="pc-group-number" id="pcs-{{ total_pc }}" data-qty="{{ total_pc}}" onclick="handlePcGroupClick(this)">
              <span>{{ total_pc }}</span>
            </button>
          </div>
          <div class="input-group justify-content-center mb-3" style="max-width:250px; margin:auto;">
            <span class="input-group-text" id="basic-addon1">Custom</span>
            <input type="text" id="customNumOfPc" name="customNumOfPc" class="form-control text-center" value="0" min="0">
              <button class="btn btn-outline-secondary" type="button" id="fb-minusBtn" onclick="decrementCustomPc()">−</button>
            <button class="btn btn-outline-secondary" type="button" id="fb-plusBtn" onclick="incrementCustomPc()">+</button>
          </div>
          <div class="text-center mt-3">
            <button type="button" class="btn btn-success" id="block-button-next" hidden onclick="goToBlockBookingForm()">Next <i class="fa-solid fa-chevron-right"></i></button>
          </div>
        </div>
      </div> <!-- end of faculty-booking-pc-group -->

      <!-- Faculty Form -->
      <div class="form-section card-body p-4 bulk-booking-card shadow-lg" id="faculty-form-section" hidden>
        <form method="post" id="facultyForm" enctype="multipart/form-data" action="{% url 'main_app:submit-block-booking' %}">
          {% csrf_token %}
          <!-- Step 1 -->
          <div class="step active" id="step1">
            <input type="number" id="custNumOfPc" name="custNumOfPc" hidden>
            <input type="number" id="numOfPc" name="numOfPc" hidden>
            <div class="bulk-step-header text-center mb-4">
              <h3 class="bulk-step-title mb-2">Class Details</h3>
              <p class="bulk-step-subtitle mb-0">Provide the key information for your bulk booking session.</p>
            </div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="course" class="form-label fw-semibold">Course</label>
                <input type="text" id="course" name="course" class="form-control bulk-input" placeholder="e.g., BSIT">
              </div>
              <div class="col-12 col-md-6">
                <label for="block" class="form-label fw-semibold">Block</label>
                <input type="text" id="block" name="block" class="form-control bulk-input" placeholder="e.g., 3A">
              </div>
              <div class="col-12">
                <label for="college" class="form-label fw-semibold">College</label>
                <select id="college" name="college" class="form-control select bulk-input">
                  <option value="" selected disabled hidden>Select College</option>
                  {% for college in colleges %}
                  <option value="{{ college.id }}">{{ college.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label for="dateStart" class="form-label fw-semibold">Start date</label>
                <input type="datetime-local" id="dateStart" name="dateStart" class="form-control bulk-input">
              </div>
              <div class="col-12 col-md-6">
                <label for="dateEnd" class="form-label fw-semibold">End date</label>
                <input type="datetime-local" id="dateEnd" name="dateEnd" class="form-control bulk-input">
              </div>
            </div>
            <div class="bulk-step-actions mt-4">
              <button type="button" class="btn btn-outline-secondary bulk-back" onclick="backToPcSelection()">
                <i class="fa-solid fa-arrow-left me-1"></i> PC Selection
              </button>
              <button type="button" class="btn btn-primary bulk-next" data-next="step2" onclick="advanceStep('step1', 'step2')">
                Next <i class="fa-solid fa-arrow-right ms-1"></i>
              </button>
            </div>
          </div>

          <!-- Step 2: Email addresses -->
          <div class="step" id="step2">
            <div class="bulk-step-header text-center mb-3">
              <h3 class="bulk-step-title mb-2">Invite Students</h3>
              <p class="bulk-step-subtitle mb-0">Enter PSU email addresses separated by commas. We will notify each student.</p>
            </div>
            <textarea name="emailList" id="emailList" rows="8" class="form-control bulk-textarea" placeholder="student1@psu.palawan.edu.ph, student2@psu.palawan.edu.ph" oninput="validateEmailList(this)"></textarea>
            <div id="result" class="bulk-validation-feedback mt-2"></div>
            <div class="bulk-step-actions mt-4">
              <button type="button" class="btn btn-outline-secondary bulk-back" onclick="goBackStep('step2', 'step1')">
                <i class="fa-solid fa-arrow-left me-1"></i> Back
              </button>
              <button type="button" class="btn btn-primary bulk-next" data-next="step3" id="step3NextBtn" hidden onclick="advanceStep('step2', 'step3')">
                Next <i class="fa-solid fa-arrow-right ms-1"></i>
              </button>
            </div>
          </div>

          <!-- Step 3: Attachment -->
          <div class="step" id="step3">
            <div class="bulk-step-header text-center mb-3">
              <h3 class="bulk-step-title mb-2">Upload Approval Letter</h3>
              <p class="bulk-step-subtitle mb-0">Attach the request letter signed by your Dean to complete the submission.</p>
            </div>
            <input type="file" name="attachment" id="attachment" class="form-control bulk-input mb-3" accept=".pdf,.doc,.docx,.jpg,.png">
            <div class="bulk-step-actions mt-4">
              <button type="button" class="btn btn-outline-secondary bulk-back" onclick="goBackStep('step3', 'step2')">
                <i class="fa-solid fa-arrow-left me-1"></i> Back
              </button>
              <button type="submit" class="btn btn-success bulk-submit" data-next="step4" id="facultyFormSubmit">
                Submit Request <i class="fa-solid fa-paper-plane ms-2"></i>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Duration Modal -->
      <div class="modal fade" id="durationModal" tabindex="-1" aria-labelledby="durationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rounded-3 shadow">
            <div class="modal-header">
              <h5 class="modal-title" id="durationModalLabel">SET TIME</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <div class="input-group justify-content-center" style="max-width:200px; margin:auto;">
                <button class="btn btn-outline-secondary" type="button" id="minusBtn">−</button>
                <input type="number" id="durationInput" class="form-control text-center" value="30" min="1" max="180">
                <button class="btn btn-outline-secondary" type="button" id="plusBtn">+</button>
              </div>
              <small class="text-muted">Duration in minutes</small>
              <P class="mark" style="font-size: xx-small;">Note: You can only use a PC for a maximum of 3 hours</P>
            </div>
            <div class="modal-footer">
              <input type="number" name="" id="pc_id" hidden>
              <button type="button" id="generate-qr-button" class="btn btn-success" data-reserve-url="{% url 'main_app:reserve-pc' %}">Generate QR Code</button>
            </div>
          </div>
        </div>
      </div>

      <!-- QR Code Modal -->
      <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
          <div class="modal-content rounded-3 shadow text-center">
            <div class="modal-header">
              <h5 class="modal-title">Your Reservation QR</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <img id="qrImage" src="" alt="QR Code" class="img-fluid mb-3">
              <span id="booking_id" hidden></span>
              <input type="number" id="qr_booking_pc_id" hidden>
              <div>
                <small class="text-muted">Expires in <span id="qrCountdown">10:00</span></small>
              </div>
              <p style="font-size: x-small;">Note: <br>
                Use this QR code before it expires to confirm your booking.
                Confirming site is at the Ict desk info.
              </p>
            </div>
            <div class="modal-footer justify-content-center">
              <button type="button" class="btn btn-danger btn-sm" id="endQRSessionBtn">
                <i class="fa-solid fa-stop"></i> End Session
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Confirmation Modal -->
      <div class="modal fade" id="confirmEndSessionModal" tabindex="-1" aria-labelledby="confirmEndSessionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
              <h5 class="modal-title" id="confirmEndSessionLabel">
                <i class="fa-solid fa-exclamation-triangle me-2"></i>Confirm End Session
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
              <div class="mb-3">
                <i class="fa-solid fa-circle-question text-danger" style="font-size: 3rem;"></i>
              </div>
              <h6 class="mb-3">Are you sure you want to end your booking session?</h6>
              <p class="text-muted mb-0">This will cancel your reservation and you will need to create a new booking.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                <i class="fa-solid fa-times me-1"></i>Cancel
              </button>
              <button type="button" class="btn btn-danger" id="confirmEndSessionBtn">
                <i class="fa-solid fa-stop me-1"></i>End Session
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Remaining Time Modal -->
      <div class="modal fade" id="timeRemainingModal" tabindex="-1" aria-labelledby="timeRemainingLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content text-center">
            <div class="modal-header bg-warning">
              <h5 class="modal-title" id="timeRemainingLabel">Booking Active</h5>
            </div>
            <div class="modal-body text-center bg-dark text-white ps-2 pt-10 pe-2 pb-10">
              <i class="fa-solid fa-desktop mb-2" style="font-size: xx-large;"></i>
              <p>Your booking is confirmed ✅</p>
              <p>Time remaining 
                <br> 
                <span class="fw-bold" id="timeRemaining"></span>
              </p>
              <div class="mt-4">
                <button type="button" class="btn btn-danger btn-lg" id="end-session-early-btn" data-booking-id="" onclick="if(typeof window.handleEndSessionEarly === 'function') return window.handleEndSessionEarly(); return false;">
                  <i class="fa-solid fa-stop-circle"></i> End Session Early
                </button>
              </div>
              <div class="mt-3">
                <p class="text-warning mb-0" style="font-size: 0.9rem;">
                  <i class="fa-solid fa-info-circle"></i> 
                  <strong>Note:</strong> To extend your session time, please go to the front desk or contact an admin.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PC Status Modal -->
      <div class="modal fade" id="pcStatusModal" tabindex="-1" aria-labelledby="pcStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header" id="pcStatusModalHeader">
              <h5 class="modal-title" id="pcStatusModalLabel">
                <i class="fa-solid fa-desktop"></i> PC Status
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="pcStatusModalBody">
              <div id="pcStatusContent">
                <!-- Content will be populated by JavaScript -->
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-danger" id="pc-status-end-session-btn" style="display: none;" data-booking-id="">
                <i class="fa-solid fa-stop-circle"></i> End Session Early
              </button>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- end of reservation-body -->
  </div> <!-- end of reservation-card -->

</div>

<!-- Student Active Session Modal -->
<div class="modal fade" id="mySessionModal" tabindex="-1" aria-labelledby="mySessionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="mySessionModalLabel">
          <i class="fa-solid fa-desktop"></i> Your Active Session
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h3 id="session-pc-name">PC XXX</h3>
        <p class="mb-3">
          <strong>Status:</strong> <span id="session-status" class="badge bg-warning">In Queue</span>
        </p>
        <div id="session-time-info" style="display: none;">
          <p><strong>Time Remaining:</strong></p>
          <h2 class="text-primary" id="session-time-left">0h 0m</h2>
        </div>
        <div id="session-waiting" class="alert alert-warning">
          <i class="fa-solid fa-hourglass-half"></i><br>
          Waiting for staff approval...
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="end-session-btn" style="display: none;" data-booking-id="">
          <i class="fa-solid fa-stop-circle"></i> End Session Early
        </button>
      </div>
      <div class="modal-body border-top">
        <p class="text-warning mb-0 text-center" style="font-size: 0.9rem;">
          <i class="fa-solid fa-info-circle"></i> 
          <strong>Note:</strong> To extend your session time, please go to the front desk or contact an admin.
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Count available PCs and update the count badge
function updateAvailableCount() {
  var availableCount = 0;
  var pcButtons = document.querySelectorAll('.pc-button-modern');
  
  pcButtons.forEach(function(button) {
    var pcBookingStatus = button.getAttribute('data-booking-status');
    var pcCondition = button.getAttribute('data-pc-condition');
    var pcStatus = button.getAttribute('data-pc-status');
    
    // Count as available if: not in use, not in queue, not in repair, not offline
    if (pcBookingStatus !== 'in_use' && 
        pcBookingStatus !== 'in_queue' && 
        pcCondition !== 'repair' && 
        pcStatus !== 'disconnected') {
      availableCount++;
    }
  });
  
  var countElement = document.getElementById('available-count');
  if (countElement) {
    countElement.textContent = availableCount;
  }
}

// Initialize when DOM is ready
function initReservationPage() {
  updateAvailableCount();
  
  // Update available count when PC selection changes
  var pcButtons = document.querySelectorAll('.pc-button-modern');
  pcButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      setTimeout(updateAvailableCount, 100);
    });
  });
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initReservationPage);
} else {
  // DOM is already loaded
  initReservationPage();
}

// showPCStatus and selectPCForReservation are now defined in the extra_head block section above
// so they're available before the HTML that uses them

// Function to show block booking form
function showBlockBooking() {
  console.log('Block booking button clicked');
  var studentsBooking = document.getElementById('students-booking');
  var legend = document.getElementById('legend');
  var blockPcGroup = document.getElementById('faculty-booking-pc-group');
  var blockButton = document.getElementById('block-button');
  
  if (studentsBooking) studentsBooking.style.display = 'none';
  if (legend) legend.style.display = 'none';
  if (blockPcGroup) blockPcGroup.removeAttribute('hidden');
  if (blockButton) blockButton.style.display = 'none';
  
  console.log('Block booking form shown');
}

// Function to handle PC group button click
function handlePcGroupClick(button) {
  console.log('PC group button clicked');
  var qty = button.getAttribute('data-qty');
  var numOfPcInput = document.getElementById('numOfPc');
  var custNumOfPcInput = document.getElementById('custNumOfPc');
  var blockButtonNext = document.getElementById('block-button-next');
  
  console.log('Selected quantity:', qty);
  
  if (numOfPcInput) numOfPcInput.value = qty;
  if (custNumOfPcInput) custNumOfPcInput.value = qty;
  
  // Clear other button selections first
  var allPcGroupButtons = document.querySelectorAll('.pc-group-number');
  var isSelected = button.classList.contains('bg-warning');
  
  // Toggle selected state
  button.classList.toggle('bg-warning');
  isSelected = button.classList.contains('bg-warning');
  
  // Disable other buttons
  allPcGroupButtons.forEach(function(btn) {
    if (btn !== button) {
      btn.disabled = isSelected;
      if (isSelected) {
        btn.classList.remove('bg-warning');
      }
    }
  });
  
  // Clear custom input if a button is selected
  var customInput = document.getElementById('customNumOfPc');
  if (customInput && isSelected) {
    customInput.value = 0;
  }
  
  // Show/hide next button
  if (blockButtonNext) {
    blockButtonNext.hidden = !isSelected;
    console.log('Next button hidden:', blockButtonNext.hidden);
  }
}

// Function to go to next step in block booking
function goToBlockBookingForm() {
  var legendAndControl = document.getElementById('legend-and-control');
  var facultyBookingPcGroup = document.getElementById('faculty-booking-pc-group');
  var facultyFormSection = document.getElementById('faculty-form-section');
  
  if (legendAndControl) legendAndControl.setAttribute('hidden', 'true');
  if (facultyBookingPcGroup) facultyBookingPcGroup.setAttribute('hidden', 'true');
  if (facultyFormSection) facultyFormSection.removeAttribute('hidden');
  
  console.log('Showing faculty block booking form');
}

// Function to handle custom PC number input
function handleCustomPcInput() {
  var customInput = document.getElementById('customNumOfPc');
  var custNumOfPcHidden = document.getElementById('custNumOfPc');
  var blockButtonNext = document.getElementById('block-button-next');
  
  if (customInput && custNumOfPcHidden) {
    custNumOfPcHidden.value = customInput.value;
  }
  
  // Show next button if value > 0
  if (blockButtonNext && customInput) {
    var value = parseInt(customInput.value) || 0;
    blockButtonNext.hidden = (value <= 0);
    console.log('Custom PC input:', value, 'Next button hidden:', blockButtonNext.hidden);
  }
}

// Plus button for custom PC count
function incrementCustomPc() {
  var customInput = document.getElementById('customNumOfPc');
  if (customInput) {
    var current = parseInt(customInput.value) || 0;
    customInput.value = current + 1;
    handleCustomPcInput();
  }
}

// Minus button for custom PC count
function decrementCustomPc() {
  var customInput = document.getElementById('customNumOfPc');
  if (customInput) {
    var current = parseInt(customInput.value) || 0;
    if (current > 0) {
      customInput.value = current - 1;
      handleCustomPcInput();
    }
  }
}

// Function to validate email list and show/hide Next button
function validateEmailList(textarea) {
  var input = textarea.value;
  var emails = input.split(',').map(e => e.trim()).filter(e => e.length > 0);
  var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  var step3NextBtn = document.getElementById('step3NextBtn');
  
  // Check if all emails are valid
  var allValid = emails.length > 0 && emails.every(email => emailPattern.test(email));
  
  if (step3NextBtn) {
    step3NextBtn.hidden = !allValid;
    console.log('Email validation - Valid emails:', allValid, 'Total:', emails.length);
  }
}

// Function to advance to next step in the form
function advanceStep(currentStep, nextStep) {
  console.log('Advancing from', currentStep, 'to', nextStep);
  var currentStepDiv = document.getElementById(currentStep);
  var nextStepDiv = document.getElementById(nextStep);
  
  if (currentStepDiv) {
    currentStepDiv.classList.remove('active');
  }
  
  if (nextStepDiv) {
    nextStepDiv.classList.add('active');
  }

  var formSection = document.getElementById('faculty-form-section');
  if (formSection) {
    formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// Function to go back to the previous step in the form
function goBackStep(currentStep, previousStep) {
  console.log('Going back from', currentStep, 'to', previousStep);
  var currentStepDiv = document.getElementById(currentStep);
  var previousStepDiv = document.getElementById(previousStep);

  if (currentStepDiv) {
    currentStepDiv.classList.remove('active');
  }

  if (previousStepDiv) {
    previousStepDiv.classList.add('active');
  }

  if (previousStep === 'step2') {
    var emailList = document.getElementById('emailList');
    if (emailList) {
      validateEmailList(emailList);
    }
  }

  var formSection = document.getElementById('faculty-form-section');
  if (formSection) {
    formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// Return to PC selection screen from faculty form
function backToPcSelection() {
  console.log('Returning to PC selection');
  var facultyFormSection = document.getElementById('faculty-form-section');
  var facultyBookingPcGroup = document.getElementById('faculty-booking-pc-group');
  var step3NextBtn = document.getElementById('step3NextBtn');

  if (facultyFormSection) {
    facultyFormSection.setAttribute('hidden', 'true');
    var steps = facultyFormSection.querySelectorAll('.step');
    steps.forEach(function(step, index) {
      if (index === 0) {
        step.classList.add('active');
      } else {
        step.classList.remove('active');
      }
    });
  }

  if (facultyBookingPcGroup) {
    facultyBookingPcGroup.removeAttribute('hidden');
    facultyBookingPcGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  if (step3NextBtn) {
    step3NextBtn.hidden = true;
  }

  var pcGroupButtons = document.querySelectorAll('.pc-group-number');
  pcGroupButtons.forEach(function(btn) {
    btn.disabled = false;
    btn.classList.remove('bg-warning');
  });

  var blockButton = document.getElementById('block-button');
  if (blockButton) {
    blockButton.focus();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log("Reserve PC page loaded");
  
  // Ensure offline/repair PCs are always disabled and unclickable
  // Also ensure used/queued PCs are clickable
  document.querySelectorAll('.pc-button-modern, .pc-button').forEach(function(button) {
    const pcStatus = button.getAttribute('data-pc-status');
    const pcCondition = button.getAttribute('data-pc-condition');
    const pcBookingStatus = button.getAttribute('data-booking-status');
    
    if (pcCondition === 'repair' || pcStatus === 'disconnected') {
      button.disabled = true;
      button.style.pointerEvents = 'none';
      button.style.cursor = 'not-allowed';
      button.style.opacity = '0.6';
      button.setAttribute('tabindex', '-1');
      
      // Remove any click handlers that might bypass disabled state
      button.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        showPCStatus(parseInt(button.getAttribute('data-pc-id')), button);
        return false;
      };
    } else if (pcBookingStatus === 'in_use' || pcBookingStatus === 'in_queue') {
      // Make sure used/queued PCs are clickable (not disabled)
      button.disabled = false;
      button.style.pointerEvents = 'auto';
      button.style.cursor = 'pointer';
      button.style.opacity = '1';
      
      // Ensure onclick handler is set
      if (!button.onclick || button.onclick.toString().indexOf('showPCStatus') === -1) {
        button.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          showPCStatus(parseInt(button.getAttribute('data-pc-id')), button);
          return false;
        };
      }
    }
  });
  
  // Check if any PCs exist
  var pcButtons = document.querySelectorAll('.pc-button');
  console.log("Found PC buttons:", pcButtons.length);
  
  // Check if hidden field exists
  var pcIdInput = document.getElementById('pc_id');
  if (!pcIdInput) {
    console.warn("Warning: pc_id input field not found!");
  }
  
  // Add event listeners for PC group buttons
  var pcGroupButtons = document.querySelectorAll('.pc-group-number');
  pcGroupButtons.forEach(function(button) {
    button.addEventListener('click', function() {
      handlePcGroupClick(button);
    });
  });
  
  // Add event listener for block button next
  var blockButtonNext = document.getElementById('block-button-next');
  if (blockButtonNext) {
    blockButtonNext.addEventListener('click', goToBlockBookingForm);
  }
  
  // Ensure Next button starts disabled and visible
  var nextButtonInit = document.querySelector('.reserve-next-button');
  if (nextButtonInit) {
    nextButtonInit.disabled = true;
    nextButtonInit.setAttribute('aria-disabled', 'true');
    nextButtonInit.style.display = 'block';
    nextButtonInit.style.visibility = 'visible';
  }
  
  // Add event listeners for custom PC input +/- buttons
  var fbPlusBtn = document.getElementById('fb-plusBtn');
  var fbMinusBtn = document.getElementById('fb-minusBtn');
  var customNumOfPc = document.getElementById('customNumOfPc');
  
  if (fbPlusBtn) {
    fbPlusBtn.addEventListener('click', incrementCustomPc);
  }
  
  if (fbMinusBtn) {
    fbMinusBtn.addEventListener('click', decrementCustomPc);
  }
  
  if (customNumOfPc) {
    customNumOfPc.addEventListener('input', handleCustomPcInput);
  }
  
  // Add click handler for Next button to show modal
  var nextButton = document.querySelector('.reserve-next-button');
  if (nextButton) {
    nextButton.addEventListener('click', function() {
      console.log('Next button clicked, showing duration modal');
      var durationModal = document.getElementById('durationModal');
      if (durationModal) {
        // Use Bootstrap 5 modal API
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
          var modal = new bootstrap.Modal(durationModal);
          modal.show();
        } else {
          // Fallback if bootstrap not loaded
          durationModal.style.display = 'block';
          durationModal.classList.add('show');
        }
      } else {
        console.error('Duration modal not found!');
      }
    });
  }
  
  // Add handlers for duration +/- buttons
  var plusBtn = document.getElementById('plusBtn');
  var minusBtn = document.getElementById('minusBtn');
  var durationInput = document.getElementById('durationInput');
  
  if (plusBtn && durationInput) {
    plusBtn.addEventListener('click', function() {
      var current = parseInt(durationInput.value) || 0;
      var newValue = Math.min(current + 5, 180);
      durationInput.value = newValue;
      console.log('Duration increased to:', newValue);
      
      // Disable plus button if at max
      if (newValue >= 180) {
        plusBtn.disabled = true;
      }
      // Enable minus button
      if (minusBtn) minusBtn.disabled = false;
    });
  }
  
  if (minusBtn && durationInput) {
    minusBtn.addEventListener('click', function() {
      var current = parseInt(durationInput.value) || 0;
      var newValue = Math.max(current - 5, 1);
      durationInput.value = newValue;
      console.log('Duration decreased to:', newValue);
      
      // Disable minus button if at min
      if (newValue <= 1) {
        minusBtn.disabled = true;
      }
      // Enable plus button
      if (plusBtn) plusBtn.disabled = false;
    });
  }
  
  // Add handler for Generate QR Code button
  var generateQRBtn = document.getElementById('generate-qr-button');
  if (generateQRBtn) {
    generateQRBtn.addEventListener('click', function() {
      console.log('Generate QR Code button clicked');
      var duration = durationInput ? durationInput.value : null;
      var selectedPC = document.getElementById('pc_id') ? document.getElementById('pc_id').value : null;
      
      console.log('Duration:', duration, 'PC:', selectedPC);
      
      if (!duration || duration <= 0) {
        alert("Please enter a valid duration.");
        return;
      }
      
      if (!selectedPC) {
        alert("Please select a PC first.");
        return;
      }
      
      // Validate PC status - check if selected PC is offline or in repair
      var selectedButton = document.querySelector('.pc-button.text-success');
      if (selectedButton) {
        var pcStatus = selectedButton.getAttribute('data-pc-status');
        var pcCondition = selectedButton.getAttribute('data-pc-condition');
        var pcBookingStatus = selectedButton.getAttribute('data-booking-status');
        var pcName = selectedButton.getAttribute('data-pc-name');
        
        if (pcCondition === 'repair') {
          alert(`PC ${pcName} is currently in repair and cannot be reserved.\n\nPlease select a different PC.`);
          return;
        }
        
        if (pcStatus === 'disconnected') {
          alert(`PC ${pcName} is currently offline and cannot be reserved.\n\nPlease select a different PC.`);
          return;
        }
        
        if (pcBookingStatus === 'in_use' || pcBookingStatus === 'in_queue') {
          alert(`PC ${pcName} is currently ${pcBookingStatus.replace('_', ' ')} and cannot be reserved.\n\nPlease select a different PC.`);
          return;
        }
      }
      
      var reserveUrl = generateQRBtn.getAttribute('data-reserve-url') || '/reserve-pc/';
      console.log('Sending request to:', reserveUrl);
      
      // Show loading state
      generateQRBtn.disabled = true;
      generateQRBtn.textContent = 'Generating...';
      
      // Send AJAX request with form data
      var formData = new URLSearchParams();
      formData.append('pc_id', selectedPC);
      formData.append('duration', duration);
      
      fetch(reserveUrl, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
      })
      .then(data => {
        console.log('Response received:', data);
        
        if (!data.success) {
          alert('Error: ' + (data.error || 'Unknown error'));
          return;
        }
        
        // Hide duration modal
        var durationModal = document.getElementById('durationModal');
        if (durationModal && typeof bootstrap !== 'undefined') {
          var modal = bootstrap.Modal.getInstance(durationModal);
          if (modal) modal.hide();
        }
        
        // Show QR code modal
        var qrModal = document.getElementById('qrModal');
        var qrImage = document.getElementById('qrImage');
        var bookingIdSpan = document.getElementById('booking_id');
        var qrCountdown = document.getElementById('qrCountdown');
        
        // Set QR code image
        if (qrImage && data.qr_code) {
          var qrImageData = 'data:image/png;base64,' + data.qr_code;
          qrImage.src = qrImageData;
          console.log('QR code image set');
          
          // Store QR code data globally and in localStorage for persistence
          window.storedQRCode = qrImageData;
          window.storedBookingId = data.booking_id;
          
          // Get PC ID
          var pcIdFromForm = document.getElementById('pc_id');
          window.storedPCId = pcIdFromForm ? pcIdFromForm.value : null;
          
          // Store in localStorage for persistence after refresh
          try {
            localStorage.setItem('qrCodeData', qrImageData);
            localStorage.setItem('qrBookingId', String(data.booking_id));
            localStorage.setItem('qrPCId', window.storedPCId || '');
            localStorage.setItem('qrCodeTimestamp', String(Date.now()));
          } catch (e) {
            console.error('Error saving to localStorage:', e);
          }
          
          // Show the "My Session" button (replaces View QR Code button)
          var viewQRContainer = document.getElementById('viewQRButtonContainer');
          if (viewQRContainer) {
            viewQRContainer.style.display = 'block';
            viewQRContainer.style.visibility = 'visible';
            viewQRContainer.style.opacity = '1';
          }
          // Also check for active session to ensure button shows - check immediately and after delay
          checkMyActiveSession();
          setTimeout(function() {
            checkMyActiveSession();
          }, 500);
          setTimeout(function() {
            checkMyActiveSession();
          }, 2000);
        }
        
        // Set booking ID
        if (bookingIdSpan && data.booking_id) {
          bookingIdSpan.textContent = data.booking_id;
          console.log('Booking ID set:', data.booking_id);
        }
        
        // Check for active session to show button after booking is created
        setTimeout(function() {
          checkMyActiveSession();
        }, 500);
        
        // Store PC ID for cancel functionality
        var pcIdInput = document.getElementById('qr_booking_pc_id');
        var pcIdFromForm = document.getElementById('pc_id');
        if (pcIdInput && pcIdFromForm && pcIdFromForm.value) {
          pcIdInput.value = pcIdFromForm.value;
        }
        
        // Start countdown timer (10 minutes = 600 seconds)
        var countdownSeconds = 600;
        var countdownInterval;
        
        // Store intervals globally so we can clear them when canceling
        window.qrCountdownInterval = null;
        window.qrApprovalChecker = null;
        window.qrCountdownSeconds = 600; // Store countdown seconds
        window.qrModalPaused = false; // Track if modal is paused
        
        function updateCountdown() {
          // Skip if paused
          if (window.qrModalPaused) {
            return;
          }
          
          var minutes = Math.floor(countdownSeconds / 60);
          var seconds = countdownSeconds % 60;
          var displayTime = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
          
          if (qrCountdown) {
            qrCountdown.textContent = displayTime;
          }
          
          countdownSeconds--;
          window.qrCountdownSeconds = countdownSeconds; // Store current value
          
          if (countdownSeconds < 0) {
            clearInterval(countdownInterval);
            window.qrCountdownInterval = null;
            if (qrCountdown) qrCountdown.textContent = '00:00';
            
            // Clear intervals
            if (window.qrApprovalChecker) {
              clearInterval(window.qrApprovalChecker);
              window.qrApprovalChecker = null;
            }
            
            // Auto-close modal
            if (qrModal && typeof bootstrap !== 'undefined') {
              var modal = bootstrap.Modal.getInstance(qrModal);
              if (modal) modal.hide();
            }
            
            // Hide View QR button when expired
            var viewQRContainer = document.getElementById('viewQRButtonContainer');
            if (viewQRContainer) {
              viewQRContainer.style.display = 'none';
            }
          }
        }
        
        // Start countdown
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
        window.qrCountdownInterval = countdownInterval; // Store globally
        window.qrModalPaused = false; // Ensure not paused
        console.log('Countdown started');
        
        // Show QR modal
        if (qrModal && typeof bootstrap !== 'undefined') {
          var modal = new bootstrap.Modal(qrModal);
          modal.show();
          console.log('QR modal shown');
        }
        
        // Check for approval periodically
        var bookingId = data.booking_id;
        var approvalChecker = setInterval(function() {
          // Skip if paused
          if (window.qrModalPaused) {
            return;
          }
          
          if (!bookingId) return;
          
          fetch(`/ajax/waiting-approval/${bookingId}`)
            .then(response => response.json())
            .then(function(approvalData) {
              if (approvalData.status === 'confirmed') {
                clearInterval(approvalChecker);
                clearInterval(countdownInterval);
                window.qrCountdownInterval = null;
                window.qrApprovalChecker = null;
                console.log('Approval detected. QR expiration timer stopped.');
                
                // Clear QR code data (one-time use)
                try {
                  localStorage.removeItem('qrCodeData');
                  localStorage.removeItem('qrBookingId');
                  localStorage.removeItem('qrPCId');
                  localStorage.removeItem('qrCodeTimestamp');
                  window.storedQRCode = null;
                  window.storedBookingId = null;
                  window.storedPCId = null;
                } catch (e) {
                  console.error('Error clearing QR code data:', e);
                }
                
                // Hide QR modal
                if (qrModal && typeof bootstrap !== 'undefined') {
                  var modal = bootstrap.Modal.getInstance(qrModal);
                  if (modal) modal.hide();
                }
                
                // Show "My Session" modal instead of timeRemainingModal
                // Get booking ID from approval data
                var bookingId = approvalData.booking_id;
                var bookingIdEl = document.getElementById('booking_id');
                if (bookingId && bookingIdEl) {
                  bookingIdEl.textContent = bookingId;
                }
                
                // Store booking ID globally for end session button
                if (bookingId) {
                  window.currentBookingId = bookingId;
                }
                
                // Immediately check for active session to show button
                checkMyActiveSession();
                
                // Show the "My Session" modal after a short delay to ensure data is loaded
                setTimeout(function() {
                  showMySessionModal();
                }, 500);
                
                // Also check again after a short delay to ensure button shows
                setTimeout(function() {
                  checkMyActiveSession();
                }, 1000);
              } else if (approvalData.status === 'cancelled') {
                // Clear QR code data (one-time use)
                try {
                  localStorage.removeItem('qrCodeData');
                  localStorage.removeItem('qrBookingId');
                  localStorage.removeItem('qrPCId');
                  localStorage.removeItem('qrCodeTimestamp');
                  window.storedQRCode = null;
                  window.storedBookingId = null;
                  window.storedPCId = null;
                } catch (e) {
                  console.error('Error clearing QR code data:', e);
                }
                clearInterval(approvalChecker);
                clearInterval(countdownInterval);
                window.qrCountdownInterval = null;
                window.qrApprovalChecker = null;
                console.log('Reservation cancelled. QR expiration timer stopped.');
                
                // Clear stored QR code data
                window.storedQRCode = null;
                window.storedBookingId = null;
                window.storedPCId = null;
                
                // Clear localStorage
                try {
                  localStorage.removeItem('qrCodeData');
                  localStorage.removeItem('qrBookingId');
                  localStorage.removeItem('qrPCId');
                  localStorage.removeItem('qrCodeTimestamp');
                } catch (e) {
                  console.error('Error clearing localStorage:', e);
                }
                
                // Hide QR modal and View QR button
                if (qrModal && typeof bootstrap !== 'undefined') {
                  var modal = bootstrap.Modal.getInstance(qrModal);
                  if (modal) {
                    modal.hide();
                    // Remove backdrop if it exists
                    setTimeout(function() {
                      var backdrop = document.querySelector('.modal-backdrop');
                      if (backdrop) {
                        backdrop.remove();
                      }
                      // Remove modal-open class from body
                      document.body.classList.remove('modal-open');
                      document.body.style.overflow = '';
                      document.body.style.paddingRight = '';
                    }, 100);
                  }
                }
                
                var viewQRContainer = document.getElementById('viewQRButtonContainer');
                if (viewQRContainer) {
                  viewQRContainer.style.display = 'none';
                }
                
                alert('Your reservation has been declined!');
                window.location.href = '/pc-reservation/';
              }
            })
            .catch(function(error) {
              console.error('Error checking approval:', error);
            });
        }, 1000);
        window.qrApprovalChecker = approvalChecker; // Store globally
      })
      .catch(error => {
        console.error('Error:', error);
        console.error('Full error details:', error);
        
        // Try to get more details about the error
        fetch(reserveUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
          },
          body: formData
        })
        .then(response => response.text())
        .then(html => {
          console.error('Server response (HTML):', html.substring(0, 500));
          alert('Error generating QR code. Please check console for details.');
        })
        .catch(err => {
          console.error('Fetch error:', err);
          alert('Error generating QR code: ' + error.message);
        });
      })
      .finally(() => {
        generateQRBtn.disabled = false;
        generateQRBtn.textContent = 'Generate QR Code';
      });
    });
  }
});

// Cancel booking button handler - use event delegation for dynamically added modals
// Wait for jQuery to be available
function initCancelBookingHandler() {
  if (typeof jQuery === 'undefined' && typeof $ === 'undefined') {
    // jQuery not loaded yet, retry after a short delay
    setTimeout(initCancelBookingHandler, 100);
    return;
  }
  
  var $ = jQuery || window.$;
  
  $(document).ready(function() {
    // Use event delegation to handle clicks on dynamically added buttons
    $(document).on('click', '#cancelBookingBtn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Confirm cancellation
    if (!confirm('Are you sure you want to cancel this booking?')) {
      return;
    }
    
    // Get booking ID - it's stored in the span's textContent
    var bookingId = $('#booking_id').text().trim();
    var pcId = $('#qr_booking_pc_id').val();
    
    console.log('Cancel button clicked. Booking ID:', bookingId, 'PC ID:', pcId);
    
    // Validate that we have at least one identifier
    if (!bookingId && !pcId) {
      alert('Error: No booking information found. Please refresh the page and try again.');
      return;
    }
    
    // Disable button to prevent multiple clicks
    var $btn = $(this);
    var originalHtml = $btn.html();
    $btn.prop('disabled', true);
    $btn.html('<i class="fa-solid fa-spinner fa-spin"></i> Cancelling...');
    
    // Clear intervals
    if (window.qrCountdownInterval) {
      clearInterval(window.qrCountdownInterval);
      window.qrCountdownInterval = null;
    }
    if (window.qrApprovalChecker) {
      clearInterval(window.qrApprovalChecker);
      window.qrApprovalChecker = null;
    }
    
    // Send cancel request
    $.ajax({
      url: '/ajax/cancel-reservation/',
      method: 'POST',
      headers: {
        'X-CSRFToken': (function() {
          var token = $('[name=csrfmiddlewaretoken]').val();
          if (!token) {
            var el = document.querySelector('[name=csrfmiddlewaretoken]');
            token = el ? el.value : '';
          }
          if (!token && typeof getCookie !== 'undefined') {
            token = getCookie('csrftoken') || '';
          }
          return token || '';
        })()
      },
      data: {
        booking_id: bookingId,
        pc_id: pcId
      },
      success: function(response) {
        if (response.success) {
          // Clear stored QR code data
          window.storedQRCode = null;
          window.storedBookingId = null;
          window.storedPCId = null;
          
          // Clear localStorage
          try {
            localStorage.removeItem('qrCodeData');
            localStorage.removeItem('qrBookingId');
            localStorage.removeItem('qrPCId');
            localStorage.removeItem('qrCodeTimestamp');
          } catch (e) {
            console.error('Error clearing localStorage:', e);
          }
          
          // Hide View QR button
          var viewQRContainer = document.getElementById('viewQRButtonContainer');
          if (viewQRContainer) {
            viewQRContainer.style.display = 'none';
          }
          
          // Close QR modal and clean up
          var qrModal = document.getElementById('qrModal');
          if (qrModal && typeof bootstrap !== 'undefined') {
            var modal = bootstrap.Modal.getInstance(qrModal);
            if (modal) {
              modal.hide();
            }
          }
          
          // Remove backdrop and clean up modal state
          setTimeout(function() {
            var backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          }, 100);
          
          // Show success message
          alert(response.message || 'Booking cancelled successfully');
          
          // Reload page to refresh PC status
          location.reload();
        } else {
          alert('Error: ' + (response.error || 'Failed to cancel booking'));
          // Re-enable button on failure
          $btn.prop('disabled', false);
          $btn.html(originalHtml);
        }
      },
      error: function(xhr, status, error) {
        console.error('Cancel booking error:', xhr, status, error);
        console.error('Response text:', xhr.responseText);
        
        // Extract error message from response
        var errorMsg = 'Failed to cancel booking';
        try {
          if (xhr.responseJSON && xhr.responseJSON.error) {
            errorMsg = xhr.responseJSON.error;
          } else if (xhr.responseText) {
            var jsonResponse = JSON.parse(xhr.responseText);
            if (jsonResponse.error) {
              errorMsg = jsonResponse.error;
            }
          }
        } catch (e) {
          // Not JSON, use default message
          console.error('Error parsing response:', e);
        }
        
        alert('Error: ' + errorMsg);
        
        // Re-enable button on error
        $btn.prop('disabled', false);
        $btn.html(originalHtml);
      }
    });
  });
}

// Initialize cancel booking handler when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCancelBookingHandler);
} else {
  initCancelBookingHandler();
}
  
  // Helper function to get CSRF cookie
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // View QR Code button handler
  // Handle My Session button click (replaces View QR Code button)
  // Use vanilla JS instead of jQuery to avoid dependency issues
  var showMySessionBtnMain = document.getElementById('showMySessionBtnMain');
  if (showMySessionBtnMain) {
    showMySessionBtnMain.addEventListener('click', function() {
      showMySessionModal();
    });
  }
  
  // Old viewQRCodeBtn handler - removed, replaced with My Session button
  // This handler is kept for backward compatibility but should not be needed
  var viewQRCodeBtn = document.getElementById('viewQRCodeBtn');
  if (viewQRCodeBtn) {
    viewQRCodeBtn.addEventListener('click', function() {
      // Fallback: reload from localStorage if window vars are missing
      if (!window.storedQRCode) {
        try {
          var storedQR = localStorage.getItem('qrCodeData');
          var storedBookingId = localStorage.getItem('qrBookingId');
          var storedPCId = localStorage.getItem('qrPCId');
          if (storedQR) {
            window.storedQRCode = storedQR;
            window.storedBookingId = storedBookingId;
            window.storedPCId = storedPCId;
          }
        } catch(e) {
          console.error('Error loading QR code from localStorage:', e);
        }
      }
      if (!window.storedQRCode) {
        alert('No QR code found. Please generate a QR code first.');
        return;
      }
      
      // Get references
      var qrModal = document.getElementById('qrModal');
      var qrImage = document.getElementById('qrImage');
      var bookingIdSpan = document.getElementById('booking_id');
      var pcIdInput = document.getElementById('qr_booking_pc_id');
      var qrCountdown = document.getElementById('qrCountdown');
      
      // Restore QR code data
      if (qrImage) {
        qrImage.src = window.storedQRCode;
      }
      
      if (bookingIdSpan && window.storedBookingId) {
        bookingIdSpan.textContent = window.storedBookingId;
      }
      
      if (pcIdInput && window.storedPCId) {
        pcIdInput.value = window.storedPCId;
      }
      
      // Resume countdown if timer is still running
      if (window.qrCountdownInterval && window.qrCountdownSeconds !== undefined && window.qrCountdownSeconds >= 0) {
        window.qrModalPaused = false;
        // Update display with current time
        if (qrCountdown) {
          var minutes = Math.floor(window.qrCountdownSeconds / 60);
          var seconds = window.qrCountdownSeconds % 60;
          var displayTime = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
          qrCountdown.textContent = displayTime;
        }
      } else {
        // No active timer, show static message
        if (qrCountdown) {
          qrCountdown.textContent = 'Viewing saved QR';
        }
      }
      
      // Show the QR modal
      if (qrModal && typeof bootstrap !== 'undefined') {
        var modal = new bootstrap.Modal(qrModal);
        modal.show();
      } else if (window.jQuery && typeof jQuery !== 'undefined') {
        var $ = jQuery || window.$;
        $('#qrModal').modal('show');
      } else if (qrModal) {
        qrModal.style.display = 'block';
        qrModal.classList.add('show');
        document.body.classList.add('modal-open');
      }
    });
  }
  
  // Handle QR modal close event to pause timers and clean up
  var qrModal = document.getElementById('qrModal');
  if (qrModal) {
    qrModal.addEventListener('hidden.bs.modal', function() {
      // Pause the timers when modal is closed
      window.qrModalPaused = true;
      console.log('QR modal closed, timers paused');
    
    // Clean up modal backdrop and body styles
    setTimeout(function() {
      var backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    }, 100);
    });
  }
  
  // Handle QR modal show event to resume timers
  if (qrModal) {
    qrModal.addEventListener('shown.bs.modal', function() {
      // Resume the timers when modal is shown
      if (window.qrCountdownInterval) {
        window.qrModalPaused = false;
        console.log('QR modal shown, timers resumed');
      }
    });
  }
  
  // Load QR code data from localStorage on page load
  function loadStoredQRCode() {
    try {
      var storedQR = localStorage.getItem('qrCodeData');
      var storedBookingId = localStorage.getItem('qrBookingId');
      var storedPCId = localStorage.getItem('qrPCId');
      var storedTimestamp = localStorage.getItem('qrCodeTimestamp');
      
      // Check if QR code is still valid (not expired - 10 minutes = 600000ms)
      if (storedQR && storedBookingId && storedTimestamp) {
        var timestamp = parseInt(storedTimestamp);
        var now = Date.now();
        var tenMinutes = 10 * 60 * 1000; // 10 minutes in milliseconds
        
        // If QR code is older than 10 minutes, remove it
        if (now - timestamp > tenMinutes) {
          localStorage.removeItem('qrCodeData');
          localStorage.removeItem('qrBookingId');
          localStorage.removeItem('qrPCId');
          localStorage.removeItem('qrCodeTimestamp');
          return;
        }
        
        // Restore QR code data
        window.storedQRCode = storedQR;
        window.storedBookingId = storedBookingId;
        window.storedPCId = storedPCId;
        
        // Show the "My Session" button (replaces View QR Code button)
        // But only if there's an active booking
        // Use setTimeout to ensure DOM is ready
        setTimeout(function() {
          checkMyActiveSession();
        }, 100);
        
        console.log('QR code data restored from localStorage');
      }
    } catch (e) {
      console.error('Error loading from localStorage:', e);
    }
  }
  
  // Load stored QR code on page load
  loadStoredQRCode();
});

// Function to check and display student's active session
// Make checkMyActiveSession globally accessible
window.checkMyActiveSession = function() {
  console.log('checkMyActiveSession called');
  
  // Ensure DOM elements exist before proceeding
  var showMySessionBtn = document.getElementById('showMySessionBtn');
  var showMySessionBtnMain = document.getElementById('showMySessionBtnMain');
  var viewQRContainer = document.getElementById('viewQRButtonContainer');
  
  if (!showMySessionBtn && !showMySessionBtnMain && !viewQRContainer) {
    console.warn('My Session button elements not found, retrying in 500ms...');
    setTimeout(checkMyActiveSession, 500);
    return;
  }
  
  fetch('/ajax/get-my-active-booking/')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('Active booking check result:', data);
      
      // Show/hide "My Session" button based on whether user has an active booking
      // Show button for both confirmed and pending bookings
      // Simplify the condition - show if has_booking is true OR if we have booking data
      var shouldShow = false;
      
      if (data.has_booking === true) {
        shouldShow = true;
        console.log('has_booking is true, showing button');
      } else if (data.booking_id || data.pc_name || data.booking_status !== undefined) {
        // If we have any booking data, show the button
        shouldShow = true;
        console.log('Booking data found, showing button:', {booking_id: data.booking_id, pc_name: data.pc_name, booking_status: data.booking_status});
      } else {
        console.log('No booking data found, hiding button');
      }
      
      if (shouldShow) {
        console.log('User has active booking, showing buttons');
        // Show buttons if user has active booking - use inline-block or flex to ensure visibility
        if (showMySessionBtn) {
          showMySessionBtn.style.display = 'block';
          showMySessionBtn.style.visibility = 'visible';
          showMySessionBtn.style.opacity = '1';
          showMySessionBtn.style.position = 'relative';
          showMySessionBtn.removeAttribute('hidden');
          console.log('Header My Session button shown');
        } else {
          console.warn('showMySessionBtn element not found');
        }
        if (viewQRContainer) {
          viewQRContainer.style.display = 'block';
          viewQRContainer.style.visibility = 'visible';
          viewQRContainer.style.opacity = '1';
          viewQRContainer.removeAttribute('hidden');
          console.log('Main My Session button container shown');
        } else {
          console.warn('viewQRContainer element not found');
        }
        if (showMySessionBtnMain) {
          showMySessionBtnMain.style.display = 'block';
          showMySessionBtnMain.style.visibility = 'visible';
          showMySessionBtnMain.style.opacity = '1';
          showMySessionBtnMain.removeAttribute('hidden');
          console.log('Main My Session button shown');
        } else {
          console.warn('showMySessionBtnMain element not found');
        }
      } else {
        console.log('User has no active booking, hiding buttons');
        // Hide buttons if no active booking
        if (showMySessionBtn) {
          showMySessionBtn.style.display = 'none';
          showMySessionBtn.style.visibility = 'hidden';
        }
        if (viewQRContainer) {
          viewQRContainer.style.display = 'none';
          viewQRContainer.style.visibility = 'hidden';
        }
        if (showMySessionBtnMain) {
          showMySessionBtnMain.style.display = 'none';
          showMySessionBtnMain.style.visibility = 'hidden';
        }
        // Clear QR code data if no active booking
        try {
          localStorage.removeItem('qrCodeData');
          localStorage.removeItem('qrBookingId');
          localStorage.removeItem('qrPCId');
          localStorage.removeItem('qrCodeTimestamp');
          window.storedQRCode = null;
          window.storedBookingId = null;
          window.storedPCId = null;
        } catch (e) {
          console.error('Error clearing QR code data:', e);
        }
      }
      
      if (data.has_booking) {
        console.log('Active booking found:', data);
        
        // Store booking_id for end session button - also store in global variable
        var endSessionBtn = document.getElementById('end-session-btn');
        if (endSessionBtn) {
          if (data.booking_id) {
            window.currentBookingId = data.booking_id;
            endSessionBtn.setAttribute('data-booking-id', data.booking_id);
            console.log('Set booking_id on end-session-btn:', data.booking_id);
            console.log('Also stored in window.currentBookingId:', window.currentBookingId);
          } else {
            console.warn('No booking_id in response data:', data);
          }
        } else {
          console.warn('end-session-btn element not found');
        }
        
        // Update modal content
        document.getElementById('session-pc-name').textContent = data.pc_name;
        document.getElementById('session-status').textContent = data.status === 'in_use' ? 'Active' : 'Waiting Approval';
        document.getElementById('session-status').className = data.status === 'in_use' ? 'badge bg-success' : 'badge bg-warning';
        
        if (data.status === 'in_use' && data.time_remaining) {
          // Show time info
          document.getElementById('session-time-info').style.display = 'block';
          document.getElementById('session-waiting').style.display = 'none';
          document.getElementById('session-time-left').textContent = data.time_remaining;
          
          // Set booking_id BEFORE showing the button
          var endSessionBtn = document.getElementById('end-session-btn');
          if (endSessionBtn && data.booking_id) {
            // Store booking_id in both places for reliability
            window.currentBookingId = data.booking_id;
            endSessionBtn.setAttribute('data-booking-id', data.booking_id);
            console.log('Set booking_id on end-session-btn before showing:', data.booking_id);
            console.log('Stored in window.currentBookingId:', window.currentBookingId);
            console.log('Button data-booking-id attribute:', endSessionBtn.getAttribute('data-booking-id'));
            
            // Set onclick handler directly
            endSessionBtn.onclick = window.handleEndSession;
            
            endSessionBtn.style.display = 'block';
          } else {
            console.warn('Cannot show end session button - missing booking_id:', data);
            if (endSessionBtn) endSessionBtn.style.display = 'none';
          }
        } else {
          // Show waiting message
          document.getElementById('session-time-info').style.display = 'none';
          document.getElementById('session-waiting').style.display = 'block';
          var endSessionBtn = document.getElementById('end-session-btn');
          if (endSessionBtn) {
            endSessionBtn.style.display = 'none';
            endSessionBtn.removeAttribute('data-booking-id'); // Clear booking_id when hiding
          }
        }
        
        // Show modal only if called from button click, not on page load
        // The modal will be shown by the button click handler
      }
    })
    .catch(error => {
      console.error('Error checking session:', error);
      // On error, still try to show button if elements exist (might be a network issue)
      // But don't force show if we can't verify booking status
      console.warn('Failed to check active session, will retry on next interval');
    });
}

// Function to show my session modal (called from button click)
// Add retry counter to prevent infinite loops
var showMySessionModalRetryCount = 0;
var MAX_RETRY_COUNT = 5;

function showMySessionModal() {
  console.log('showMySessionModal called, retry count:', showMySessionModalRetryCount);
  
  // Check if modal elements exist
  var modalElement = document.getElementById('mySessionModal');
  if (!modalElement) {
    console.error('mySessionModal element not found');
    if (showMySessionModalRetryCount < MAX_RETRY_COUNT) {
      showMySessionModalRetryCount++;
      setTimeout(function() {
        showMySessionModal();
      }, 200);
      return;
    } else {
      alert('Error: Session modal not found. Please refresh the page.');
      showMySessionModalRetryCount = 0; // Reset counter
      return;
    }
  }
  
  // Reset retry counter if modal found
  showMySessionModalRetryCount = 0;
  
  fetch('/ajax/get-my-active-booking/')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('Session modal data:', data);
      
      if (data.has_booking) {
        // Get all modal elements
        var pcNameEl = document.getElementById('session-pc-name');
        var statusEl = document.getElementById('session-status');
        var timeInfoEl = document.getElementById('session-time-info');
        var waitingEl = document.getElementById('session-waiting');
        var timeLeftEl = document.getElementById('session-time-left');
        var endSessionBtn = document.getElementById('end-session-btn');
        
        // Check if critical elements exist - retry if not found
        if (!pcNameEl || !statusEl) {
          console.warn('Critical modal elements not found, retrying in 200ms...');
          console.log('Missing elements:', {
            pcNameEl: !pcNameEl,
            statusEl: !statusEl,
            timeInfoEl: !timeInfoEl,
            waitingEl: !waitingEl,
            timeLeftEl: !timeLeftEl
          });
          
          // Retry with limit
          if (showMySessionModalRetryCount < MAX_RETRY_COUNT) {
            showMySessionModalRetryCount++;
            setTimeout(function() {
              showMySessionModal();
            }, 200);
            return;
          } else {
            console.error('Max retry count reached, showing error');
            alert('Error: Session modal elements not found. Please refresh the page.');
            showMySessionModalRetryCount = 0; // Reset counter
            return;
          }
        }
        
        // Reset retry counter if critical elements found
        showMySessionModalRetryCount = 0;
        
        // Update modal content - handle missing optional elements gracefully
        if (pcNameEl) {
          pcNameEl.textContent = data.pc_name || 'Unknown PC';
        }
        if (statusEl) {
          statusEl.textContent = (data.status === 'in_use' || data.booking_status === 'confirmed') ? 'Active' : 'Waiting Approval';
          statusEl.className = (data.status === 'in_use' || data.booking_status === 'confirmed') ? 'badge bg-success' : 'badge bg-warning';
        }
        
        if ((data.status === 'in_use' || data.booking_status === 'confirmed') && data.time_remaining) {
          // Show time info
          if (timeInfoEl) {
            timeInfoEl.style.display = 'block';
          }
          if (waitingEl) {
            waitingEl.style.display = 'none';
          }
          if (timeLeftEl) {
            timeLeftEl.textContent = data.time_remaining;
          }
          
          // Set booking_id and show end session button
          if (endSessionBtn && data.booking_id) {
            window.currentBookingId = data.booking_id;
            endSessionBtn.setAttribute('data-booking-id', data.booking_id);
            // Set onclick handler properly
            endSessionBtn.onclick = function(e) {
              if (e) {
                e.preventDefault();
                e.stopPropagation();
              }
              return window.handleEndSession(e);
            };
            endSessionBtn.style.display = 'block';
            console.log('End session button configured with booking_id:', data.booking_id);
            console.log('End session button shown with booking_id:', data.booking_id);
          } else {
            console.warn('End session button or booking_id not available');
            if (endSessionBtn) {
              endSessionBtn.style.display = 'none';
            }
          }
        } else {
          // Show waiting message
          if (timeInfoEl) {
            timeInfoEl.style.display = 'none';
          }
          if (waitingEl) {
            waitingEl.style.display = 'block';
          }
          if (endSessionBtn) {
            endSessionBtn.style.display = 'none';
            endSessionBtn.removeAttribute('data-booking-id');
          }
        }
        
        // Show modal
        if (typeof bootstrap !== 'undefined') {
          var modal = new bootstrap.Modal(modalElement);
          modal.show();
          console.log('Session modal shown');
        } else {
          console.error('Bootstrap not available');
          alert('Error: Bootstrap modal library not loaded. Please refresh the page.');
        }
      } else {
        alert('You do not have an active session.');
        console.log('No active booking found');
      }
    })
    .catch(error => {
      console.error('Error checking session:', error);
      alert('Error loading session information: ' + error.message);
    });
};

// Add session check button and polling
document.addEventListener('DOMContentLoaded', function() {
  // Note: checkMyActiveSession is now called periodically in the main DOMContentLoaded handler

  // Lightweight polling for faculty bulk booking decision for this user
  // Shows a one-time notification using localStorage to avoid repeats
  function pollFacultyBookingNotice() {
    fetch('/ajax/check-faculty-booking-status/', { cache: 'no-store' })
      .then(function(r){ return r.ok ? r.json() : { has_update:false }; })
      .then(function(data){
        if (!data || !data.has_update) return;
        var key = 'seenFacultyBooking_' + (data.booking_id || '');
        var already = localStorage.getItem(key);
        if (already) return;
        // Only notify when status is confirmed or cancelled
        if (data.status === 'confirmed' || data.status === 'cancelled') {
          // Build a centered Bootstrap modal instead of alert()
          function ensureModal() {
            var el = document.getElementById('centerNoticeModal');
            if (el) return el;
            el = document.createElement('div');
            el.id = 'centerNoticeModal';
            el.className = 'modal fade';
            el.innerHTML = '\n<div class="modal-dialog modal-dialog-centered">\n  <div class="modal-content">\n    <div class="modal-header">\n      <h5 class="modal-title"></h5>\n      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n    </div>\n    <div class="modal-body"></div>\n    <div class="modal-footer">\n      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n    </div>\n  </div>\n</div>';
            document.body.appendChild(el);
            return el;
          }
          function setModal(title, html, status) {
            var el = ensureModal();
            var titleEl = el.querySelector('.modal-title');
            var bodyEl = el.querySelector('.modal-body');
            titleEl.textContent = title;
            bodyEl.innerHTML = html;
            // Header color by status
            var header = el.querySelector('.modal-header');
            header.classList.remove('bg-success','bg-danger','text-white');
            if (status === 'confirmed') { header.classList.add('bg-success','text-white'); }
            if (status === 'cancelled') { header.classList.add('bg-danger','text-white'); }
            var modal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(el) : null;
            if (modal) modal.show(); else alert(title + '\n' + bodyEl.textContent);
          }
          var heading = 'Faculty bulk booking ' + (data.status === 'confirmed' ? 'APPROVED' : 'DECLINED');
          var body = '<div class="mb-2"><strong>Faculty:</strong> ' + (data.faculty_name || 'N/A') + '</div>' +
                     (data.start ? '<div class="mb-1"><strong>Start:</strong> ' + new Date(data.start).toLocaleString() + '</div>' : '') +
                     (data.end ? '<div class="mb-1"><strong>End:</strong> ' + new Date(data.end).toLocaleString() + '</div>' : '');
          setModal(heading, body, data.status);
          localStorage.setItem(key, '1');
        }
      })
      .catch(function(){ /* ignore */ });
  }
  // Run immediately and then every 30s
  pollFacultyBookingNotice();
  setInterval(pollFacultyBookingNotice, 30000);
  
  // Handle end session button - use direct onclick handler
  // Store booking_id in a variable accessible to the handler
  window.currentBookingId = null;
  
  // Function to handle end session early from timeRemainingModal
  window.handleEndSessionEarly = function(e) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    var btn = document.getElementById('end-session-early-btn');
    var bookingId = btn ? btn.getAttribute('data-booking-id') : null;
    
    // Also try to get booking ID from hidden field or other sources
    if (!bookingId || bookingId === '' || bookingId === 'null' || bookingId === 'undefined') {
      var bookingIdEl = document.getElementById('booking_id');
      if (bookingIdEl) {
        bookingId = bookingIdEl.textContent || bookingIdEl.value;
      }
    }
    
    if (!bookingId || bookingId === '' || bookingId === 'null' || bookingId === 'undefined') {
      alert('Error: Booking ID not found. Please refresh the page and try again.');
      return false;
    }
    
    bookingId = String(bookingId).trim();
    
    if (!bookingId || isNaN(parseInt(bookingId))) {
      alert('Error: Invalid booking ID format. Please refresh the page and try again.');
      return false;
    }
    
    if (confirm('Are you sure you want to end your session early?')) {
      var url = '/ajax/end-session/' + bookingId + '/';
      console.log('Ending session with booking ID:', bookingId);
      console.log('URL:', url);
      
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                        document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '',
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          return response.text().then(text => {
            console.error('Error response:', text);
            throw new Error('HTTP error! status: ' + response.status);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('End session response:', data);
        if (data.success) {
          alert(data.message || 'Session ended successfully');
          // Close the modal
          var modal = bootstrap.Modal.getInstance(document.getElementById('timeRemainingModal'));
          if (modal) modal.hide();
          location.reload();
        } else {
          alert('Error: ' + (data.error || data.message || 'Failed to end session'));
        }
      })
      .catch(error => {
        console.error('Error ending session:', error);
        alert('Error: Failed to end session. ' + error.message + '\nPlease try again.');
      });
    }
    return false;
  };

  // Function to handle end session click
  // Note: handleEndSession is now defined in the extra_head block section above
  // so it's available before the HTML that uses it
  
  // Set onclick directly on button (will be set when button is shown)
  // Note: The onclick is also set in showMySessionModal when the modal is opened
  var endSessionBtn = document.getElementById('end-session-btn');
  if (endSessionBtn) {
    endSessionBtn.onclick = function(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      return window.handleEndSession(e);
    };
  }
  
  // Handle "My Session" button click (header button)
  var showMySessionBtn = document.getElementById('showMySessionBtn');
  if (showMySessionBtn) {
    showMySessionBtn.addEventListener('click', function() {
      // Show modal with session information
      showMySessionModal();
    });
  }
  
  // Handle "My Session" button click (main button - replaces View QR Code)
  var showMySessionBtnMain = document.getElementById('showMySessionBtnMain');
  if (showMySessionBtnMain) {
    showMySessionBtnMain.addEventListener('click', function() {
      // Show modal with session information
      showMySessionModal();
    });
  }
  
  // Check for active session on page load - with a small delay to ensure DOM is ready
  // Call immediately and also after delays
  checkMyActiveSession();
  setTimeout(function() {
    checkMyActiveSession();
  }, 500);
  setTimeout(function() {
    checkMyActiveSession();
  }, 2000);
  
  // Also check periodically to ensure button visibility is correct
  setInterval(function() {
    checkMyActiveSession();
  }, 5000); // Check every 5 seconds
  
  // Also check when page becomes visible (user switches tabs back)
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      console.log('Page became visible, checking active session');
      checkMyActiveSession();
    }
  });
  
  // Mobile menu toggle in reservation body
  function initMobileMenuToggleReservation() {
    var mobileMenuToggleReservation = document.getElementById('mobile-menu-toggle-reservation');
    var mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    var mobileNav = document.getElementById('mobile-nav');
    var mobileNavOverlay = document.getElementById('mobile-nav-overlay');
    var sidebar = document.getElementById('sidebar');
    var sidebarOverlay = document.getElementById('sidebar-overlay');
    
    console.log('Initializing mobile menu toggle reservation', {
      button: mobileMenuToggleReservation,
      mobileNav: mobileNav,
      sidebar: sidebar
    });
    
    if (mobileMenuToggleReservation) {
      // Hide the original mobile menu toggle in header
      if (mobileMenuToggle) {
        mobileMenuToggle.style.display = 'none';
      }
      
      // Remove any existing event listeners by cloning the element
      var newButton = mobileMenuToggleReservation.cloneNode(true);
      mobileMenuToggleReservation.parentNode.replaceChild(newButton, mobileMenuToggleReservation);
      
      newButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Mobile menu toggle clicked');
        
        // Mobile navigation for regular users
        if (mobileNav) {
          if (mobileNav.classList.contains('active')) {
            mobileNav.classList.remove('active');
            if (mobileNavOverlay) mobileNavOverlay.classList.remove('active');
            document.body.style.overflow = '';
            console.log('Mobile nav closed');
          } else {
            mobileNav.classList.add('active');
            if (mobileNavOverlay) mobileNavOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Mobile nav opened');
          }
        }
        
        // Staff sidebar toggle
        if (sidebar && !mobileNav) {
          if (sidebar.classList.contains('mobile-open')) {
            sidebar.classList.remove('mobile-open');
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
            console.log('Sidebar closed');
          } else {
            sidebar.classList.add('mobile-open');
            if (sidebarOverlay) sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Sidebar opened');
          }
        }
      });
    } else {
      console.warn('Mobile menu toggle reservation button not found');
    }
  }
  
  // Initialize mobile menu toggle - try multiple times to ensure DOM is ready
  initMobileMenuToggleReservation();
  setTimeout(initMobileMenuToggleReservation, 100);
  setTimeout(initMobileMenuToggleReservation, 500);
});
</script>
<script src="{% static 'js/reserve_pc.js' %}"></script>
{% endblock %}