{% extends "base.html" %}
{% load static %}
{% block title %}Chat{% endblock %}
{% block links %}
<link rel="stylesheet" href="{% static 'css/booking.css' %}?v=10">
<style>
/* Messenger-like Chat Container */
.chat-wrapper {
  display: flex;
  height: calc(100vh - 100px);
  max-width: 100%;
  margin: 0;
  padding: 0;
  background: #1c1c1c;
  position: relative;
  overflow: hidden;
}


/* Conversation List Sidebar */
.conversations-sidebar {
  width: 350px;
  min-width: 300px;
  background: #242526;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.conversations-header {
  padding: 15px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: #242526;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.conversations-header h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #e4e6eb;
}


.conversations-list {
  flex: 1;
  overflow-y: auto;
  background: #242526;
}

.conversation-item {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  cursor: pointer;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  transition: background-color 0.2s;
  text-decoration: none;
  color: inherit;
}

.conversation-item:hover {
  background-color: #3a3b3c;
}

.conversation-item.active {
  background-color: #3a3b3c;
  border-left: 3px solid #8A2BE2;
}

.conversation-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-right: 12px;
  object-fit: cover;
  flex-shrink: 0;
}

.conversation-avatar-placeholder {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  margin-right: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.conversation-info {
  flex: 1;
  min-width: 0;
}

.conversation-name {
  font-weight: 600;
  font-size: 0.9375rem;
  color: #e4e6eb;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conversation-preview {
  font-size: 0.8125rem;
  color: #b0b3b8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conversation-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  margin-left: 12px;
}

.conversation-time {
  font-size: 0.75rem;
  color: #b0b3b8;
  margin-bottom: 4px;
}

.unread-badge {
  background: #8A2BE2;
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 600;
}

/* Main Chat Area */
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #242526;
  position: relative;
  overflow: hidden;
  min-height: 0;
}

.chat-placeholder {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #b0b3b8;
  font-size: 1.2rem;
  text-align: center;
  padding: 40px;
}

.chat-placeholder.hidden {
  display: none;
}

.chat-header {
  padding: 12px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: #242526;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.chat-header-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 12px;
  object-fit: cover;
}

.chat-header-avatar-placeholder {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 1rem;
}

.chat-header-name {
  font-weight: 600;
  font-size: 1rem;
  color: #e4e6eb;
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px;
  background: #1c1c1c;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
  /* Start scroll at top for newest messages */
  scroll-behavior: smooth;
}

/* Empty state styling */
.messages-container .empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  color: #b0b3b8;
  text-align: center;
  min-height: 200px;
}

.messages-container .empty-state i {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.5;
}

.messages-container .empty-state p {
  margin: 0;
  font-size: 1rem;
  color: #b0b3b8;
}

.message-wrapper {
  display: flex;
  margin-bottom: 8px;
  margin-top: 0;
  align-items: flex-end;
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.sent {
  justify-content: flex-end;
}

.message-wrapper.received {
  justify-content: flex-start;
}

.message-bubble {
  max-width: 60%;
  padding: 10px 14px;
  border-radius: 18px;
  word-wrap: break-word;
  position: relative;
  font-size: 0.9375rem;
  line-height: 1.4;
}

.message-bubble.sent {
  background: #8A2BE2;
  color: white;
  border-bottom-right-radius: 4px;
}

.message-bubble.received {
  background: #3a3b3c;
  color: #e4e6eb;
  border-bottom-left-radius: 4px;
}

.message-time {
  font-size: 0.6875rem;
  color: #65676b;
  margin-top: 4px;
  padding: 0 4px;
}

.message-bubble.sent .message-time {
  color: rgba(255, 255, 255, 0.7);
  text-align: right;
}

.message-bubble.received .message-time {
  color: #b0b3b8;
  text-align: left;
}

/* Input Area */
.chat-input-area {
  padding: 12px 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  background: #242526;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
}

@media (max-width: 768px) {
  .chat-input-area {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    box-sizing: border-box;
    padding: 10px 15px;
    z-index: 100;
    background: #242526;
  }
}

.chat-input-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  background: #3a3b3c;
  border-radius: 20px;
  padding: 8px 16px;
}

.chat-input-wrapper textarea {
  flex: 1;
  border: none;
  background: transparent;
  resize: none;
  font-size: 0.9375rem;
  max-height: 100px;
  padding: 0;
  outline: none;
  color: #e4e6eb;
  font-family: inherit;
}

.chat-input-wrapper textarea::placeholder {
  color: #b0b3b8;
}

.send-button {
  background: #8A2BE2;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s;
  flex-shrink: 0;
}

.send-button:hover {
  background: #7B1FA2;
}

.send-button:disabled {
  background: #e4e6eb;
  cursor: not-allowed;
}

/* Staff Search Section */
.staff-search-section {
  padding: 15px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: #242526;
  flex-shrink: 0;
}

.staff-search-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
}

.staff-search-controls input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  background: #3a3b3c;
  color: #e4e6eb;
  font-size: 0.875rem;
}

.staff-search-controls input::placeholder {
  color: #b0b3b8;
}

.staff-search-controls button {
  padding: 8px 16px;
  border: none;
  border-radius: 20px;
  font-size: 0.875rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-search {
  background: #8A2BE2;
  color: white;
}

.btn-search:hover {
  background: #7B1FA2;
}

.btn-clear {
  background: #3a3b3c;
  color: #e4e6eb;
}

.btn-clear:hover {
  background: #4e4f50;
}

.user-search-results {
  margin-top: 10px;
}

.user-search-result {
  padding: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: background-color 0.2s;
  background: #3a3b3c;
  color: #e4e6eb;
}

.user-search-result:hover {
  background: #4e4f50;
}

/* Full-screen mode */
.chat-wrapper.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
  background: #1c1c1c;
}

.chat-wrapper.fullscreen .conversations-sidebar {
  display: none;
}

.chat-wrapper.fullscreen .chat-main {
  width: 100%;
}

.chat-header-back {
  display: none;
  margin-right: 12px;
  background: none;
  border: none;
  color: #e4e6eb;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: background-color 0.2s;
  width: 36px;
  height: 36px;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.chat-header-back:hover {
  background-color: #3a3b3c;
}

.chat-wrapper.fullscreen .chat-header-back {
  display: flex;
}

@media (max-width: 768px) {
  .chat-header-back {
    display: flex;
  }
  
  .chat-wrapper.fullscreen {
    top: 0;
    height: 100vh;
  }
  
  body {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
  
  #content {
    overflow: hidden !important;
    height: 100vh !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  .chat-wrapper {
    flex-direction: column;
    height: calc(100vh - 80px);
    position: fixed;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    max-width: 100%;
    z-index: 1;
    overflow: hidden;
  }
  
  .conversations-sidebar {
    width: 100%;
    height: 250px;
    min-height: 200px;
    max-height: 40vh;
    border-right: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .chat-main {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .messages-container {
    padding: 15px;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  
  .chat-input-area {
    position: sticky;
    bottom: 0;
    z-index: 100;
    background: #242526;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
  }
  
  .chat-header {
    padding: 10px 15px;
    flex-shrink: 0;
    position: sticky;
    top: 0;
    z-index: 10;
    background: #242526;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .conversations-header {
    padding: 12px 15px;
  }
  
  .conversations-header h3 {
    font-size: 1.25rem;
  }
  
  .staff-search-section {
    padding: 12px 15px;
  }
  
  .staff-search-controls {
    flex-wrap: wrap;
  }
  
  .staff-search-controls button {
    flex: 1;
    min-width: 80px;
  }
}

@media (max-width: 480px) {
  .chat-wrapper {
    height: calc(100vh - 100px);
    top: 100px;
  }
  
  .conversations-sidebar {
    height: 200px;
    max-height: 35vh;
  }
  
  .message-bubble {
    max-width: 80%;
  }
  
  .chat-input-wrapper {
    padding: 6px 12px;
  }
  
  .send-button {
    width: 32px;
    height: 32px;
    font-size: 0.875rem;
  }
}

.empty-state {
  text-align: center;
  color: #65676b;
  padding: 40px 20px;
  pointer-events: none; /* do not block clicks on list items above */
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 16px;
  color: #bcc0c4;
}

/* Telegram-like quick message modal */
.tg-modal { border-radius: 14px; background: #2b2b2b; color: #e4e6eb; }
.tg-modal-header { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
.tg-avatar { width:36px; height:36px; border-radius:50%; background: linear-gradient(135deg,#667eea,#764ba2); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
.tg-title { font-weight:600; }
.tg-modal-body { padding:12px 16px; display:flex; flex-direction:column; height: 70vh; }
.tg-messages { flex:1 1 auto; overflow-y:auto; padding: 6px 2px 10px 2px; display:flex; flex-direction:column; gap:8px; }
.tg-msg { max-width: 80%; padding:10px 14px; border-radius:18px; font-size:0.9375rem; line-height:1.4; }
.tg-msg.sent { align-self:flex-end; background:#8A2BE2; color:#fff; border-bottom-right-radius:4px; }
.tg-msg.received { align-self:flex-start; background:#3a3b3c; color:#e4e6eb; border-bottom-left-radius:4px; }
.tg-input { width:100%; background:#3a3b3c; border: none; color:#e4e6eb; border-radius: 12px; padding:12px 14px; resize: none; outline: none; }
.tg-modal-footer { display:flex; justify-content:flex-end; gap:10px; align-items:center; padding:10px 12px; border-top: 1px solid rgba(255,255,255,0.08); }
.tg-btn-cancel { background:#3a3b3c; color:#e4e6eb; border:none; border-radius:10px; padding:8px 14px; }
.tg-btn-send { background:#8A2BE2; color:#fff; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
.tg-btn-send:hover { background:#7B1FA2; }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
  {% csrf_token %}
  <!-- Conversations Sidebar -->
  <div class="conversations-sidebar">
    <div class="conversations-header">
    </div>
    
    {% if request.user.is_staff or request.user.profile.role == 'staff' %}
    <div class="staff-search-section">
      <div class="staff-search-controls">
        <input type="text" id="find_user" name="find_user" placeholder="Search user..." class="form-control">
        <button type="button" class="btn-search" onclick="findUser()">Search</button>
        <button type="button" class="btn-clear" onclick="resetTable()">Clear</button>
      </div>
      <div id="user-search-results" class="user-search-results" style="display: none;"></div>
      <div id="recent-users" class="user-search-results"></div>
    </div>
    {% endif %}
    
    <!-- PCheck Support - Only visible for students and faculty (not admin/staff) -->
    <div class="conversations-list" id="conversationsList">
      {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
      <!-- FORCE PCheck Support to show immediately for students and faculty only -->
      <a href="#" class="conversation-item" id="pcheckSupportItem" 
         data-receiver-id="pcheck" 
         data-receiver-email="PCheck" 
         data-receiver-name="PCheck Support"
         data-is-staff="true">
        <div class="conversation-avatar-placeholder" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">PC</div>
        <div class="conversation-info">
          <div class="conversation-name">PCheck Support</div>
          <div class="conversation-preview">Get help from our support team</div>
        </div>
        <div class="conversation-meta">
          <i class="fa-solid fa-headset" style="color: #ff6b35; font-size: 1.2rem;"></i>
        </div>
      </a>
      {% endif %}
      
      <div class="empty-state" id="emptyStateBlock">
        <i class="fa-solid fa-comments"></i>
        <p>No conversations yet</p>
      </div>
    </div>
  </div>
  
  <!-- Main Chat Area -->
  <div class="chat-main" id="chatMainArea">
    <div id="activeChat" style="display: none; flex-direction: column; height: 100%;">
      <div class="chat-header" id="chatHeader">
        <button class="chat-header-back" id="chatHeaderBack" title="Back to conversations">
          <i class="fa-solid fa-arrow-left"></i>
        </button>
        <div class="chat-header-avatar-placeholder" id="chatHeaderAvatar">
          <i class="fa-solid fa-user"></i>
        </div>
        <div class="chat-header-name" id="chatHeaderName"></div>
      </div>
      
      <div class="messages-container" id="messagesContainer"></div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea id="new_message" rows="1" placeholder="Type a message..." style="overflow-y: auto;"></textarea>
        </div>
        <button class="send-button" id="send_new_message_btn" type="button">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

        <!-- Telegram-like Quick Message Modal -->
        <div class="modal fade" id="initMessageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
    <div class="modal-content tg-modal shadow">
      <div class="tg-modal-header">
        <div class="tg-avatar">PC</div>
        <div class="tg-title">PCheck Support</div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="tg-modal-body">
        <div id="tgMessages" class="tg-messages"></div>
        <input type="hidden" id="recipientHidden" value="PCheck">
        <textarea id="initMessage" class="tg-input" rows="3" placeholder="Write a message..."></textarea>
      </div>
      <div class="tg-modal-footer">
        {% csrf_token %}
        <button type="button" class="tg-btn-cancel" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="send_init_message" class="tg-btn-send" data-send-init-message-url="{% url 'main_app:send-init-message' %}" onclick="sendMessageFromModal(); return false;">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const currentUserId = "{{ request.user.id }}";
const currentUserEmail = "{{ request.user.email }}";
let chatSocket = null;
let currentRoomId = null;
let currentReceiver = null;

// Ensure AJAX doesn't use cache on this page
if (typeof $ === 'undefined') {
  (function waitForJQ(){
    if (typeof $ !== 'undefined') {
      $.ajaxSetup({ cache: false, headers: { 'Cache-Control': 'no-store' } });
      try { loadMessages(); } catch(_) {}
    } else {
      setTimeout(waitForJQ, 100);
    }
  })();
} else {
  $.ajaxSetup({ cache: false, headers: { 'Cache-Control': 'no-store' } });
}

// Helper function to get CSRF token from multiple sources
function getCSRFToken() {
  // Try jQuery first
  if (typeof $ !== 'undefined') {
    var token = $('[name=csrfmiddlewaretoken]').val();
    if (token) return token;
  }
  // Try native DOM
  var input = document.querySelector('[name=csrfmiddlewaretoken]');
  if (input && input.value) return input.value;
  // Try getting from cookies (Django CSRF cookie)
  var cookies = document.cookie.split(';');
  for (var i = 0; i < cookies.length; i++) {
    var cookie = cookies[i].trim();
    if (cookie.startsWith('csrftoken=')) {
      return cookie.substring('csrftoken='.length);
    }
  }
  return '';
}

// Format time for display
function formatTime(timestamp) {
  if (!timestamp) return 'Just now';
  
  // Handle both ISO format and old string format
  let date;
  if (typeof timestamp === 'string') {
    // If it's in the old format 'YYYY-MM-DD HH:MM:SS', convert it
    if (timestamp.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
      // Old format without timezone - assume it's UTC and convert to local
      date = new Date(timestamp.replace(' ', 'T') + 'Z');
    } else {
      // ISO format or other valid date string
      date = new Date(timestamp);
    }
  } else {
    date = new Date(timestamp);
  }
  
  // Check if date is valid
  if (isNaN(date.getTime())) {
    return 'Just now';
  }
  
  const now = new Date();
  const diff = now - date;
  
  // Handle negative differences (future dates) - should not happen but handle gracefully
  if (diff < 0) {
    return 'Just now';
  }
  
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}

// Get initials for avatar
function getInitials(name) {
  if (!name) return '?';
  const parts = name.trim().split(' ');
  if (parts.length >= 2) {
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }
  return name[0].toUpperCase();
}

// Check if user is staff/admin
function isStaffUser(user) {
  // Treat either Django is_staff or profile role 'staff' as staff
  return (user && (user.is_staff === true || user.role === 'staff'));
}

// Get display name - show "PCheck Support" for staff/admin
function getDisplayName(user) {
  if (isStaffUser(user)) {
    return 'PCheck Support';
  }
  return `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email || 'User';
}

// Create conversation item HTML
function createConversationItem(room, otherUser) {
  const hasUnread = room.chats && Array.isArray(room.chats) && 
    room.chats.some(chat => chat.status === "sent" && 
    String(chat.sender) != String(currentUserId) && 
    String(chat.recipient) == String(currentUserId));
  
  const lastMessage = room.chats && room.chats.length > 0 
    ? room.chats[room.chats.length - 1] 
    : null;
  
  const preview = lastMessage ? lastMessage.message.substring(0, 40) + (lastMessage.message.length > 40 ? '...' : '') : 'No messages yet';
  const time = lastMessage ? formatTime(lastMessage.timestamp) : '';
  const displayName = getDisplayName(otherUser);
  const actualName = `${otherUser.first_name || ''} ${otherUser.last_name || ''}`.trim() || otherUser.email || 'User';
  
  return `
    <a href="#" class="conversation-item" data-room-id="${room.id}" 
       data-receiver-id="${otherUser.id}" 
       data-receiver-email="${otherUser.email}"
       data-receiver-name="${displayName}"
       data-is-staff="${isStaffUser(otherUser) ? 'true' : 'false'}">
      <div class="conversation-avatar-placeholder">${getInitials(displayName)}</div>
      <div class="conversation-info">
        <div class="conversation-name">${displayName}</div>
        <div class="conversation-preview">${preview}</div>
      </div>
      <div class="conversation-meta">
        ${time ? `<div class="conversation-time">${time}</div>` : ''}
        ${hasUnread ? '<div class="unread-badge">!</div>' : ''}
      </div>
    </a>
  `;
}

// Create default PCheck Support item (only for students and faculty, not admin/staff)
function renderPCheckSupportItem(isStaff = false){
  // Only generate for non-staff users
  if (isStaff) {
    return ''; // Return empty string for staff/admin - they should not see PCheck Support
  }
  return `
    <a href="#" class="conversation-item" id="pcheckSupportItem" 
       data-receiver-id="pcheck" 
       data-receiver-email="PCheck" 
       data-receiver-name="PCheck Support"
       data-is-staff="true">
      <div class="conversation-avatar-placeholder" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">PC</div>
      <div class="conversation-info">
        <div class="conversation-name">PCheck Support</div>
        <div class="conversation-preview">Get help from our support team</div>
      </div>
      <div class="conversation-meta">
        <i class="fa-solid fa-headset" style="color: #ff6b35; font-size: 1.2rem;"></i>
      </div>
    </a>
  `;
}

// Create a user list item (no existing room)
function createUserItem(user) {
  const displayName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email || 'User';
  return `
    <a href="#" class="conversation-item user-item" 
       data-receiver-id="${user.id}" 
       data-receiver-email="${user.email}" 
       data-receiver-name="${displayName}">
      <div class="conversation-avatar-placeholder">${getInitials(displayName)}</div>
      <div class="conversation-info">
        <div class="conversation-name">${displayName}</div>
        <div class="conversation-preview">Tap to start chat</div>
      </div>
    </a>
  `;
}

// Load conversations
function loadMessages() {
  $.ajax({
    url: "/ajax/load-messages/?_=" + Date.now(),
    method: "GET",
    cache: false,
    headers: { 'Cache-Control': 'no-store' },
    dataType: 'json',
    success: function(data) {
      try { if (typeof data === 'string') { data = JSON.parse(data); } } catch(e) { console.error('parse error', e, data); }
      const conversationsList = $("#conversationsList");
      conversationsList.empty();
      
      if (!data || !data.result || data.result.length === 0) {
      {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
      // FORCE PCheck Support to show for students and faculty - always at the top
      conversationsList.empty(); // Clear any existing items
      conversationsList.prepend(renderPCheckSupportItem(false));
      // Hide empty state since PCheck Support is available
      $("#emptyStateBlock").hide();
      // Ensure PCheck Support click handler is attached
      $("#pcheckSupportItem").off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openPCheck === 'function') {
          openPCheck();
        }
      });
      {% endif %}

        // If staff/admin, still show all users even when there are no conversations yet
        {% if request.user.is_staff or request.user.profile.role == 'staff' %}
        $.ajax({ url: '/ajax/all-users/?_=' + Date.now(), method: 'GET', cache: false })
          .done(function(uData){
            if (uData && uData.result && uData.result.length) {
              // Clear empty state and render users
              conversationsList.empty();
              uData.result.forEach(function(u){
                // Skip PCheck Support user for admin/staff
                const isPCheckSupport = (
                  u.email === 'support@pcheck.psu.palawan.edu.ph' ||
                  (u.first_name === 'PCheck' && u.last_name === 'Support') ||
                  (u.email && u.email.toLowerCase().includes('pcheck') && u.email.toLowerCase().includes('support'))
                );
                if (isPCheckSupport) {
                  return; // Skip PCheck Support
                }
                const html = createUserItem(u);
                conversationsList.append(html);
              });
              $(".user-item").on("click", function(e){
                e.preventDefault();
                const receiverName = $(this).data('receiver-name');
                const receiverEmail = $(this).data('receiver-email');
                const receiverId = $(this).data('receiver-id');
                $(".conversation-item").removeClass('active');
                $(this).addClass('active');
                // Only enable fullscreen mode on mobile (screen width <= 768px)
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                  $(".chat-wrapper").addClass('fullscreen');
                } else {
                  $(".chat-wrapper").removeClass('fullscreen');
                }
                  $("#activeChat").show().css('display','flex');
                $("#chatHeaderName").text(receiverName);
                $("#chatHeaderAvatar").html(getInitials(receiverName));
                currentReceiver = { id: receiverId, email: receiverEmail, name: receiverName };
                currentRoomId = null;
                $("#messagesContainer").html('<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>');
                $("#new_message").focus();
              });
            }
          });
        {% endif %}

        // Retry after short delays (up to 3 attempts) to mitigate races
        let attempts = 0;
        function retryLoad() {
          if (attempts >= 3) return;
          attempts++;
          $.ajax({ url: "/ajax/load-messages/?_=" + Date.now(), method: "GET", cache: false, headers: { 'Cache-Control': 'no-store' }, dataType: 'json' })
            .done(function(retryData){
              try { if (typeof retryData === 'string') { retryData = JSON.parse(retryData); } } catch(e) { console.error('retry parse error', e, retryData); }
              if (retryData && retryData.result && retryData.result.length) {
                conversationsList.empty();
                let seenRooms = new Set();
                let hasStaffConv = false;
                retryData.result.forEach(room => {
                  if (!seenRooms.has(room.id)) {
                    seenRooms.add(room.id);
                    const other = (String(currentUserId) == String(room.receiver.id)) ? room.initiator : room.receiver;
                    {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
                    // For non-staff users, skip conversations with staff members since we show static PCheck Support
                    const isOtherStaff = other.is_staff === true || other.role === 'staff';
                    if (isOtherStaff) {
                      hasStaffConv = true;
                      return; // Skip adding this conversation
                    }
                    {% else %}
                    // For admin/staff users, skip PCheck Support conversations
                    const isPCheckSupport = (
                      other.email === 'support@pcheck.psu.palawan.edu.ph' ||
                      other.first_name === 'PCheck' && other.last_name === 'Support' ||
                      String(other.id) === 'pcheck' ||
                      (other.email && other.email.toLowerCase().includes('pcheck') && other.email.toLowerCase().includes('support'))
                    );
                    if (isPCheckSupport) {
                      // Skip PCheck Support conversations for admin/staff
                      return;
                    }
                    {% endif %}
                    const item = createConversationItem(room, other);
                    conversationsList.append(item);
                  }
                });
                {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
                // Always add PCheck Support at the top for faculty/students
                $("#pcheckSupportItem").remove();
                conversationsList.prepend(renderPCheckSupportItem(false));
                {% endif %}
                $(".conversation-item").on("click", function(e) {
                  e.preventDefault();
                  if (this.id === 'pcheckSupportItem') { try { openPCheck(); } catch(_) {} return; }
                  const roomId = $(this).data('room-id');
                  const receiverName = $(this).data('receiver-name');
                  const receiverEmail = $(this).data('receiver-email');
                  const receiverId = $(this).data('receiver-id');
                  $(".conversation-item").removeClass('active');
                  $(this).addClass('active');
                  // Only enable fullscreen mode on mobile (screen width <= 768px)
                  const isMobile = window.innerWidth <= 768;
                  if (isMobile) {
                    $(".chat-wrapper").addClass('fullscreen');
                  } else {
                    $(".chat-wrapper").removeClass('fullscreen');
                  }
                  $("#activeChat").show().css('display', 'flex');
                  const isStaff = $(this).data('is-staff') === true || $(this).data('is-staff') === 'true';
                  const displayName = isStaff ? 'PCheck Support' : receiverName;
                  $("#chatHeaderName").text(displayName);
                  $("#chatHeaderAvatar").html(getInitials(displayName));
                  currentReceiver = { id: receiverId, email: receiverEmail, name: receiverName };
                  loadConversation(roomId);
                });
                
              } else {
                setTimeout(retryLoad, attempts * 400); // backoff
              }
            })
            .fail(function(){ setTimeout(retryLoad, attempts * 400); });
        }
        setTimeout(retryLoad, 400);
        {% if request.user.is_staff or request.user.profile.role == 'staff' %}
        // Even if there are no conversations, ensure staff list is displayed
        ensureStaffUserList(new Set());
        {% endif %}
        return;
      }
      
      let seenRooms = new Set();
      let seenUserIds = new Set();
      let hasStaffConversation = false;
      
      data.result.forEach(room => {
        if (!seenRooms.has(room.id)) {
          seenRooms.add(room.id);
          const other = (String(currentUserId) == String(room.receiver.id)) ? room.initiator : room.receiver;
          if (other && other.id) { seenUserIds.add(String(other.id)); }
          
          {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
          // For non-staff users, skip conversations with staff members since we show static PCheck Support
          const isOtherStaff = other.is_staff === true || other.role === 'staff';
          if (isOtherStaff) {
            hasStaffConversation = true;
            // Skip adding this conversation - we'll use the static PCheck Support item instead
            return;
          }
          {% else %}
          // For admin/staff users, skip PCheck Support conversations
          const isPCheckSupport = (
            other.email === 'support@pcheck.psu.palawan.edu.ph' ||
            other.first_name === 'PCheck' && other.last_name === 'Support' ||
            String(other.id) === 'pcheck' ||
            (other.email && other.email.toLowerCase().includes('pcheck') && other.email.toLowerCase().includes('support'))
          );
          if (isPCheckSupport) {
            // Skip PCheck Support conversations for admin/staff
            return;
          }
          {% endif %}
          
          const item = createConversationItem(room, other);
          conversationsList.append(item);
        }
      });

      // FORCE PCheck Support to stay at top for students and faculty only
      // Show PCheck Support only for students and faculty (not admin/staff)
      // Remove any existing PCheck Support items first to avoid duplicates
      $("#pcheckSupportItem").remove();
      
      {% if request.user.is_staff or request.user.profile.role == 'staff' %}
      // For admin/staff, remove any PCheck Support conversations or user items that might be in the DOM
      $(".conversation-item").each(function() {
        const receiverEmail = $(this).data('receiver-email');
        const receiverName = $(this).data('receiver-name');
        const receiverId = $(this).data('receiver-id');
        const isPCheckSupport = (
          receiverEmail === 'support@pcheck.psu.palawan.edu.ph' ||
          receiverEmail === 'PCheck' ||
          receiverName === 'PCheck Support' ||
          String(receiverId) === 'pcheck' ||
          String(receiverId) === '24' // PCheck Support user ID
        );
        if (isPCheckSupport) {
          $(this).remove();
        }
      });
      {% endif %}
      
      // Always add PCheck Support at the top (static item, not from actual conversation)
      {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
      // FORCE PCheck Support for students and faculty - always visible
      conversationsList.prepend(renderPCheckSupportItem(false));
      // Ensure click handler is attached
      $("#pcheckSupportItem").off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openPCheck === 'function') {
          openPCheck();
        }
      });
      {% endif %}
      // Hide empty state since PCheck Support is always available
      $("#emptyStateBlock").hide();

      // If staff/admin, also show all users not already in rooms
      {% if request.user.is_staff or request.user.profile.role == 'staff' %}
      ensureStaffUserList(seenUserIds);
      {% endif %}
      
      // Attach click handlers
      $(".conversation-item").on("click", function(e) {
        e.preventDefault();
        if (this.id === 'pcheckSupportItem') { try { openPCheck(); } catch(_) {} return; }
        const roomId = $(this).data('room-id');
        const receiverName = $(this).data('receiver-name');
        const receiverEmail = $(this).data('receiver-email');
        const receiverId = $(this).data('receiver-id');
        
        // Update active state
        $(".conversation-item").removeClass('active');
        $(this).addClass('active');
        
        // Only enable fullscreen mode on mobile (screen width <= 768px)
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          $(".chat-wrapper").addClass('fullscreen');
        } else {
          $(".chat-wrapper").removeClass('fullscreen');
        }
        
        // Show chat area
        $("#activeChat").show().css('display', 'flex');
        
        // Update header - check if staff and show PCheck Support
        const isStaff = $(this).data('is-staff') === true || $(this).data('is-staff') === 'true';
        const displayName = isStaff ? 'PCheck Support' : receiverName;
        $("#chatHeaderName").text(displayName);
        $("#chatHeaderAvatar").html(getInitials(displayName));
        
        // Store current receiver
        currentReceiver = {
          id: receiverId,
          email: receiverEmail,
          name: receiverName
        };
        
        // Load conversation
        loadConversation(roomId);
      });

      // FORCE PCheck Support to be visible for all users - especially students and faculty
      setTimeout(function() {
        const conversationsList = $("#conversationsList");
        if (conversationsList.length > 0) {
          {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
          // FORCE PCheck Support for students and faculty - always show
          if ($("#pcheckSupportItem").length === 0) {
            conversationsList.prepend(renderPCheckSupportItem(false));
          } else {
            // Ensure it's at the top
            $("#pcheckSupportItem").detach().prependTo(conversationsList);
          }
          $("#emptyStateBlock").hide();
          // Re-attach click handler
          $("#pcheckSupportItem").off('click').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof openPCheck === 'function') {
              openPCheck();
            }
          });
          {% endif %}
        }
      }, 100);
      
    },
    error: function(xhr) {
      console.error("Error loading messages:", xhr);
      $("#conversationsList").html('<div class="empty-state"><p class="text-danger">Error loading conversations</p></div>');
      // Even on error, FORCE PCheck Support to be visible for students and faculty only
      setTimeout(function() {
        const conversationsList = $("#conversationsList");
        if (conversationsList.length > 0) {
          {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
          // FORCE PCheck Support for students and faculty - always show even on error
          if ($("#pcheckSupportItem").length === 0) {
            conversationsList.prepend(renderPCheckSupportItem(false));
          } else {
            // Ensure it's at the top
            $("#pcheckSupportItem").detach().prependTo(conversationsList);
          }
          $("#emptyStateBlock").hide();
          // Re-attach click handler
          $("#pcheckSupportItem").off('click').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (typeof openPCheck === 'function') {
              openPCheck();
            }
          });
          {% endif %}
        }
      }, 100);
    }
  });
}

// Staff: ensure the user list is visible (faculty/students) to start chats
function ensureStaffUserList(seenUserIds){
  try {
    $.ajax({ url: '/ajax/all-users/?_=' + Date.now(), method: 'GET', cache: false })
      .done(function(uData){
        const conversationsList = $("#conversationsList");
        if (uData && uData.result) {
          uData.result.forEach(function(u){
            // Skip PCheck Support user for admin/staff
            const isPCheckSupport = (
              u.email === 'support@pcheck.psu.palawan.edu.ph' ||
              (u.first_name === 'PCheck' && u.last_name === 'Support') ||
              (u.email && u.email.toLowerCase().includes('pcheck') && u.email.toLowerCase().includes('support'))
            );
            if (isPCheckSupport) {
              return; // Skip PCheck Support
            }
            if (!seenUserIds || !seenUserIds.has(String(u.id))) {
              const html = createUserItem(u);
              conversationsList.append(html);
            }
          });
          $(".user-item").off('click.userItem').on("click.userItem", function(e){
            e.preventDefault();
            const receiverName = $(this).data('receiver-name');
            const receiverEmail = $(this).data('receiver-email');
            const receiverId = $(this).data('receiver-id');
            $(".conversation-item").removeClass('active');
            $(this).addClass('active');
            // Only enable fullscreen mode on mobile (screen width <= 768px)
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
              $(".chat-wrapper").addClass('fullscreen');
            } else {
              $(".chat-wrapper").removeClass('fullscreen');
            }
                  $("#activeChat").show().css('display','flex');
            $("#chatHeaderName").text(receiverName);
            $("#chatHeaderAvatar").html(getInitials(receiverName));
            currentReceiver = { id: receiverId, email: receiverEmail, name: receiverName };
            currentRoomId = null;
            $("#messagesContainer").html('<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>');
            $("#new_message").focus();
          });
        }
      })
      .fail(function(err){
        console.error('Failed to load user list for staff:', err);
      });
  } catch(err) { console.error(err); }
}

// Load conversation messages
function loadConversation(roomId) {
  // Store previous room ID to check if we're switching conversations
  const previousRoomId = currentRoomId;
  currentRoomId = roomId;
  
  // Connect WebSocket
  connectChatSocket(roomId);
  
  $.ajax({
    url: `/ajax/load-conversation/${roomId}/?_=${Date.now()}`,
    method: "GET",
    cache: false,
    headers: { 'Cache-Control': 'no-store' },
    success: function(data) {
      const messagesContainer = $("#messagesContainer");
      
      // Only empty if we're loading a different conversation
      if (previousRoomId !== roomId) {
        messagesContainer.empty();
      }
      
      if (data.result && data.result.length > 0) {
        // Backend returns newest first, so prepend each message (newest will be at top)
        data.result.forEach(msg => {
          const isSender = String(currentUserId) == String(msg.sender__id);
          // prependMessage now checks for duplicates, so it's safe to call
          prependMessage(msg.message, isSender, msg.timestamp, msg.id);
        });
        scrollToTop();
      } else {
        // Only show empty state if we're loading a new conversation
        if (previousRoomId !== roomId) {
          messagesContainer.html('<div class="empty-state"><p>No messages yet. Start the conversation!</p></div>');
        }
      }
      
      // Mark as read
      $.ajax({
        url: `/ajax/change-message-status/`,
        method: "POST",
        data: { room_id: roomId },
        beforeSend: function(xhr) {
          xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val() || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
        }
      });
    },
    error: function(xhr) {
      console.error("Error loading conversation:", xhr);
    }
  });
}

// Prepend message to chat (newest at top)
function prependMessage(message, isSender, timestamp, chatId) {
  const messagesContainer = $("#messagesContainer");
  
  // Check if message already exists to prevent duplicates
  if (chatId) {
    const existingMessage = messagesContainer.find(`[data-chat-id="${chatId}"]`);
    if (existingMessage.length > 0) {
      // Message already exists, don't add duplicate
      return;
    }
  } else {
    // For temporary messages without chatId, check by content and timestamp
    const tempId = 'temp_' + Date.now();
    const recentMessages = messagesContainer.find('.message-bubble').slice(0, 5); // Check first 5 messages (top)
    for (let i = 0; i < recentMessages.length; i++) {
      const msgText = $(recentMessages[i]).find('div').first().text().trim();
      if (msgText === message.trim() && !$(recentMessages[i]).attr('data-chat-id')) {
        // Found a temporary message with same content, don't add duplicate
        return;
      }
    }
  }
  
  const messageWrapper = $('<div class="message-wrapper"></div>');
  messageWrapper.addClass(isSender ? 'sent' : 'received');
  
  const bubble = $('<div class="message-bubble"></div>');
  bubble.addClass(isSender ? 'sent' : 'received');
  const finalChatId = chatId || 'temp_' + Date.now();
  bubble.attr('data-chat-id', finalChatId);
  
  bubble.html(`
    <div>${escapeHtml(message)}</div>
    <div class="message-time">${formatTime(timestamp)}</div>
  `);
  
  messageWrapper.append(bubble);
  messagesContainer.prepend(messageWrapper); // Prepend instead of append
  scrollToTop(); // Scroll to top instead of bottom
}

// Keep appendMessage for backward compatibility (but it will prepend)
function appendMessage(message, isSender, timestamp, chatId) {
  prependMessage(message, isSender, timestamp, chatId);
}

// Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Scroll to top (for newest messages at top)
function scrollToTop() {
  const container = document.getElementById('messagesContainer');
  if (container) {
    // Smooth scroll to top
    container.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
}

// Scroll to bottom (kept for backward compatibility)
function scrollToBottom() {
  scrollToTop(); // Use top scrolling since messages are now at top
}

// WebSocket connection
function connectChatSocket(roomId) {
  if (chatSocket && chatSocket.readyState !== WebSocket.CLOSED) {
    chatSocket.close();
  }
  
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsPath = `${wsProtocol}//${window.location.host}/ws/chat/${roomId}/`;
  
    chatSocket = new WebSocket(wsPath);
    
    chatSocket.onopen = function(e) {
    console.log("âœ… WebSocket connected for room:", roomId);
    };
    
    chatSocket.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        if (data.type === "new_message") {
        const isSender = String(currentUserId) == String(data.sender_id);
        if (!isSender || isSender) { // Show all messages
          const existingId = data.chat_id;
          // Check if message already exists before adding
          if (existingId && !document.querySelector(`[data-chat-id="${existingId}"]`)) {
            // Remove any temporary messages with the same content (optimistic updates)
            const messagesContainer = $("#messagesContainer");
            messagesContainer.find('[data-chat-id^="temp_"]').each(function() {
              const msgText = $(this).find('div').first().text().trim();
              if (msgText === data.message.trim()) {
                $(this).closest('.message-wrapper').remove();
              }
            });
            appendMessage(data.message, isSender, data.timestamp || new Date().toISOString(), existingId);
          } else if (!existingId) {
            // If no chat_id, still check for duplicates by content
            const messagesContainer = $("#messagesContainer");
            let isDuplicate = false;
            messagesContainer.find('.message-bubble').each(function() {
              const msgText = $(this).find('div').first().text().trim();
              if (msgText === data.message.trim()) {
                isDuplicate = true;
                return false; // break
              }
            });
            if (!isDuplicate) {
              appendMessage(data.message, isSender, data.timestamp || new Date().toISOString(), existingId);
            }
          }
        }
        // Don't reload all messages here - just update conversation list
        // The new message is already added above, reloading would cause duplicates
        // Only refresh conversation list to update unread counts
        setTimeout(function() {
          loadMessages();
        }, 500); // Delay to avoid race conditions
      }
    } catch (error) {
      console.error("Error parsing WebSocket message:", error);
      }
    };
    
    chatSocket.onerror = function(e) {
      console.error("âŒ WebSocket error:", e);
    };
    
    chatSocket.onclose = function(e) {
    console.log("ðŸ”Œ WebSocket closed");
  };
}

// Find user (staff only)
function findUser() {
  const query = $("#find_user").val();
  if (query !== "") {
    $.ajax({
      url: "/ajax/find-user",
      method: "GET",
      data: { find_user: query },
      success: function(data) {
        const resultsDiv = $("#user-search-results");
        resultsDiv.empty().show();
        
        if (data.result && data.result.length > 0) {
          data.result.forEach(user => {
            const resultDiv = $(`
              <div class="user-search-result" data-email="${user.email}">
                <strong>${user.first_name} ${user.last_name}</strong><br>
                <small>${user.profile__college__name || 'N/A'} - ${user.profile__course || 'N/A'}</small><br>
                <small class="text-muted">${user.email}</small>
              </div>
            `);
            resultDiv.on('click', function() {
              email = user.email;
              sendInitMessage();
            });
            resultsDiv.append(resultDiv);
          });
    } else {
          resultsDiv.html('<div class="text-muted">No users found</div>');
        }
      }
    });
  }
}

function resetTable() {
  $("#find_user").val("");
  $("#user-search-results").hide().empty();
}

let email = null;

function sendInitMessage() {
  $("#initMessageModal").modal("show");
  $("#recipient").val(email).prop("readonly", true);
}

// Send initial message handler will be attached in document.ready

  // Prefill modal when opened via PCheck item (Bootstrap fallback)
  try {
    $("#initMessageModal").on('show.bs.modal', function(e){
      var trigger = e.relatedTarget || null;
      if (trigger && trigger.id === 'pcheckSupportItem') {
        $("#recipientHidden").val('PCheck');
        $("#initMessage").val('').attr('placeholder', 'Write a message...');
        // Load conversation history with PCheck (staff) into modal
        loadPCheckConversationIntoModal();
      }
    });
  } catch(err) { /* ignore if Bootstrap not available */ }

  let modalRoomId = null;
  function tgAppend(message, isSender){
    var div = document.createElement('div');
    div.className = 'tg-msg ' + (isSender ? 'sent' : 'received');
    div.innerText = message;
    var cont = document.getElementById('tgMessages');
    if (cont) { cont.appendChild(div); cont.scrollTop = cont.scrollHeight; }
  }

  function loadPCheckConversationIntoModal(){
    modalRoomId = null;
    var cont = document.getElementById('tgMessages');
    if (cont) cont.innerHTML = '<div class="text-muted" style="align-self:center;">Loading...</div>';
    $.ajax({ url: '/ajax/load-messages/?_=' + Date.now(), method: 'GET', cache: false })
      .done(function(data){
        try { if (typeof data === 'string') data = JSON.parse(data); } catch(e){}
        if (data && data.result && data.result.length){
          // find a conversation where other side is staff
          for (var i=0;i<data.result.length;i++){
            var room = data.result[i];
            var other = (String(currentUserId) == String(room.receiver.id)) ? room.initiator : room.receiver;
            if (other && (other.is_staff === true || other.role === 'staff')){ modalRoomId = room.id; break; }
          }
          if (modalRoomId){
            $.ajax({ url: '/ajax/load-conversation/' + modalRoomId + '/?_=' + Date.now(), method:'GET', cache:false })
              .done(function(conv){
                var c = document.getElementById('tgMessages');
                if (c) c.innerHTML='';
                if (conv && conv.result){
                  conv.result.forEach(function(msg){
                    var isSender = String(currentUserId) == String(msg.sender__id);
                    tgAppend(msg.message, isSender);
                  });
                }
              });
          } else {
            var c = document.getElementById('tgMessages');
            if (c) c.innerHTML = '<div class="text-muted" style="align-self:center;">No messages yet. Start the conversation.</div>';
          }
        } else {
          var c = document.getElementById('tgMessages');
          if (c) c.innerHTML = '<div class="text-muted" style="align-self:center;">No messages yet. Start the conversation.</div>';
        }
      });
  }
  
// Initialize on page load - ensure jQuery is loaded first
(function initializeChat() {
  if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
    setTimeout(initializeChat, 100);
    return;
  }
  
  $(document).ready(function() {
    // Debounce function to prevent excessive API calls
    let loadMessagesTimeout = null;
  
  function debouncedLoadMessages(delay = 300) {
    // Clear any existing timeout
    if (loadMessagesTimeout !== null) {
      clearTimeout(loadMessagesTimeout);
      loadMessagesTimeout = null;
    }
    
    // Set new timeout
    loadMessagesTimeout = setTimeout(() => {
      try {
        loadMessages();
      } catch (error) {
        console.error('Error loading messages:', error);
      } finally {
        loadMessagesTimeout = null;
      }
    }, delay);
  }
  
  // Immediate load functions (not debounced)
  function immediateLoadMessages() {
    if (loadMessagesTimeout !== null) {
      clearTimeout(loadMessagesTimeout);
      loadMessagesTimeout = null;
    }
    try {
      loadMessages();
    } catch (error) {
      console.error('Error loading messages:', error);
    }
  }

  // Initial load (immediate)
  immediateLoadMessages();
  
  // Double-check a moment later in case of slow auth/session propagation
  setTimeout(immediateLoadMessages, 500);
  
  // Ensure PCheck Support is always visible for non-staff users (faculty/students)
  // This is a fallback in case template conditions fail
  function ensurePCheckSupportVisible() {
    {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
    const conversationsList = $("#conversationsList");
    if (conversationsList.length > 0) {
      // Check if PCheck Support item exists
      if ($("#pcheckSupportItem").length === 0) {
        // Add PCheck Support if it doesn't exist - FORCE IT TO SHOW
        console.log("Adding PCheck Support item for non-staff user");
        conversationsList.prepend(renderPCheckSupportItem(false));
        $("#emptyStateBlock").hide();
        // Re-attach click handler for PCheck Support
        $("#pcheckSupportItem").off('click').on('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (typeof openPCheck === 'function') {
            openPCheck();
          }
        });
      } else {
        // Ensure it's at the top even if it exists
        $("#pcheckSupportItem").detach().prependTo(conversationsList);
      }
    } else {
      // If conversations list doesn't exist yet, wait and try again
      setTimeout(ensurePCheckSupportVisible, 500);
    }
    {% endif %}
  }
  
  // Check for PCheck Support after a short delay to ensure DOM is ready
  // Multiple checks to ensure it's always visible
  setTimeout(ensurePCheckSupportVisible, 100);
  setTimeout(ensurePCheckSupportVisible, 500);
  setTimeout(ensurePCheckSupportVisible, 1000);
  setTimeout(ensurePCheckSupportVisible, 2000);
  setTimeout(ensurePCheckSupportVisible, 3000);
  
  // Also check after loadMessages completes - hook into the success callback
  // This is handled in the loadMessages function itself, but we add this as a safety net
  
  // Auto-open disabled - users must manually click on PCheck Support to open chat
  
  // Reload when tab gains focus or becomes visible (debounced)
  window.addEventListener('focus', function(){ 
    debouncedLoadMessages(300); 
  });
  
  document.addEventListener('visibilitychange', function(){ 
    if (!document.hidden) { 
      debouncedLoadMessages(300);
    } 
  });
  

  // Default PCheck support item handler (for all users)
  function openPCheck(){
    // Only enable fullscreen mode on mobile (screen width <= 768px)
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
      $(".chat-wrapper").addClass('fullscreen');
    } else {
      $(".chat-wrapper").removeClass('fullscreen');
    }
                  $("#activeChat").show().css('display','flex');
    $("#chatHeaderName").text('PCheck Support');
    $("#chatHeaderAvatar").html(getInitials('PCheck Support'));
    
    // For non-staff only, set receiver to PCheck (which broadcasts to all staff)
    {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
    currentReceiver = { id: null, email: 'PCheck', name: 'PCheck Support' };
    
    // Try to find existing conversation with staff
    $.ajax({ url: '/ajax/load-messages/?_=' + Date.now(), method: 'GET', cache: false })
      .done(function(data){
        try { if (typeof data === 'string') data = JSON.parse(data); } catch(e){}
        var foundRoomId = null;
        if (data && data.result && data.result.length){
          for (var i=0; i<data.result.length; i++){
            var room = data.result[i];
            var other = (String(currentUserId) == String(room.receiver.id)) ? room.initiator : room.receiver;
            // For non-staff, look for conversation with staff
            if (other && (other.is_staff === true || other.role === 'staff')){
              foundRoomId = room.id;
              break;
            }
          }
        }
        if (foundRoomId){
          currentRoomId = foundRoomId;
          loadConversation(foundRoomId);
        } else {
          currentRoomId = null;
          $("#messagesContainer").html('<div class="empty-state"><p>Start the conversation with PCheck Support.</p></div>');
        }
        $("#new_message").focus();
      })
      .fail(function(){
        currentRoomId = null;
        $("#messagesContainer").html('<div class="empty-state"><p>Start the conversation with PCheck Support.</p></div>');
        $("#new_message").focus();
      });
    {% endif %}
  }
  // Expose globally so inline onclick can access it even outside this scope
  window.openPCheck = openPCheck;
  window.openPCheckFromLink = function(e){
    try { if (e) { e.preventDefault(); e.stopPropagation(); } } catch(_) {}
    try { openPCheck(); } catch(_) {}
    return false;
  }

  // Global send function for modal (called by inline onclick)
  window.sendMessageFromModal = function(){
    var recipient = $("#recipientHidden").val() || 'PCheck';
    var initMessage = $("#initMessage").val();
    if (!initMessage || !initMessage.trim()) { return false; }

    var $btn = $("#send_init_message");
    $btn.prop('disabled', true);

    $.ajax({ 
      url: $btn.data("send-init-message-url"), 
      type: "POST", 
      data: { recipient: recipient, message: initMessage },
      beforeSend: function(xhr) {
        var token = getCSRFToken();
        if (token) { xhr.setRequestHeader("X-CSRFToken", token); }
      },
      success: function(response) {
        tgAppend(initMessage, true);
        $("#initMessage").val("");
        loadMessages();
        if (response && response.room_id) { modalRoomId = response.room_id; }
        if (response && Array.isArray(response.rooms) && response.rooms.length) { modalRoomId = response.rooms[0]; }
      },
      error: function(xhr) {
        console.error('Send failed', xhr.status, xhr.responseText);
        alert("Unable to send message. Please try again.");
      },
      complete: function(){ $btn.prop('disabled', false); }
    });
    return false;
  };

  // Also attach jQuery handler for send_init_message button
  $("#send_init_message").off('click.sendInit').on("click.sendInit", function(e) {
    e.preventDefault();
    sendMessageFromModal();
  });

  // Send new message handler (consolidated, robust)
  $("#send_new_message_btn").off("click.send").on("click.send", function () {
    const hasInput = $("#new_message").length > 0;
    const message = (hasInput ? ($("#new_message").val() || "") : "").toString().trim();
    const roomId = currentRoomId || modalRoomId || null;
    if (!message) return;

    // Don't add optimistic message - wait for server response to avoid duplicates
    // The message will appear via WebSocket or after reload
    if (hasInput) {
      $("#new_message").val("");
    }

    // If no room yet, start with PCheck Support (only for non-staff)
    if (!roomId) {
      {% if not request.user.is_staff and request.user.profile.role|default:'' != 'staff' %}
      // For non-staff, message PCheck (broadcasts to all staff)
      const recipient = (currentReceiver && currentReceiver.email) ? currentReceiver.email : "PCheck";
      $.ajax({
        url: $("#send_init_message").data("send-init-message-url"),
        type: "POST",
        data: { recipient, message, csrfmiddlewaretoken: getCSRFToken() },
        beforeSend: (xhr) => { const t = getCSRFToken(); if (t) xhr.setRequestHeader("X-CSRFToken", t); },
        success: (res) => {
          const newRoom = res && (res.room_id || (Array.isArray(res.rooms) && res.rooms[0]));
          if (newRoom) {
            const previousRoom = currentRoomId;
            currentRoomId = newRoom;
            modalRoomId = newRoom;
            connectChatSocket(newRoom);
            // Don't reload conversation immediately - WebSocket will handle the new message
            // Only load if we're switching to a different room
            if (previousRoom !== newRoom) {
              loadConversation(newRoom);
            }
            loadMessages();
          } else {
            loadMessages();
          }
        },
        error: (xhr) => {
          let msg = "Error sending message.";
          try { const j = JSON.parse(xhr.responseText); if (j && j.error) msg = j.error; } catch (_) {}
          alert(msg);
        }
      });
      return;
      {% else %}
      // Staff/admin cannot message PCheck Support
      alert("PCheck Support is not available for staff/admin users.");
      return;
      {% endif %}
    }

    // Send to existing room
    $.ajax({
      url: `/ajax/send-new-message/${roomId}/`,
      type: "POST",
      data: { message, csrfmiddlewaretoken: getCSRFToken() },
      beforeSend: (xhr) => { const t = getCSRFToken(); if (t) xhr.setRequestHeader("X-CSRFToken", t); },
      success: () => { 
        // Don't reload messages here - WebSocket will handle the new message
        // Only reload conversation list to update unread counts
        loadMessages();
        // Also update modal if open
        if (typeof tgAppend === 'function') {
          tgAppend(message, true);
        }
      },
      error: (xhr) => {
        // If forbidden to reply (e.g., room not staff-initiated), start a fresh PCheck chat and resend
        if (xhr.status === 403) {
          const recipient = (currentReceiver && currentReceiver.email) ? currentReceiver.email : 'PCheck';
          $.ajax({
            url: $("#send_init_message").data("send-init-message-url"),
            type: "POST",
            data: { recipient, message, csrfmiddlewaretoken: getCSRFToken() },
            beforeSend: (xhr2) => { const t = getCSRFToken(); if (t) xhr2.setRequestHeader("X-CSRFToken", t); },
            success: (res) => {
              const newRoom = res && (res.room_id || (Array.isArray(res.rooms) && res.rooms[0]));
              if (newRoom) {
                currentRoomId = newRoom;
                modalRoomId = newRoom;
                connectChatSocket(newRoom);
                // resend message into the new room
                $.ajax({
                  url: `/ajax/send-new-message/${newRoom}/`,
                  type: "POST",
                  data: { message, csrfmiddlewaretoken: getCSRFToken() },
                  beforeSend: (xhr3) => { const t3 = getCSRFToken(); if (t3) xhr3.setRequestHeader("X-CSRFToken", t3); },
                  complete: () => {
                    loadConversation(newRoom);
                    loadMessages();
                  }
                });
              } else {
                loadMessages();
              }
            }
          });
          return;
        }
        let msg = "Error sending message.";
        try { const j = JSON.parse(xhr.responseText); if (j && j.error) msg = j.error; } catch (_) {}
        alert(msg);
      }
    });
  });

  // Auto-resize textarea
  $("#new_message").on("input", function() {
    this.style.height = "auto";
    this.style.height = (this.scrollHeight) + "px";
    if (this.scrollHeight > 100) {
      this.style.overflowY = "auto";
    } else {
      this.style.overflowY = "hidden";
    }
  });

  // Enter key to send
  $("#new_message").on("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      $("#send_new_message_btn").click();
    }
  });

  // Back button handler to exit fullscreen
  $("#chatHeaderBack").on("click", function(e) {
    e.preventDefault();
    // Exit fullscreen mode (only relevant on mobile)
    $(".chat-wrapper").removeClass('fullscreen');
    // Hide chat
    $("#activeChat").hide();
    // Disconnect WebSocket
    if (chatSocket) {
      chatSocket.close();
      chatSocket = null;
      currentRoomId = null;
    }
    // Remove active state from conversation items
    $(".conversation-item").removeClass('active');
  });

  $(document).on('click', '#pcheckSupportItem', function(e){
    e.preventDefault();
    e.stopPropagation();
    openPCheck();
  });

  $(document).on('touchstart', '#pcheckSupportItem', function(e){
    e.preventDefault();
    e.stopPropagation();
    openPCheck();
  });

  $(document).on('keydown', '#pcheckSupportItem', function(e){
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      e.stopPropagation();
      openPCheck();
    }
  });

  // For staff: load recent users automatically
  {% if request.user.is_staff or request.user.profile.role == 'staff' %}
  $.ajax({ url: '/ajax/recent-users/?_=' + Date.now(), method: 'GET', cache: false })
    .done(function(data){
      var container = $('#recent-users');
      container.empty();
      if (data && data.result && data.result.length) {
        container.append('<div class="text-muted mb-2">Recent users</div>');
        data.result.forEach(function(user){
          var div = $('<div class="user-search-result"></div>');
          div.html('<strong>' + (user.first_name || '') + ' ' + (user.last_name || '') + '</strong><br>' +
                   '<small>' + (user["profile__college__name"] || 'N/A') + ' - ' + (user["profile__course"] || 'N/A') + '</small><br>' +
                   '<small class="text-muted">' + (user.email || '') + '</small>');
          div.on('click', function(){ window.email = user.email; sendInitMessage(); });
          container.append(div);
        });
      }
    });
  {% endif %}
  });
})(); // Close IIFE - ensure jQuery is loaded before executing
</script>
{% endblock %}
