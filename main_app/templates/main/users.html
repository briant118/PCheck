{% extends 'base.html' %}
{% load template_filters %}
{% load static %}

{% block title %}Users{% endblock %}

{% block content %}
<div class="container">

  <div class="row">
    <div class="col-md-7">
      <h4 class="mb-3">Users</h4>
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>College</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.get_full_name|default:user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.profile.college.name|default:'-' }}</td>
              <td>
                <button type="button" class="btn btn-sm btn-outline-primary start-chat-btn"
                        data-recipient-email="{{ user.email }}"
                        data-recipient-name="{{ user.first_name }} {{ user.last_name }}">
                  <i class="fa-solid fa-comments"></i> Chat
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-md-5">
      <h4 class="mb-3">Conversations</h4>
      <table class="table table-striped table-sm" id="messagesTable">
        <thead>
          <tr>
            <th>With</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Send Initial Message Modal -->
  <div class="modal fade" id="initMessageModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title">Send message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="form-group mt-2">
            <label for="recipient" class="form-label">Recipient</label>
            <input type="email" id="recipient" class="form-control">
          </div>
          <div class="form-group mt-3">
            <label for="initMessage" class="form-label">Message</label>
            <textarea id="initMessage" rows="6" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="send_init_message" class="btn btn-primary"
                  data-send-init-message-url="{% url 'main_app:send-init-message' %}">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conversation Modal -->
  <div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-3 shadow">
        <div class="modal-header">
          <h5 class="modal-title">Conversation with <span id="convoWith"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="roomId" hidden>
          <input type="email" id="receiverEmail" hidden>
          <div id="chatContainer" style="height: 350px; overflow-y: auto; border: 1px solid #ccc; border-radius: 5px; padding: 10px; background: #f9f9f9;"></div>
          <textarea id="new_message" rows="3" class="form-control mt-2" placeholder="Type a message..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="send_new_message_btn" class="btn btn-primary"
                  data-send-new-message-url="main_app:send-new-message">
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  const currentUserId = "{{ request.user.id }}";
  let email = null;

  function resetInitMessageForm() {
    $("#recipient").val("");
    $("#initMessage").val("");
  }

  function loadMessages() {
    const messagesBody = $("#messagesTable tbody");
    $.ajax({
      url: "/ajax/load-messages",
      method: "GET",
      success: function (data) {
        messagesBody.empty();
        let seen = new Set();
        $.each(data.result, function (index, room) {
          const other = (currentUserId == room.receiver.id) ? room.initiator : room.receiver;
          const otherKey = `${other.id}-${room.id}`;
          if (seen.has(otherKey)) return;
          seen.add(otherKey);
          let row = `<tr class="messagesItem"
                        data-room-id=${room.id}
                        data-receiver-email=${other.email}
                        data-receiver-fname=${other.first_name}
                        data-receiver-lname=${other.last_name}>
                        <td>${other.first_name} ${other.last_name}</td>
                    </tr>`;
          if (room.chats.some(chat => chat.status === "sent" && chat.sender != currentUserId)) {
            row = $(row).addClass("text-primary");
          }
          messagesBody.append(row);
        });
      }
    });
  }

  function loadConversation(roomId) {
    const chatContainer = $("#chatContainer");
    $.ajax({ url: `/ajax/load-conversation/${roomId}`, method: "GET", success: function(data) {
      chatContainer.empty();
      $.each(data.result, function(index, msg) {
        if (currentUserId == msg.sender__id) {
          chatContainer.append(`<div class="message sender" style="background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;">`+
                               `<span style="font-size: small;">You</span><br>${msg.message}</div>`);
        } else if (currentUserId == msg.recipient__id) {
          chatContainer.append(`<div class="message receiver" style="background:#E5E5EA; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-end;">`+
                               `<span style="font-size: small;">${msg.sender__first_name}</span><br>${msg.message}</div>`);
        }
      });
      chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
    }});
  }

  $(document).ready(function () {
    loadMessages();

    // Open init chat modal from Users table
    $(document).on('click', '.start-chat-btn', function () {
      const recipientEmail = $(this).data('recipient-email');
      $("#recipient").val(recipientEmail).prop("disabled", true);
      $("#initMessageModal").modal("show");
    });

    // Send initial message
    $("#send_init_message").click(function () {
      let recipient = $("#recipient").val();
      let initMessage = $("#initMessage").val();
      if (!initMessage) { alert("Message cannot be empty."); return; }
      $.ajax({
        url: $(this).data("send-init-message-url"),
        type: "POST",
        data: { recipient: recipient, message: initMessage },
        success: function () {
          $("#initMessageModal").modal("hide");
          resetInitMessageForm();
          loadMessages();
        },
        error: function (xhr) { alert("Error: " + xhr.responseText); }
      });
    });

    // Open conversation modal from list
    $(document).on("click", ".messagesItem", function () {
      var roomId = $(this).data('room-id');
      var receiverEmail = $(this).data('receiver-email');
      var receiverFirstname = $(this).data("receiver-fname");
      var receiverLastname = $(this).data("receiver-lname");
      $("#receiverEmail").val(receiverEmail);
      $("#roomId").val(roomId);
      $("#convoWith").text(receiverFirstname + ' ' + receiverLastname);
      $("#conversationModal").modal("show");
      loadConversation(roomId);
    });

    // Send new message
    $("#send_new_message_btn").click(function () {
      let newMessage = $("#new_message").val();
      let roomId = $("#roomId").val();
      if (!newMessage) return;
      let completeUrl = `/ajax/send-new-message/${roomId}/`;
      $.ajax({ url: completeUrl, type: "POST", data: { message: newMessage }, success: function () {
        const chatContainer = $("#chatContainer");
        chatContainer.append(`<div class=\"message sender\" style=\"background:#DCF8C6; border-radius:12px; padding:8px 12px; margin:5px 0; max-width:70%; align-self:flex-start;\">`+
                             `<span style=\"font-size: small;\">You</span><br>${newMessage}</div>`);
        chatContainer.scrollTop(chatContainer.prop("scrollHeight"));
        $("#new_message").val("");
        loadMessages();
      }, error: function (xhr) { alert("Error: " + xhr.responseText); }});
    });
  });
</script>
{% endblock %}
