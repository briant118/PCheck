{% extends 'base.html' %}
{% load static %}

{% block title %}PC List{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/booking.css' %}?v=12">
{% endblock %}

{% block content %}
<div class="container-fluid">

  <div class="row">

    <!-- PC List Column -->
    <div class="col-12 mt-3">
      <div class="card modern-pc-card">
        <div class="card-header modern-card-header">
          <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
            <div class="d-flex justify-content-start align-items-center gap-3 flex-wrap">
              <a href="{% url 'main_app:pc-list' %}" 
                id="all-pc-button" class="btn modern-btn modern-btn-secondary">
                <i class="fa-solid fa-list"></i>
                <span>All PC</span>
              </a>
              <a href="{% url 'main_app:pc-list' %}?filter=repair" 
                id="repair-button" class="btn modern-btn modern-btn-secondary">
                <i class="fa-solid fa-wrench"></i>
                <span>Repair</span>
              </a>
              <button id="addPCbutton" class="btn modern-add-btn" onclick="showAddPcModal(); return false;">
                <span>Add PC</span>
                <i class="fa-solid fa-plus"></i>
              </button>
            </div>
            <div class="analytics-card">
              <div class="analytics-card-icon">
                <i class="fa-solid fa-desktop"></i>
              </div>
              <div class="analytics-card-content">
                <div class="analytics-card-number">{{ total_pcs }}</div>
                <div class="analytics-card-label">Total PC</div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Available Computers</h5>
          <div>
            <button type="button" class="btn btn-sm btn-secondary" id="view-toggle-btn" onclick="toggleView()">
              <i class="fa-solid fa-table"></i> Table View
            </button>
          </div>
        </div>
        <div class="card-body">
          <!-- Button Grid View -->
          <div id="button-view" class="row justify-content-center text-center">
            {% for pc in pc_list %}
            <div class="col-3 col-md-2 col-sm-3 mb-3">
              <div class="pc-container position-relative">
                <button class="pc-list-button {% if pc.system_condition == 'repair' %}pc-repair{% else %}{% if pc.status == 'connected' %}text-success{% else %}text-danger{% endif %}{% endif %}" 
                  data-pc-id="{{ pc.pk }}" 
                  data-pc-name="{{ pc.name }}"
                  data-pc-ip="{{ pc.ip_address }}"
                  data-pc-status="{{ pc.status }}"
                  data-pc-health="{{ pc.system_condition }}">
                  <i class="fa-solid fa-desktop" style="font-size: 1.7em; display: inline-block;"></i><br>
                  <span class="pc-name">{{ pc.name }}</span>
                  <div class="pc-status-indicator mt-1">
                    {% if pc.system_condition == 'repair' %}
                      <span class="badge text-bg-danger">Repair</span>
                    {% else %}
                      {% if pc.status == 'connected' %}
                        <i class="fa-solid fa-circle text-success" style="font-size: 0.7em;"></i>
                      {% else %}
                        <i class="fa-solid fa-circle text-danger" style="font-size: 0.7em;"></i>
                      {% endif %}
                    {% endif %}
                  </div>
                </button>
                <a class="btn btn-sm text-danger delete-pc-btn position-absolute top-0 end-0" 
                  href="{% url 'main_app:delete-pc' pk=pc.pk %}" 
                  title="Delete PC" 
                  style="padding: 2px 5px; font-size: 0.7em; z-index: 10;"
                  onclick="event.stopPropagation(); return confirm('Are you sure you want to delete {{ pc.name }}?');">
                  <i class="fa-solid fa-trash"></i>
                </a>
              </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
              <p class="text-muted">No PCs found.</p>
            </div>
            {% endfor %}
          </div>

          <!-- Table View -->
          <div id="table-view" style="display: none;">
            <table class="table table-striped table-hover table-sm">
              <thead class="thead-dark">
                <tr>
                  <th>PCs</th>
                  <th>IP Address</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for pc in pc_list %}
                <tr class="edit-row" data-pc-id="{{ pc.pk }}" data-name="{{ pc.name }}" 
                  data-ip="{{ pc.ip_address }}" data-status="{{ pc.status }}" data-health="{{ pc.system_condition }}">
                  <td>{{ pc.name }}</td>
                  <td>{{ pc.ip_address }}</td>
                  <td>
                    {% if pc.status == 'connected' %}
                      <i class="fa-solid fa-circle text-success"></i>
                    {% else %}
                      <i class="fa-solid fa-circle text-danger"></i>
                    {% endif %}
                  </td>
                  <td>
                    <a class="btn text-danger delete-pc-link" href="{% url 'main_app:delete-pc' pk=pc.pk %}" title="delete PC" onclick="event.stopPropagation();">
                      <i class="fa-solid fa-trash"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- PC Information Modal -->
<div class="modal fade" id="pcInfoModal" tabindex="-1" aria-labelledby="pcInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pcInfoModalLabel">
          <i class="fa-solid fa-desktop"></i> PC Information
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <tbody>
            <tr>
              <td class="bg-light fw-bold" style="width: 40%;">PC Name:</td>
              <td id="modal-pc-name">-</td>
            </tr>
            <tr>
              <td class="bg-light fw-bold">IP Address:</td>
              <td id="modal-pc-ip">-</td>
            </tr>
            <tr>
              <td class="bg-light fw-bold">Status:</td>
              <td id="modal-pc-status">
                <span id="modal-status-badge" class="badge">-</span>
              </td>
            </tr>
            <tr>
              <td class="bg-light fw-bold">System Condition:</td>
              <td id="modal-pc-health">
                <span id="modal-health-badge" class="badge">-</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="modal-edit-btn">Edit PC</button>
      </div>
    </div>
  </div>
</div>

<!-- Add PC Modal -->
<div class="modal fade" id="addPcModal" tabindex="-1" aria-labelledby="addPcModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPcModalLabel">
          <i class="fa-solid fa-plus"></i> Add PC
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="add-pc-form" action="">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="pc_id" id="add-pc_id" value="">
          <div class="form-group mt-3">
            <label for="add-id_name">Name:</label>
            <input type="text" name="name" id="add-id_name" class="form-control" required>
            <span class="text-danger" id="add-name-error"></span>
          </div>
          <div class="form-group mt-3">
            <label for="add-id_ip_address">IP Address:</label>
            <input type="text" name="ip_address" id="add-id_ip_address" class="form-control" required>
            <span class="text-danger" id="add-ip-address-error"></span>
          </div>
          <div class="form-group mt-3" style="display: none;">
            <label for="add-id_status">Status:</label>
            <select name="status" id="add-id_status" class="form-control select">
              <option value="connected">Connected</option>
              <option value="disconnected">Disconnected</option>
            </select>
          </div>
          <div class="form-group mt-3">
            <label for="add-id_system_condition">System Condition:</label>
            <select name="system_condition" id="add-id_system_condition" class="form-control select" required>
              <option value="active" selected>Active</option>
              <option value="repair">Repair</option>
            </select>
          </div>
          <div class="mt-3">
            <p class="mt-1">Network Status: <span id="add-status_indicator"></span></p>
            <div id="add-spinner" style="display: none; text-align:center; margin-top:20px;">
              <div class="loader"></div>
              <p>Connecting...</p>
            </div>
          </div>
          <div class="mt-3">
            <button type="button" id="add-connectButton" class="btn btn-sm btn-secondary w-100 mb-2">Test Connection</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="add-save-button">Add PC</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit PC Modal -->
<div class="modal fade" id="editPcModal" tabindex="-1" aria-labelledby="editPcModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPcModalLabel">
          <i class="fa-solid fa-edit"></i> Edit PC
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="edit-pc-form" action="">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="pc_id" id="edit-pc_id">
          <div class="form-group mt-3">
            <label for="edit-id_name">Name:</label>
            <input type="text" name="name" id="edit-id_name" class="form-control" required>
            <span class="text-danger" id="edit-name-error"></span>
          </div>
          <div class="form-group mt-3">
            <label for="edit-id_ip_address">IP Address:</label>
            <input type="text" name="ip_address" id="edit-id_ip_address" class="form-control" required>
            <span class="text-danger" id="edit-ip-address-error"></span>
          </div>
          <div class="form-group mt-3" style="display: none;">
            <label for="edit-id_status">Status:</label>
            <select name="status" id="edit-id_status" class="form-control select">
              <option value="connected">Connected</option>
              <option value="disconnected">Disconnected</option>
            </select>
          </div>
          <div class="form-group mt-3">
            <label for="edit-id_system_condition">System Condition:</label>
            <select name="system_condition" id="edit-id_system_condition" class="form-control select" required>
              <option value="active">Active</option>
              <option value="repair">Repair</option>
            </select>
          </div>
          <div class="mt-3">
            <p class="mt-1">Network Status: <span id="edit-status_indicator"></span></p>
            <div id="edit-spinner" style="display: none; text-align:center; margin-top:20px;">
              <div class="loader"></div>
              <p>Connecting...</p>
            </div>
          </div>
          <div class="mt-3">
            <button type="button" id="edit-connectButton" class="btn btn-sm btn-secondary w-100 mb-2">Test Connection</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="edit-save-button">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Function to show PC info modal (vanilla JS version)
function showPCInfoModalVanilla(id, name, ip, status, health) {
  console.log("Showing PC Info Modal (Vanilla JS):", { id, name, ip, status, health });
  
  // Set modal content
  var modalName = document.getElementById('modal-pc-name');
  var modalIP = document.getElementById('modal-pc-ip');
  var statusBadge = document.getElementById('modal-status-badge');
  var healthBadge = document.getElementById('modal-health-badge');
  
  if (modalName) modalName.textContent = name || "-";
  if (modalIP) modalIP.textContent = ip || "-";
  
  // Set status badge
  if (statusBadge) {
    statusBadge.className = 'badge';
    if (status === "connected") {
      statusBadge.textContent = "Connected";
      statusBadge.classList.add("bg-success");
    } else {
      statusBadge.textContent = "Disconnected";
      statusBadge.classList.add("bg-danger");
    }
  }
  
  // Set health badge
  if (healthBadge) {
    healthBadge.className = 'badge';
    if (health === "active") {
      healthBadge.textContent = "Active";
      healthBadge.classList.add("bg-success");
    } else if (health === "repair") {
      healthBadge.textContent = "Repair";
      healthBadge.classList.add("bg-warning");
    } else {
      healthBadge.textContent = health || "-";
    }
  }
  
  // Set edit button handler
  var editBtn = document.getElementById('modal-edit-btn');
  if (editBtn) {
    editBtn.onclick = function() {
      // Close info modal
      var modalElement = document.getElementById("pcInfoModal");
      if (window.bootstrap && modalElement) {
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
      }
      // Show edit modal
      showEditPcModalVanilla(id, name, ip, status, health);
    };
  }
  
  // Show modal using Bootstrap 5
  var modalElement = document.getElementById("pcInfoModal");
  if (modalElement && window.bootstrap) {
    var existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
      existingModal.show();
    } else {
      var modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
      modal.show();
    }
  }
}

// Function to show Add PC modal (vanilla JS version)
function showAddPcModal() {
  // Clear form fields
  var pcIdField = document.getElementById('add-pc_id');
  var nameField = document.getElementById('add-id_name');
  var ipField = document.getElementById('add-id_ip_address');
  var statusField = document.getElementById('add-id_status');
  var healthField = document.getElementById('add-id_system_condition');
  var statusIndicator = document.getElementById('add-status_indicator');
  
  if (pcIdField) pcIdField.value = "";
  if (nameField) nameField.value = "";
  if (ipField) ipField.value = "";
  if (statusField) statusField.value = "connected";
  if (healthField) healthField.value = "active";
  if (statusIndicator) statusIndicator.textContent = "";
  
  // Clear error messages
  var nameError = document.getElementById('add-name-error');
  var ipError = document.getElementById('add-ip-address-error');
  if (nameError) nameError.textContent = "";
  if (ipError) ipError.textContent = "";
  
  // Show modal using Bootstrap 5
  var modalElement = document.getElementById("addPcModal");
  if (modalElement && window.bootstrap) {
    var existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
      existingModal.show();
    } else {
      var modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
      modal.show();
    }
  }
}

// Function to show Edit PC modal (vanilla JS version)
function showEditPcModalVanilla(id, name, ip, status, health) {
  // Fill edit modal form fields
  var pcIdField = document.getElementById('edit-pc_id');
  var nameField = document.getElementById('edit-id_name');
  var ipField = document.getElementById('edit-id_ip_address');
  var statusField = document.getElementById('edit-id_status');
  var healthField = document.getElementById('edit-id_system_condition');
  var statusIndicator = document.getElementById('edit-status_indicator');
  
  if (pcIdField) pcIdField.value = id || "";
  if (nameField) nameField.value = name || "";
  if (ipField) ipField.value = ip || "";
  if (statusField) statusField.value = status || "connected";
  if (healthField) healthField.value = health || "active";
  if (statusIndicator) statusIndicator.textContent = "";
  
  // Clear error messages
  var nameError = document.getElementById('edit-name-error');
  var ipError = document.getElementById('edit-ip-address-error');
  if (nameError) nameError.textContent = "";
  if (ipError) ipError.textContent = "";
  
  // Show modal using Bootstrap 5
  var modalElement = document.getElementById("editPcModal");
  if (modalElement && window.bootstrap) {
    var existingModal = bootstrap.Modal.getInstance(modalElement);
    if (existingModal) {
      existingModal.show();
    } else {
      var modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
      modal.show();
    }
  }
}

// Function to fill PC form (vanilla JS version) - kept for backward compatibility
function fillPCFormVanilla(id, name, ip, status, health) {
  // Instead of showing side panel, show edit modal
  showEditPcModalVanilla(id, name, ip, status, health);
}

// Emergency fallback if jQuery doesn't work
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM loaded without jQuery");
  var addButton = document.getElementById('addPCbutton');
  if (addButton) {
    console.log("Add button found with vanilla JS");
    addButton.addEventListener('click', function() {
      console.log("Add PC clicked (vanilla JS)");
      var formDiv = document.getElementById('PCformDiv');
      if (formDiv) {
        formDiv.removeAttribute('hidden');
      }
    });
  } else {
    console.log("Add button NOT found");
  }
  
  // Add vanilla JS click handlers for PC buttons (button view)
  var pcButtons = document.querySelectorAll('.pc-list-button');
  console.log("Found", pcButtons.length, "PC buttons");
  pcButtons.forEach(function(button) {
    button.addEventListener('click', function(e) {
      // Don't trigger if clicking on delete button
      if (e.target.closest('.delete-pc-btn')) {
        console.log("Delete button clicked, ignoring button click");
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      var id = button.getAttribute('data-pc-id');
      var name = button.getAttribute('data-pc-name');
      var ip = button.getAttribute('data-pc-ip');
      var status = button.getAttribute('data-pc-status');
      var health = button.getAttribute('data-pc-health');
      
      console.log("PC list button clicked (vanilla JS):", id, name);
      
      // Show edit modal
      showEditPcModalVanilla(id, name, ip, status, health);
      
      // Highlight selected button
      pcButtons.forEach(function(btn) {
        btn.classList.remove('selected-pc');
      });
      button.classList.add('selected-pc');
    });
  });
  
  // Add vanilla JS click handlers for table rows
  var tableRows = document.querySelectorAll('.edit-row');
  console.log("Found", tableRows.length, "table rows");
  tableRows.forEach(function(row) {
    row.addEventListener('click', function(e) {
      // Don't trigger if clicking on delete button
      if (e.target.closest('.delete-pc-link')) {
        console.log("Delete link clicked, ignoring row click");
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      var id = row.getAttribute('data-pc-id');
      var name = row.getAttribute('data-name');
      var ip = row.getAttribute('data-ip');
      var status = row.getAttribute('data-status');
      var health = row.getAttribute('data-health');
      
      console.log("Edit row clicked (vanilla JS):", id, name);
      
      // Show edit modal
      showEditPcModalVanilla(id, name, ip, status, health);
    });
  });
});

// Function to attach click handlers (call this after toggle)
function attachClickHandlers() {
  // Add vanilla JS click handlers for table rows (in case they're now visible)
  var tableRows = document.querySelectorAll('.edit-row');
  tableRows.forEach(function(row) {
    // Check if handler already attached
    if (row.hasAttribute('data-handler-attached')) {
      return;
    }
    row.setAttribute('data-handler-attached', 'true');
    
    row.addEventListener('click', function(e) {
      // Don't trigger if clicking on delete button
      if (e.target.closest('.delete-pc-link')) {
        console.log("Delete link clicked, ignoring row click");
        return;
      }
      
      e.preventDefault();
      e.stopPropagation();
      
      var id = row.getAttribute('data-pc-id');
      var name = row.getAttribute('data-name');
      var ip = row.getAttribute('data-ip');
      var status = row.getAttribute('data-status');
      var health = row.getAttribute('data-health');
      
      console.log("Edit row clicked (vanilla JS):", id, name);
      
      // Show edit modal
      showEditPcModalVanilla(id, name, ip, status, health);
    });
  });
}

// Toggle between button view and table view
function toggleView() {
  var buttonView = document.getElementById('button-view');
  var tableView = document.getElementById('table-view');
  var toggleBtn = document.getElementById('view-toggle-btn');
  
  if (buttonView.style.display === 'none') {
    buttonView.style.display = 'block';
    tableView.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fa-solid fa-table"></i> Table View';
  } else {
    buttonView.style.display = 'none';
    tableView.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fa-solid fa-th"></i> Button View';
    // Reattach handlers when table view is shown
    setTimeout(attachClickHandlers, 100);
  }
}

// Handle PC button click - Fallback function (jQuery handler is in pc_management.js)
function selectPCFromButton(button) {
  var pcId = button.getAttribute('data-pc-id');
  var name = button.getAttribute('data-pc-name');
  var ip = button.getAttribute('data-pc-ip');
  var status = button.getAttribute('data-pc-status');
  var health = button.getAttribute('data-pc-health');
  
  console.log('PC button clicked (vanilla JS):', pcId, name);
  
  // Fill the form fields
  var formDiv = document.getElementById('PCformDiv');
  var statusIndicator = document.getElementById('status_indicator');
  
  if (formDiv) formDiv.removeAttribute('hidden');
  if (statusIndicator) statusIndicator.textContent = '';
  
  var pcIdField = document.getElementById('pc_id');
  var nameField = document.getElementById('id_name');
  var ipField = document.getElementById('id_ip_address');
  var statusField = document.getElementById('id_status');
  var healthField = document.getElementById('id_system_condition');
  
  if (pcIdField) pcIdField.value = pcId || '';
  if (nameField) nameField.value = name || '';
  if (ipField) ipField.value = ip || '';
  if (statusField) statusField.value = status || 'connected';
  if (healthField) healthField.value = health || 'active';
  
  // Change title & button
  var formTitle = document.getElementById('form-title');
  if (formTitle) formTitle.textContent = 'Edit PC';
  
  var cancelButton = document.getElementById('cancel-button');
  if (cancelButton) cancelButton.style.display = 'block';
  
  var addPCbutton = document.getElementById('addPCbutton');
  if (addPCbutton) {
    addPCbutton.className = 'btn btn-round btn-secondary shadow menu-button mb-2';
    addPCbutton.classList.remove('bg-warning');
  }
  
  // Highlight selected button
  var allButtons = document.querySelectorAll('.pc-list-button');
  allButtons.forEach(function(btn) {
    btn.classList.remove('selected-pc');
  });
  button.classList.add('selected-pc');
}

// Add PC modal handlers
document.addEventListener('DOMContentLoaded', function() {
  // Test connection button in add modal
  var addConnectButton = document.getElementById('add-connectButton');
  if (addConnectButton) {
    addConnectButton.addEventListener('click', function(e) {
      e.preventDefault();
      var ipAddress = document.getElementById('add-id_ip_address').value;
      var statusIndicator = document.getElementById('add-status_indicator');
      var spinner = document.getElementById('add-spinner');
      var statusField = document.getElementById('add-id_status');
      
      if (spinner) spinner.style.display = 'block';
      
      if (ipAddress) {
        fetch('/ajax/get-ping-data/?ip_address=' + ipAddress)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (spinner) spinner.style.display = 'none';
            if (data.result) {
              if (statusIndicator) {
                statusIndicator.textContent = 'Reachable';
                statusIndicator.className = 'text-success';
              }
              if (statusField) statusField.value = 'connected';
            } else {
              if (statusIndicator) {
                statusIndicator.textContent = 'Unreachable';
                statusIndicator.className = 'text-danger';
              }
              if (statusField) statusField.value = 'disconnected';
            }
          })
          .catch(function(error) {
            console.error('Error fetching ping data:', error);
            if (spinner) spinner.style.display = 'none';
          });
      } else {
        alert('Please enter an IP address.');
        if (spinner) spinner.style.display = 'none';
      }
    });
  }
  
  // Add form submission
  var addForm = document.getElementById('add-pc-form');
  if (addForm) {
    addForm.addEventListener('submit', function(e) {
      var name = document.getElementById('add-id_name').value;
      var ipAddress = document.getElementById('add-id_ip_address').value;
      
      if (!name || name.trim() === '') {
        e.preventDefault();
        alert('Please enter a PC name');
        return false;
      }
      if (!ipAddress || ipAddress.trim() === '') {
        e.preventDefault();
        alert('Please enter an IP address');
        return false;
      }
      
      // Form will submit normally
      return true;
    });
  }
  
  // Name validation in add modal
  var addNameField = document.getElementById('add-id_name');
  if (addNameField) {
    addNameField.addEventListener('change', function() {
      var name = this.value;
      var nameError = document.getElementById('add-name-error');
      
      if (name) {
        fetch('/ajax/verify-pc-name/?name=' + encodeURIComponent(name))
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.result && nameError) {
              nameError.textContent = 'PC with this name already exists.';
            } else if (nameError) {
              nameError.textContent = '';
            }
          })
          .catch(function(error) {
            console.error('Error fetching name data:', error);
          });
      }
    });
  }
  
  // IP validation in add modal
  var addIpField = document.getElementById('add-id_ip_address');
  if (addIpField) {
    addIpField.addEventListener('change', function() {
      var ip = this.value;
      var ipError = document.getElementById('add-ip-address-error');
      
      if (ip) {
        fetch('/ajax/verify-pc-ip-address/?ip_address=' + encodeURIComponent(ip))
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.result && ipError) {
              ipError.textContent = 'PC with this IP address already exists.';
            } else if (ipError) {
              ipError.textContent = '';
            }
          })
          .catch(function(error) {
            console.error('Error fetching IP data:', error);
          });
      }
    });
  }
  
  // Edit modal handlers
  // Test connection button in edit modal
  var editConnectButton = document.getElementById('edit-connectButton');
  if (editConnectButton) {
    editConnectButton.addEventListener('click', function(e) {
      e.preventDefault();
      var ipAddress = document.getElementById('edit-id_ip_address').value;
      var statusIndicator = document.getElementById('edit-status_indicator');
      var spinner = document.getElementById('edit-spinner');
      var statusField = document.getElementById('edit-id_status');
      
      if (spinner) spinner.style.display = 'block';
      
      if (ipAddress) {
        fetch('/ajax/get-ping-data/?ip_address=' + ipAddress)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (spinner) spinner.style.display = 'none';
            if (data.result) {
              if (statusIndicator) {
                statusIndicator.textContent = 'Reachable';
                statusIndicator.className = 'text-success';
              }
              if (statusField) statusField.value = 'connected';
            } else {
              if (statusIndicator) {
                statusIndicator.textContent = 'Unreachable';
                statusIndicator.className = 'text-danger';
              }
              if (statusField) statusField.value = 'disconnected';
            }
          })
          .catch(function(error) {
            console.error('Error fetching ping data:', error);
            if (spinner) spinner.style.display = 'none';
          });
      } else {
        alert('Please enter an IP address.');
        if (spinner) spinner.style.display = 'none';
      }
    });
  }
  
  // Edit form submission
  var editForm = document.getElementById('edit-pc-form');
  if (editForm) {
    editForm.addEventListener('submit', function(e) {
      var name = document.getElementById('edit-id_name').value;
      var ipAddress = document.getElementById('edit-id_ip_address').value;
      
      if (!name || name.trim() === '') {
        e.preventDefault();
        alert('Please enter a PC name');
        return false;
      }
      if (!ipAddress || ipAddress.trim() === '') {
        e.preventDefault();
        alert('Please enter an IP address');
        return false;
      }
      
      // Form will submit normally
      return true;
    });
  }
  
  // Name validation in edit modal
  var editNameField = document.getElementById('edit-id_name');
  if (editNameField) {
    editNameField.addEventListener('change', function() {
      var name = this.value;
      var nameError = document.getElementById('edit-name-error');
      var pcId = document.getElementById('edit-pc_id').value;
      
      if (name) {
        fetch('/ajax/verify-pc-name/?name=' + encodeURIComponent(name) + '&exclude_id=' + pcId)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.result && nameError) {
              nameError.textContent = 'PC with this name already exists.';
            } else if (nameError) {
              nameError.textContent = '';
            }
          })
          .catch(function(error) {
            console.error('Error fetching name data:', error);
          });
      }
    });
  }
  
  // IP validation in edit modal
  var editIpField = document.getElementById('edit-id_ip_address');
  if (editIpField) {
    editIpField.addEventListener('change', function() {
      var ip = this.value;
      var ipError = document.getElementById('edit-ip-address-error');
      var pcId = document.getElementById('edit-pc_id').value;
      
      if (ip) {
        fetch('/ajax/verify-pc-ip-address/?ip_address=' + encodeURIComponent(ip) + '&exclude_id=' + pcId)
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.result && ipError) {
              ipError.textContent = 'PC with this IP address already exists.';
            } else if (ipError) {
              ipError.textContent = '';
            }
          })
          .catch(function(error) {
            console.error('Error fetching IP data:', error);
          });
      }
    });
  }
});
</script>
<script src="{% static 'js/pc_management.js' %}"></script>
{% endblock %}